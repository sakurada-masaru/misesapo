# MISOGI 管理・清掃スケジュール 再設計マスター仕様（V1）

## 1. 目的

本仕様は、**MISOGI管理側の清掃スケジュール機能**を再設計する際の判断軸と実装スコープを固定する。

対象:
- 管理側の清掃スケジュール作成・割当・重複判定
- 管理側が把握する当日稼働状態（dispatch）

非対象（本仕様外）:
- 営業/事務/制作系の個別業務UI詳細
- 顧客ポータル向け表示最適化
- 全業務ドメインの同時刷新

解決対象:
- 連絡遅延
- 現場判断の過多
- 稼働状況の不透明
- `worker_id` / `user_id` / `cleaner_id` の揺れ
- `schedules` / `misesapo-schedules` / `blocks` / `worker-availability` の分裂

---

## 2. 方針（今回確定）

### 2.1 再設計スコープ
- 採用: **スケジュール領域のみ再設計（段階移行）**
- 非採用: 全システム同時刷新
- 非採用: 既存延命のみ

### 2.2 運用前提
- 現在スケジュールは本格運用前
- UI本体は `src/misogi`（v2）を優先
- まずは病院予約モデル（枠管理）を維持しつつ、稼働状態を追加
- 主語は「管理側清掃スケジュール」。現場画面はその実行反映先として扱う

### 2.3 重要ルール
- 予定の正: `schedules`（または将来 `time_events_v2`）
- 稼働状態の正: `dispatch`（新設）
- 最終重複判定の正: API/Lambda（409）
- ワーカー正規キー: `worker_id`（認証ID `sub` とは分離）

---

## 3. ドメイン構造（全体像）

### 3.1 需要側（顧客）
- `client`（顧客法人）
- `brand`
- `store`（実務起点）

### 3.2 供給側（実行）
- `vendor`（外注会社）
- `vendor_unit`
- `worker`

補足:
- 自社チームは vendor とは別枠（internal枠）で管理
- ただし作業者ID体系は `worker_id` に統一

### 3.3 サービス
- 清掃・メンテ・害虫駆除を主軸
- サービスはメニュー単位で管理し、所要時間を持つ（病院予約モデル）

---

## 4. 業務日・シフト定義（確定）

### 4.1 シフト呼称
- 朝勤: `04:00-16:00`
- 夜勤: `16:00-翌04:00`

### 4.2 営業日（biz_date）
- 16:00境界で業務日を切る
- `start_at < 16:00` -> 当日 `biz_date`
- `start_at >= 16:00` -> 翌日 `biz_date`

例:
- `2026-02-08 23:00` -> `biz_date=2026-02-09`
- `2026-02-09 10:00` -> `biz_date=2026-02-09`

---

## 5. V1（最短実装）仕様

### 5.1 画面（管理側中心）
- 管理側: 清掃スケジュール（病院予約モデル）を主画面として維持
- 管理側: 当日稼働状態を `dispatch` で把握できること
- MISOGI内に「今日の自分」を追加
- 対象: **自分に割当済み `schedules` のみ**
- 表示順: 時系列（`start_at` 昇順）
- 更新: 手動更新ボタン（自動ポーリングなし）

### 5.2 状態遷移
- `todo -> enroute -> working -> done`
- 一覧と詳細の両方に同一状態ボタンを配置
- 状態の正は `dispatch` の1本に集約

### 5.3 `dispatch` テーブル（新設）
- `id`: `SCHEDULE#{schedule_id}#{biz_date}`
- `schedule_id`
- `worker_id`
- `store_id`
- `category` (`CLEAN|MAINT|PEST`)
- `status` (`todo|enroute|working|done`)
- `updated_at`
- `meta` (JSON)

### 5.4 API（最小）
- `GET /dispatch/me/today`
- `PATCH /dispatch/{id}`
- 初回未作成は取得時生成またはPATCH時upsert

### 5.5 休み（blocks）
- V1では「今日の自分」に混在させない
- 休み設定は別機能で継続
- 将来、本人申告フローへ拡張

---

## 6. サービスマスタ方針（V1）

### 6.1 予約単位
- 採用: **サービスごとに所要時間を固定（A案）**

### 6.2 必須フィールド
- `service_id`
- `name`
- `category` (`CLEAN|MAINT|PEST`)
- `default_duration_min`
- `active`

### 6.3 主軸カテゴリ（現時点）
- 清掃
- メンテナンス
- 害虫駆除

---

## 7. 段階ロードマップ

### Phase 1（今回）
- `dispatch` 導入
- 「今日の自分」導入
- 手動更新 + 4状態遷移

### Phase 2
- 管理用稼働盤（全体表示）
- 連絡遅延検知・アラート
- 休み本人申告

### Phase 3
- AI補助（遅延予測、次アクション提案）
- 配車支援

---

## 8. LINEシステム原則との整合

- 現場入力はタップ主体（自由記述なし）
- 正規データは構造化フィールドのみ
- 例外時のみ短文メモを許容
- AIは当面、判断主体にしない（補助のみ）

---

## 9. 今回の意思決定まとめ

- スケジュール基盤は再設計する
- ただし全領域同時刷新は行わない
- まずは MISOGI 内で「病院予約 + 稼働状態」の2層を成立させる
- これを将来の `time_events_v2` / AI化の土台にする
