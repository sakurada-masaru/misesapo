# NFCタグ打刻システム - トリガー方式セットアップガイド

## 概要

NFCタグを「スイッチ」や「トリガー」として使用する方式です。タグには最小限のIDのみを書き込み、場所情報はサーバー側で管理します。

## 仕組み

1. **NFCタグにIDを書き込む**
   - 各NFCタグに固有のID（例: `TAG_001`）を書き込む
   - URL: `https://your-web-app.com/staff/nfc-clock-in?tag_id=TAG_001`

2. **iPhoneでNFCタグを読み取る**
   - iPhoneをNFCタグに近づけると、自動的にSafariでURLが開く
   - 追加アプリ不要

3. **サーバーから場所情報を取得**
   - タグIDを使ってサーバーから `facility_id` と `location_id` を取得
   - API: `GET /staff/nfc/tag?tag_id=TAG_001`

4. **自動的に打刻**
   - 取得した場所情報を使って打刻を実行

## メリット

### セキュリティ
- **タグに直接情報を書かない**: タグにはIDだけ
- **サーバー側で管理**: 場所情報はサーバー側で一元管理
- **変更が容易**: 場所情報を変更してもタグを書き換える必要がない

### 柔軟性
- **場所情報の変更が簡単**: DynamoDBのデータを更新するだけ
- **追加情報の管理**: 施設名、場所名、説明なども管理可能
- **タグの再利用**: 同じタグを別の場所で使える

### 管理の容易さ
- **タグは単なるID**: 管理が簡単
- **一元管理**: すべてのタグ情報をDynamoDBで管理

## セットアップ手順

### 1. DynamoDBテーブルの作成

**テーブル名**: `nfc-tags`

**テーブル設定:**
- パーティションキー: `tag_id` (String)

**データ構造:**
```json
{
  "tag_id": "TAG_001",
  "facility_id": "ABC_001",
  "location_id": "TK_R01_TOILET_IN",
  "facility_name": "新宿店",
  "location_name": "トイレ入口",
  "description": "1階トイレ入口",
  "created_at": "2025-01-15T10:00:00Z",
  "updated_at": "2025-01-15T10:00:00Z"
}
```

### 2. NFCタグの準備

各店舗の各場所にNFCタグを用意します。

### 3. タグIDの生成

各NFCタグに固有のIDを割り当てます。

**IDの形式:**
- 例: `TAG_001`, `TAG_002`, `TAG_ABC_001_TOILET_IN`
- 推奨: `{施設ID}_{場所ID}` 形式（例: `ABC_001_TK_R01_TOILET_IN`）

### 4. URLの生成

各NFCタグ用のURLを生成します（ダッシュボードまたはマイページを開く）：

**ダッシュボードを開く場合:**
```
https://your-web-app.com/staff/dashboard?nfc_tag_id=TAG_001
```

**マイページを開く場合:**
```
https://your-web-app.com/staff/mypage?nfc_tag_id=TAG_001
```

**注意**: 指定したページが開き、バックグラウンドで打刻処理が実行されます。成功/失敗はトースト通知で表示されます。

### 5. NFCタグにURLを書き込む

**使用アプリ:**
- NFC Tools（推奨）
- NFC Writer Tool

**手順:**
1. NFC Toolsアプリを開く
2. 「書き込み」タブを選択
3. 「URL」を選択
4. 生成したURLを入力
5. NFCタグにiPhoneを近づけて書き込み

### 6. DynamoDBにタグ情報を登録

各NFCタグの情報をDynamoDBに登録します。

**登録方法:**
- AWSコンソールから直接登録
- 管理画面から登録（将来的に実装）
- スクリプトで一括登録

**登録例:**
```json
{
  "tag_id": "TAG_001",
  "facility_id": "ABC_001",
  "location_id": "TK_R01_TOILET_IN",
  "facility_name": "新宿店",
  "location_name": "トイレ入口",
  "description": "1階トイレ入口"
}
```

## 使用方法

### 清掃員の操作

1. iPhoneでNFCタグに近づける
2. 自動的にSafariが開く
3. サーバーから場所情報を取得
4. 自動的に打刻が実行される
5. 成功メッセージが表示される

## タグ情報の管理

### タグ情報の一覧取得（将来的に実装）

```
GET /admin/nfc/tags
```

### タグ情報の登録（将来的に実装）

```
POST /admin/nfc/tags
{
  "tag_id": "TAG_001",
  "facility_id": "ABC_001",
  "location_id": "TK_R01_TOILET_IN",
  "facility_name": "新宿店",
  "location_name": "トイレ入口",
  "description": "1階トイレ入口"
}
```

### タグ情報の更新（将来的に実装）

```
PUT /admin/nfc/tags/TAG_001
{
  "facility_id": "ABC_002",
  "location_id": "TK_R02_TOILET_IN",
  ...
}
```

## セキュリティ考慮事項

### 推奨事項

1. **HTTPSを使用**: URLは必ずHTTPSを使用
2. **認証必須**: ログインしていない場合は打刻を拒否
3. **タグIDの難読化**: 必要に応じて、タグIDをランダムな文字列にする
4. **ログの記録**: 打刻ログを記録して監査可能にする

### 注意事項

- タグIDが推測されやすい場合は、ランダムな文字列を使用
- タグ情報の変更履歴を記録（将来的に実装）

## コスト

- **NFCタグ**: 1枚あたり50円〜200円程度
- **NFC書き込みアプリ**: 無料〜数百円
- **DynamoDB**: 使用量に応じて（1タグあたり数円/月程度）
- **開発コスト**: 既存Webアプリの拡張のみ（ほぼゼロ）

## まとめ

この方式により、以下のメリットが得られます：

1. ✅ **セキュリティ**: タグに直接情報を書かない
2. ✅ **柔軟性**: 場所情報の変更が容易
3. ✅ **管理の容易さ**: 一元管理
4. ✅ **ネイティブアプリ不要**: Webアプリで完結
5. ✅ **低コスト**: NFCタグとDynamoDBのみ

