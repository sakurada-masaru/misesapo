# AWS S3 パブリックアクセス設定

画像が見つからないエラーが発生する場合、S3バケットのパブリックアクセス設定を確認してください。

## 問題の症状

- 画像アップロードは成功する
- アップロード後の画像URLが表示される
- しかし、画像が表示されず「画像が見つかりません」と表示される

## 原因

S3バケットのパブリックアクセスがブロックされている可能性があります。

## 解決方法

### 1. S3バケットのパブリックアクセス設定を確認

1. **AWS Console** (https://console.aws.amazon.com/) にアクセス
2. 検索バーに「**S3**」と入力して選択
3. バケット名 `misesapo-cleaning-manual-images` をクリック
4. **「アクセス許可」** タブをクリック
5. **「ブロックパブリックアクセス設定」** を確認

### 2. パブリックアクセスを許可（推奨設定）

**注意**: セキュリティ上の理由から、可能な限り最小限のパブリックアクセスを許可してください。

1. **「ブロックパブリックアクセス設定を編集」** をクリック
2. 以下の設定を確認：
   - ✅ **新しいパブリックバケットポリシーをブロック**: **オフ**（チェックを外す）
   - ✅ **パブリックバケットポリシーを通じて付与されたパブリックアクセスとクロスアカウントアクセスをブロック**: **オフ**（チェックを外す）
   - ⚠️ **新しいパブリック ACL とアップロードされたオブジェクトのパブリック ACL をブロック**: **オン**（チェックを入れる）
   - ⚠️ **パブリック ACL を通じて付与されたパブリックアクセスとクロスアカウントアクセスをブロック**: **オン**（チェックを入れる）
3. **「変更を保存」** をクリック

### 3. バケットポリシーを設定

1. **「アクセス許可」** タブ → **「バケットポリシー」** をクリック
2. **「編集」** をクリック
3. 以下のポリシーを貼り付け（バケット名を実際のバケット名に置き換える）：

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::misesapo-cleaning-manual-images/*"
        }
    ]
}
```

4. **「変更を保存」** をクリック

### 4. オブジェクトのACL設定を確認

Lambda関数で既に `ACL='public-read'` が設定されていますが、バケットポリシーでACLがブロックされている場合は動作しません。

上記のバケットポリシーを設定することで、ACLなしでもパブリックアクセスが可能になります。

## 代替方法: バケットポリシーのみでパブリックアクセスを許可

ACLを使用せず、バケットポリシーのみでパブリックアクセスを許可する場合：

1. Lambda関数のコードから `ACL='public-read'` を削除
2. 上記のバケットポリシーを設定

これにより、よりセキュアな設定になります。

## 設定後の確認

### 1. アップロードした画像のURLを確認

ブラウザの開発者ツール（F12）のコンソールで、アップロード後の画像URLを確認：
```
https://misesapo-cleaning-manual-images.s3.ap-northeast-1.amazonaws.com/cleaning-manual-images/1234567890_image.jpg
```

### 2. 画像URLに直接アクセス

上記のURLをブラウザのアドレスバーに入力して、画像が表示されるか確認してください。

### 3. エラーメッセージを確認

- **403 Forbidden**: パブリックアクセスがブロックされている
- **404 Not Found**: 画像がアップロードされていない、またはURLが間違っている

## セキュリティ上の注意

- パブリックアクセスを許可する場合は、バケットポリシーで適切に制限してください
- 必要に応じて、特定のIPアドレスやオリジンのみからアクセスできるように制限できます
- 定期的にバケットの内容を確認し、不要なファイルを削除してください

## 参考

- [AWS S3 パブリックアクセス設定](https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html)
- [AWS S3 バケットポリシー](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies.html)

