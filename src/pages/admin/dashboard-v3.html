@layout('layouts.base')
@json('data/meta/admin_dashboard_title.json', $title)
@json('data/meta/admin_dashboard_body_class.json', $body_class)

<main id="main" class="admin-dashboard-v3">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="dash-header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">
          <span class="logo-icon">ğŸ§¹</span>
          <span class="logo-text">ãƒŸã‚»ã‚µãƒ</span>
        </div>
      </div>
      <div class="header-center">
        <nav class="header-tabs">
          <button class="tab-btn active" data-tab="overview">
            <i class="fas fa-home"></i> æ¦‚è¦
          </button>
          <button class="tab-btn" data-tab="schedules">
            <i class="fas fa-calendar"></i> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          </button>
          <button class="tab-btn" data-tab="customers">
            <i class="fas fa-store"></i> é¡§å®¢
          </button>
          <button class="tab-btn" data-tab="reports">
            <i class="fas fa-file-alt"></i> ãƒ¬ãƒãƒ¼ãƒˆ
          </button>
        </nav>
      </div>
      <div class="header-right">
        <span class="header-date" id="header-date"></span>
        <button class="header-btn" id="open-notice-modal">
          <i class="fas fa-bell"></i>
        </button>
        <div class="user-badge">
          <span class="user-avatar">ç®¡</span>
        </div>
      </div>
    </div>
  </header>

  <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="tab-contents">
    <!-- æ¦‚è¦ã‚¿ãƒ– -->
    <div class="tab-content active" id="tab-overview">
      <!-- çµ±è¨ˆãƒãƒ¼ -->
      <section class="stats-bar">
        <div class="stat-item">
          <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="stat-today">-</span>
            <span class="stat-label">ä»Šæ—¥ã®æ¸…æƒ</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon"><i class="fas fa-store"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="stat-customers">-</span>
            <span class="stat-label">ç·é¡§å®¢æ•°</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="stat-workers">-</span>
            <span class="stat-label">æ¸…æƒå“¡</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="stat-month">-</span>
            <span class="stat-label">ä»Šæœˆã®æ¸…æƒ</span>
          </div>
        </div>
      </section>

      <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
      <section class="alerts-section" id="alerts-section"></section>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <section class="main-content">
        <div class="content-grid">
          <!-- å·¦: ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
          <div class="content-card schedule-card">
            <div class="card-header">
              <h3>ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
              <a href="/admin/schedules/" class="card-action">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
            </div>
            <div class="card-body" id="today-schedules">
              <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
          </div>

          <!-- ä¸­å¤®: ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="content-card quick-card">
            <div class="card-header">
              <h3>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            </div>
            <div class="quick-grid">
              <a href="/admin/schedules/" class="quick-item">
                <div class="quick-icon blue"><i class="fas fa-calendar-plus"></i></div>
                <span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
              </a>
              <a href="/admin/customers/" class="quick-item">
                <div class="quick-icon pink"><i class="fas fa-store"></i></div>
                <span>é¡§å®¢ç®¡ç†</span>
              </a>
              <a href="/admin/reports/" class="quick-item">
                <div class="quick-icon green"><i class="fas fa-file-alt"></i></div>
                <span>ãƒ¬ãƒãƒ¼ãƒˆ</span>
              </a>
              <a href="/admin/estimates/" class="quick-item">
                <div class="quick-icon orange"><i class="fas fa-file-invoice-dollar"></i></div>
                <span>è¦‹ç©ã‚‚ã‚Š</span>
              </a>
              <a href="/admin/users/" class="quick-item">
                <div class="quick-icon purple"><i class="fas fa-users-cog"></i></div>
                <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
              </a>
              <a href="/admin/analytics/" class="quick-item">
                <div class="quick-icon teal"><i class="fas fa-chart-bar"></i></div>
                <span>åˆ†æ</span>
              </a>
              <a href="/admin/cleaning-manual.html" class="quick-item">
                <div class="quick-icon gray"><i class="fas fa-book"></i></div>
                <span>ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>
              </a>
              <a href="/admin/images/" class="quick-item">
                <div class="quick-icon indigo"><i class="fas fa-images"></i></div>
                <span>ç”»åƒç®¡ç†</span>
              </a>
              <a href="/admin/services/" class="quick-item">
                <div class="quick-icon slate"><i class="fas fa-cog"></i></div>
                <span>è¨­å®š</span>
              </a>
            </div>
          </div>

          <!-- å³: ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ -->
          <div class="content-card activity-card">
            <div class="card-header">
              <h3>æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h3>
            </div>
            <div class="card-body" id="recent-activity">
              <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
    <div class="tab-content" id="tab-schedules">
      <div class="tab-placeholder">
        <i class="fas fa-calendar-alt"></i>
        <h2>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h2>
        <p>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç¢ºèªãƒ»ä½œæˆãƒ»ç·¨é›†</p>
        <a href="/admin/schedules/" class="btn-primary">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚’é–‹ã</a>
      </div>
    </div>

    <!-- é¡§å®¢ã‚¿ãƒ– -->
    <div class="tab-content" id="tab-customers">
      <div class="tab-placeholder">
        <i class="fas fa-store"></i>
        <h2>é¡§å®¢ç®¡ç†</h2>
        <p>é¡§å®¢æƒ…å ±ã®ç¢ºèªãƒ»è¿½åŠ ãƒ»ç·¨é›†</p>
        <a href="/admin/customers/" class="btn-primary">é¡§å®¢ç®¡ç†ã‚’é–‹ã</a>
      </div>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
    <div class="tab-content" id="tab-reports">
      <div class="tab-placeholder">
        <i class="fas fa-file-alt"></i>
        <h2>ãƒ¬ãƒãƒ¼ãƒˆç®¡ç†</h2>
        <p>æ¸…æƒãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèªãƒ»æ‰¿èª</p>
        <a href="/admin/reports/" class="btn-primary">ãƒ¬ãƒãƒ¼ãƒˆç®¡ç†ã‚’é–‹ã</a>
      </div>
    </div>
  </div>

  <!-- ãŠçŸ¥ã‚‰ã›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="notice-modal-backdrop">
    <div class="modal">
      <button class="modal-close" id="close-notice-modal"><i class="fas fa-times"></i></button>
      <h3>ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿</h3>
      <form id="notice-form">
        <div class="form-group">
          <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" name="title" required placeholder="ä¾‹ï¼šãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›">
        </div>
        <div class="form-group">
          <label>é…ä¿¡å¯¾è±¡</label>
          <select name="target">
            <option value="all">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
            <option value="customers">é¡§å®¢</option>
            <option value="staff">æ¸…æƒã‚¹ã‚¿ãƒƒãƒ•</option>
          </select>
        </div>
        <div class="form-group">
          <label>æœ¬æ–‡</label>
          <textarea name="body" required rows="4" placeholder="ãŠçŸ¥ã‚‰ã›ã®å†…å®¹"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" id="cancel-notice">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .admin-dashboard-v3 {
      min-height: 100vh;
      background: linear-gradient(180deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .dash-header {
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-icon {
      font-size: 1.5rem;
    }
    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, #f472b6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }
    .header-tabs {
      display: flex;
      gap: 4px;
      background: #f1f5f9;
      padding: 4px;
      border-radius: 12px;
    }
    .tab-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      color: #1e293b;
    }
    .tab-btn.active {
      background: #fff;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .header-date {
      font-size: 0.875rem;
      color: #64748b;
    }
    .header-btn {
      width: 40px;
      height: 40px;
      background: #f1f5f9;
      border: none;
      border-radius: 10px;
      color: #64748b;
      font-size: 1rem;
      cursor: pointer;
    }
    .header-btn:hover {
      background: #e2e8f0;
      color: var(--primary);
    }
    .user-badge {
      display: flex;
      align-items: center;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, #f472b6 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
    }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .tab-contents {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* çµ±è¨ˆãƒãƒ¼ */
    .stats-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-item {
      flex: 1;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stat-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, #f472b6 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.25rem;
    }
    .stat-info {
      display: flex;
      flex-direction: column;
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1e293b;
      line-height: 1;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 4px;
    }

    /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
    .alerts-section {
      margin-bottom: 24px;
    }
    .alert-banner {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .alert-banner-icon {
      width: 40px;
      height: 40px;
      background: #fbbf24;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    .alert-banner-content {
      flex: 1;
    }
    .alert-banner-title {
      font-weight: 600;
      color: #92400e;
    }
    .alert-banner-text {
      font-size: 0.85rem;
      color: #a16207;
    }
    .alert-banner-action {
      padding: 8px 16px;
      background: #92400e;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 24px;
    }
    .content-card {
      background: #fff;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
    }
    .card-action {
      font-size: 0.85rem;
      color: var(--primary);
      text-decoration: none;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }

    /* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    .quick-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .quick-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px 12px;
      background: #f8fafc;
      border-radius: 16px;
      text-decoration: none;
      transition: all 0.2s;
    }
    .quick-item:hover {
      background: #f1f5f9;
      transform: translateY(-2px);
    }
    .quick-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: #fff;
    }
    .quick-icon.blue { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
    .quick-icon.pink { background: linear-gradient(135deg, var(--primary) 0%, #f472b6 100%); }
    .quick-icon.green { background: linear-gradient(135deg, #22c55e 0%, #4ade80 100%); }
    .quick-icon.orange { background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); }
    .quick-icon.purple { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); }
    .quick-icon.teal { background: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%); }
    .quick-icon.gray { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); }
    .quick-icon.indigo { background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); }
    .quick-icon.slate { background: linear-gradient(135deg, #475569 0%, #64748b 100%); }
    .quick-item span {
      font-size: 0.8rem;
      font-weight: 500;
      color: #475569;
    }

    /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ */
    .schedule-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: #f8fafc;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .schedule-item:last-child {
      margin-bottom: 0;
    }
    .schedule-time {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--primary);
      width: 50px;
    }
    .schedule-info {
      flex: 1;
    }
    .schedule-store {
      font-weight: 500;
      color: #1e293b;
      font-size: 0.9rem;
    }
    .schedule-worker {
      font-size: 0.8rem;
      color: #64748b;
    }
    .schedule-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .schedule-status.draft { background: #fef3c7; color: #b45309; }
    .schedule-status.scheduled { background: #dbeafe; color: #1d4ed8; }
    .schedule-status.completed { background: #dcfce7; color: #16a34a; }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }

    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ */
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-top: 5px;
    }
    .activity-dot.green { background: #22c55e; }
    .activity-dot.blue { background: #3b82f6; }
    .activity-dot.orange { background: #f59e0b; }
    .activity-text {
      flex: 1;
    }
    .activity-title {
      font-weight: 500;
      color: #1e293b;
      font-size: 0.9rem;
    }
    .activity-meta {
      font-size: 0.8rem;
      color: #94a3b8;
    }

    /* ã‚¿ãƒ–ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .tab-placeholder {
      text-align: center;
      padding: 80px 20px;
      background: #fff;
      border-radius: 20px;
    }
    .tab-placeholder i {
      font-size: 4rem;
      color: var(--primary);
      opacity: 0.5;
      margin-bottom: 20px;
    }
    .tab-placeholder h2 {
      font-size: 1.5rem;
      color: #1e293b;
      margin: 0 0 8px;
    }
    .tab-placeholder p {
      color: #64748b;
      margin: 0 0 24px;
    }
    .btn-primary {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--primary) 0%, #f472b6 100%);
      color: #fff;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      background: #fff;
      border-radius: 20px;
      width: min(480px, 90vw);
      padding: 32px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #94a3b8;
      cursor: pointer;
    }
    .modal h3 {
      font-size: 1.25rem;
      color: #1e293b;
      margin: 0 0 24px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.95rem;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }
    .btn-cancel {
      padding: 12px 24px;
      background: #f1f5f9;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr 1fr;
      }
      .activity-card {
        grid-column: span 2;
      }
    }
    @media (max-width: 768px) {
      .header-tabs {
        display: none;
      }
      .stats-bar {
        flex-wrap: wrap;
      }
      .stat-item {
        flex: 1 1 calc(50% - 8px);
      }
      .content-grid {
        grid-template-columns: 1fr;
      }
      .activity-card {
        grid-column: span 1;
      }
      .quick-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</main>

<script>
(function() {
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  // æ—¥ä»˜è¡¨ç¤º
  const today = new Date();
  const dateStr = today.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'short' });
  document.getElementById('header-date').textContent = dateStr;

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadDashboard() {
    try {
      const [storesRes, schedulesRes, workersRes, reportsRes] = await Promise.all([
        fetch(`${API_BASE}/stores`),
        fetch(`${API_BASE}/schedules`),
        fetch(`${API_BASE}/workers`),
        fetch(`${API_BASE}/reports`)
      ]);

      const stores = await storesRes.json();
      const schedules = await schedulesRes.json();
      const workers = await workersRes.json();
      const reports = await reportsRes.json();

      // çµ±è¨ˆ
      document.getElementById('stat-customers').textContent = stores.length;
      document.getElementById('stat-workers').textContent = workers.length;

      const todayStr = today.toISOString().split('T')[0];
      const todaySchedules = schedules.filter(s => s.scheduled_date === todayStr);
      document.getElementById('stat-today').textContent = todaySchedules.length;

      const thisMonth = today.toISOString().slice(0, 7);
      const monthSchedules = schedules.filter(s => s.scheduled_date?.startsWith(thisMonth));
      document.getElementById('stat-month').textContent = monthSchedules.length;

      // ã‚¢ãƒ©ãƒ¼ãƒˆ
      renderAlerts(schedules);

      // ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      renderTodaySchedules(todaySchedules, stores, workers);

      // æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
      renderRecentActivity(schedules, stores, workers, reports);

    } catch (error) {
      console.error('Dashboard load error:', error);
    }
  }

  function renderAlerts(schedules) {
    const container = document.getElementById('alerts-section');
    const draftCount = schedules.filter(s => s.status === 'draft').length;
    
    if (draftCount === 0) {
      container.innerHTML = '';
      return;
    }

    container.innerHTML = `
      <div class="alert-banner">
        <div class="alert-banner-icon"><i class="fas fa-clock"></i></div>
        <div class="alert-banner-content">
          <div class="alert-banner-title">ä»®æŠ¼ã•ãˆç”³è«‹ ${draftCount}ä»¶</div>
          <div class="alert-banner-text">å–¶æ¥­ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä»®æŠ¼ã•ãˆç”³è«‹ãŒå±Šã„ã¦ã„ã¾ã™</div>
        </div>
        <a href="/admin/schedules/?status=draft" class="alert-banner-action">ç¢ºèªã™ã‚‹</a>
      </div>
    `;
  }

  function renderTodaySchedules(schedules, stores, workers) {
    const container = document.getElementById('today-schedules');
    
    if (schedules.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check" style="font-size:2rem;margin-bottom:12px;display:block;opacity:0.3;"></i>ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    schedules.sort((a, b) => (a.scheduled_time || '').localeCompare(b.scheduled_time || ''));

    container.innerHTML = schedules.slice(0, 5).map(s => {
      const store = stores.find(st => st.id === s.store_id) || {};
      const worker = workers.find(w => w.id === s.worker_id);
      const statusLabel = s.status === 'draft' ? 'ä»®æŠ¼ã•ãˆ' : (s.status === 'completed' ? 'å®Œäº†' : 'ç¢ºå®š');
      
      return `
        <div class="schedule-item">
          <div class="schedule-time">${s.scheduled_time || '-'}</div>
          <div class="schedule-info">
            <div class="schedule-store">${escapeHtml(store.name || 'ä¸æ˜')}</div>
            <div class="schedule-worker">${worker ? escapeHtml(worker.name) : 'æœªå‰²å½“'}</div>
          </div>
          <span class="schedule-status ${s.status || 'scheduled'}">${statusLabel}</span>
        </div>
      `;
    }).join('');
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function renderRecentActivity(schedules, stores, workers, reports) {
    const container = document.getElementById('recent-activity');
    const activities = [];

    schedules.forEach(s => {
      const store = stores.find(st => st.id === s.store_id) || {};
      const date = s.updated_at || s.created_at;
      if (date) {
        if (s.status === 'draft') {
          activities.push({ title: 'ä»®æŠ¼ã•ãˆç”³è«‹', meta: store.name || 'åº—èˆ—', date, color: 'orange' });
        } else if (s.status === 'scheduled') {
          activities.push({ title: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºå®š', meta: store.name || 'åº—èˆ—', date, color: 'blue' });
        } else if (s.status === 'completed') {
          activities.push({ title: 'æ¸…æƒå®Œäº†', meta: store.name || 'åº—èˆ—', date, color: 'green' });
        }
      }
    });

    activities.sort((a, b) => new Date(b.date) - new Date(a.date));
    const recent = activities.slice(0, 6);

    if (recent.length === 0) {
      container.innerHTML = '<div class="empty-state">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    container.innerHTML = recent.map(a => `
      <div class="activity-item">
        <div class="activity-dot ${a.color}"></div>
        <div class="activity-text">
          <div class="activity-title">${a.title}</div>
          <div class="activity-meta">${escapeHtml(a.meta)} Â· ${getTimeAgo(a.date)}</div>
        </div>
      </div>
    `).join('');
  }

  function getTimeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMin = Math.floor(diffMs / 60000);
    const diffHour = Math.floor(diffMs / 3600000);
    const diffDay = Math.floor(diffMs / 86400000);

    if (diffMin < 1) return 'ãŸã£ãŸä»Š';
    if (diffMin < 60) return `${diffMin}åˆ†å‰`;
    if (diffHour < 24) return `${diffHour}æ™‚é–“å‰`;
    if (diffDay < 7) return `${diffDay}æ—¥å‰`;
    return date.toLocaleDateString('ja-JP');
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«
  const modalBackdrop = document.getElementById('notice-modal-backdrop');
  document.getElementById('open-notice-modal').addEventListener('click', () => {
    modalBackdrop.classList.add('active');
  });
  document.getElementById('close-notice-modal').addEventListener('click', () => {
    modalBackdrop.classList.remove('active');
  });
  document.getElementById('cancel-notice').addEventListener('click', () => {
    modalBackdrop.classList.remove('active');
  });
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) modalBackdrop.classList.remove('active');
  });

  document.getElementById('notice-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    alert('ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
    modalBackdrop.classList.remove('active');
    e.target.reset();
  });

  loadDashboard();
})();
</script>
