@layout('layouts.admin')
@json('data/meta/admin_announcements_title.json', $title)
@json('data/meta/admin_announcements_body_class.json', $body_class)

<style>
  #default-header-wrapper,
  #normal-header-wrapper {
    display: none !important;
  }
</style>

<link rel="stylesheet" href="/css/admin-reports.css" />

<main id="main" class="admin-announcements">
  @include('partials.admin-sidebar')
  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- トップバー -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>業務連絡管理</h1>
      </div>
      <div class="topbar-right">
        <button type="button" class="btn btn-primary" id="btn-new-announcement">
          <i class="fas fa-plus"></i> 新規作成
        </button>
      </div>
    </header>

    <div class="content-wrapper">
      <!-- 統計カード -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">総件数</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-all">-</div>
          <div class="stat-label">全社員向け</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-individual">-</div>
          <div class="stat-label">個別送信</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-thisweek">-</div>
          <div class="stat-label">今週</div>
        </div>
      </div>

      <!-- フィルター -->
      <div class="filters-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="search-input" placeholder="タイトル・本文で検索...">
        </div>
        <select id="filter-type" class="filter-select">
          <option value="">すべて</option>
          <option value="all">全社員向け</option>
          <option value="individual">個別送信</option>
        </select>
        <button type="button" class="btn btn-outline" id="btn-reset-filters">リセット</button>
      </div>

      <!-- 業務連絡一覧 -->
      <div class="table-container">
        <table class="reports-table">
          <thead>
            <tr>
              <th>作成日</th>
              <th>タイトル</th>
              <th>送信先</th>
              <th>期限</th>
              <th>既読状況</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="announcements-tbody">
            <tr>
              <td colspan="6" class="loading-cell"><i class="fas fa-spinner fa-spin"></i> 読み込み中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 新規作成・編集モーダル -->
  <dialog id="announcement-dialog" class="modal-dialog modal-dialog-large">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="form-title">新規業務連絡作成</h3>
        <button type="button" class="modal-close" onclick="document.getElementById('announcement-dialog').close()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="announcement-form">
        <div class="modal-body modal-body-scrollable p-0">
          <input type="hidden" id="announcement-id" name="id">

          <div class="modal-section-grid">
            <!-- 左カラム：基本情報 & スケジュール -->
            <div class="modal-column">
              <div class="form-group-card">
                <label for="announcement-title" class="section-label">基本情報</label>
                <div class="form-field">
                  <label for="announcement-title">タイトル <span class="required">*</span></label>
                  <input type="text" id="announcement-title" name="title" required placeholder="例: 来週の清掃スケジュール変更について"
                    class="premium-input">
                </div>
                <div class="form-field">
                  <label for="announcement-content">本文 <span class="required">*</span></label>
                  <textarea id="announcement-content" name="content" rows="12" required placeholder="業務連絡の内容を入力してください"
                    class="premium-textarea"></textarea>
                </div>

                <div class="form-field">
                  <label for="announcement-image">画像添付</label>
                  <div class="image-upload-area">
                    <input type="file" id="announcement-image" accept="image/*" class="premium-input">
                    <div id="image-preview-container"
                      style="display:none; margin-top:10px; position:relative; width: fit-content; border: 1px solid #e5e7eb; border-radius: 8px; padding: 4px;">
                      <img id="image-preview" style="max-width:100%; max-height:200px; border-radius:4px;">
                      <button type="button" id="btn-clear-image"
                        style="position:absolute; top:-10px; right:-10px; background:#ef4444; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-times" style="font-size: 12px;"></i>
                      </button>
                    </div>
                    <input type="hidden" id="current-image-url" name="image_url">
                  </div>
                </div>
              </div>

              <div class="form-group-card mt-4">
                <label class="section-label">スケジュール設定</label>
                <div class="form-field">
                  <label class="premium-checkbox">
                    <input type="checkbox" id="has-deadline" name="has_deadline">
                    <span class="label-text">提出・確認期限を設定する</span>
                  </label>
                </div>

                <div class="form-field animate-fade" id="deadline-group" style="display: none;">
                  <label for="announcement-deadline">期限日時 <span class="required">*</span></label>
                  <div class="input-with-icon">
                    <i class="far fa-calendar-alt"></i>
                    <input type="datetime-local" id="announcement-deadline" name="deadline" class="premium-input pl-10">
                  </div>
                </div>
              </div>
            </div>

            <!-- 右カラム：設定 -->
            <div class="modal-column">
              <div class="form-group-card">
                <label class="section-label">送信設定</label>
                <div class="form-field">
                  <label>送信先範囲 <span class="required">*</span></label>
                  <div class="segmented-control">
                    <input type="radio" name="target_type" value="all" id="target-all" checked>
                    <label for="target-all">全社員</label>
                    <input type="radio" name="target_type" value="individual" id="target-individual">
                    <label for="target-individual">個別選択</label>
                  </div>
                </div>

                <div class="form-field" id="target-staff-group" style="display: none;">
                  <label for="target-staff-select">対象スタッフを選択 <span class="required">*</span></label>
                  <div class="staff-selector-container">
                    <select id="target-staff-select" name="target_staff_ids" multiple size="10"
                      class="premium-select-list">
                      <option value="">読み込み中...</option>
                    </select>
                    <p class="form-hint"><i class="fas fa-info-circle"></i> Mac: Cmd+クリック / Win: Ctrl+クリックで複数選択</p>
                  </div>
                </div>
              </div>

              <div class="form-group-card mt-4">
                <label class="section-label">通知設定</label>
                <div class="form-field">
                  <div class="notification-options">
                    <label class="premium-checkbox sound-option">
                      <input type="checkbox" name="notify_sound" id="notify-sound-toggle">
                      <span class="label-text">通知音を鳴らす (スマホ・PC対応)</span>
                    </label>
                    <p class="form-hint mt-2"><i class="fas fa-volume-up"></i> 通知受信時に端末で音が鳴ります</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-premium"
            onclick="document.getElementById('announcement-dialog').close()">キャンセル</button>
          <button type="submit" class="btn btn-primary-premium" id="btn-save-announcement">
            <i class="fas fa-paper-plane"></i> 業務連絡を発信
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- 詳細・既読状況モーダル -->
  <dialog id="detail-dialog" class="modal-dialog modal-dialog-large">
    <div class="modal-content">
      <div class="modal-header">
        <h3>業務連絡詳細</h3>
        <button type="button" class="modal-close" onclick="document.getElementById('detail-dialog').close()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body modal-body-scrollable">
        <div id="announcement-detail-content">
          <div class="loading">読み込み中...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline"
          onclick="document.getElementById('detail-dialog').close()">閉じる</button>
        <button type="button" class="btn btn-primary" id="btn-edit-announcement">編集</button>
        <button type="button" class="btn btn-danger" id="btn-delete-announcement">削除</button>
      </div>
    </div>
  </dialog>
</main>

<style>
  /* プレミアムモーダルスタイル (美装化) */
  .modal-dialog-large {
    width: 900px;
    max-width: 95vw;
    border-radius: 20px;
    background: #fdfdfd;
    border: none;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .modal-header {
    background: #fff;
    padding: 24px 32px;
    border-bottom: 1px solid #f1f5f9;
  }

  .modal-header h3 {
    color: var(--primary) !important;
    /* ピンクリテラルに合わせる場合は #FF6BA6 */
    font-size: 1.5rem;
    font-weight: 800;
  }

  .modal-section-grid {
    display: grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 32px;
    /* パディングを有効活用 */
    padding: 32px;
  }

  .form-group-card {
    background: #fff;
    border: 1px solid #f1f5f9;
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
  }

  .section-label {
    display: block;
    font-size: 1rem;
    font-weight: 800;
    color: var(--primary) !important;
    margin-bottom: 24px;
    padding-bottom: 10px;
    border-bottom: 3px solid #ffe4ee;
    width: 100%;
  }

  .form-field {
    margin-bottom: 24px;
  }

  .form-field label {
    display: block;
    font-size: 0.9rem;
    font-weight: 700;
    color: #475569;
    margin-bottom: 10px;
  }

  .premium-input,
  .premium-textarea {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid #f1f5f9;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.25s ease;
    background: #fbfcfe;
    color: #1e293b;
  }

  .premium-input:focus,
  .premium-textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: #fff;
    box-shadow: 0 0 0 4px rgba(255, 107, 166, 0.15);
  }

  .premium-textarea {
    resize: none;
    line-height: 1.7;
  }

  /* セグメンテッドコントロール */
  .segmented-control {
    display: flex;
    background: #f1f5f9;
    padding: 5px;
    border-radius: 14px;
    gap: 5px;
  }

  .segmented-control input[type="radio"] {
    display: none;
  }

  .segmented-control label {
    flex: 1;
    text-align: center;
    padding: 12px;
    cursor: pointer;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 700;
    color: #64748b;
    margin-bottom: 0 !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .segmented-control input[type="radio"]:checked+label {
    background: #fff;
    color: var(--primary);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  /* プレミアムチェックボックス */
  .premium-checkbox {
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    padding: 14px 18px;
    background: #fff5f8;
    border-radius: 12px;
    border: 2px solid #ffe4ee;
    transition: all 0.2s;
  }

  .premium-checkbox input {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--primary);
  }

  .premium-checkbox:hover {
    background: #fff1f6;
  }

  .premium-checkbox .label-text {
    flex: 1;
    font-size: 0.95rem;
    font-weight: 700;
    color: #475569;
    padding-left: 8px;
    /* チェックマークとの余白を確保 */
    line-height: 1.4;
  }

  /* プレミアムボタン */
  .modal-footer {
    padding: 24px 32px;
    background: #fff;
    border-top: 1px solid #f1f5f9;
    display: flex;
    justify-content: flex-end;
    gap: 16px;
  }

  .btn-primary-premium {
    background: var(--primary) !important;
    color: #fff !important;
    padding: 14px 32px;
    border-radius: 14px;
    font-weight: 800;
    font-size: 1rem;
    border: none;
    box-shadow: 0 8px 15px rgba(255, 107, 166, 0.25);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .btn-primary-premium:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 20px rgba(255, 107, 166, 0.35);
    filter: brightness(1.05);
  }

  .btn-outline-premium {
    background: #fff;
    color: #64748b;
    border: 2px solid #e2e8f0;
    padding: 14px 28px;
    border-radius: 14px;
    font-weight: 700;
  }

  .btn-outline-premium:hover {
    background: #f8fafc;
    border-color: var(--primary);
    color: var(--primary);
  }

  .form-hint {
    font-size: 0.85rem;
    color: #94a3b8;
    margin-top: 8px;
  }

  .read-status-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }

  .read-status-table th,
  .read-status-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .read-status-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
  }

  .read-status-table .status-read {
    color: #059669;
    font-weight: 600;
  }

  .read-status-table .status-unread {
    color: #dc2626;
    font-weight: 600;
  }
</style>

<script src="/js/admin-sidebar.js"></script>
<script src="/js/aws-s3-upload.js"></script>
<script>
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  const REPORT_API = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';

  let allAnnouncements = [];
  let allStaff = [];
  let currentAnnouncementId = null;

  // アクセス制御：管理者ロールのみアクセス可能
  async function checkAdminAccess() {
    try {
      if (!window.CognitoAuth) {
        await new Promise(resolve => setTimeout(resolve, 500));
        if (!window.CognitoAuth) {
          window.location.href = '/staff/signin.html?redirect=' + encodeURIComponent(window.location.pathname);
          return false;
        }
      }
      const idToken = await getCognitoIdToken();
      if (!idToken) {
        window.location.href = '/staff/signin.html?redirect=' + encodeURIComponent(window.location.pathname);
        return false;
      }

      // トークンをデコードして管理者権限をチェック（簡易版）
      try {
        const payload = JSON.parse(atob(idToken.split('.')[1]));
        const groups = payload['cognito:groups'] || [];
        const role = payload['custom:role'] || payload['role'];
        const isAdmin = groups.includes('admin') || groups.includes('ADMIN') || role === 'admin';

        if (!isAdmin) {
          console.warn('[Announcements] User is not an admin:', payload.email);
          alert('管理者権限が必要です');
          window.location.href = '/staff/signin.html';
          return false;
        }
      } catch (e) {
        console.error('[Announcements] Failed to parse token for permission check:', e);
      }

      return true;
    } catch (error) {
      console.error('[Announcements] Auth error:', error);
      return false;
    }
  }

  // Cognito ID Token取得
  async function getCognitoIdToken() {
    try {
      // 1. localStorageから取得
      let token = localStorage.getItem('cognito_id_token');

      // 2. CognitoAuthオブジェクトから取得
      if (!token && window.CognitoAuth) {
        token = await window.CognitoAuth.getIdToken();
      }

      // 3. その他（互換性のため）
      if (!token) {
        const cognitoUser = localStorage.getItem('cognito_user');
        if (cognitoUser) {
          const parsed = JSON.parse(cognitoUser);
          token = parsed.tokens?.idToken || parsed.idToken;
        }
      }

      // トークンの有効期限チェック
      if (token && token !== 'mock-token') {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          const exp = payload.exp * 1000;
          if (Date.now() >= exp) {
            console.warn('[Announcements] Token expired');
            // 有効期限切れの場合はnullを返して再認証を促す
            return null;
          }
        } catch (e) {
          console.error('[Announcements] Invalid token format');
          return null;
        }
      }

      return token;
    } catch (error) {
      console.error('Error getting ID token:', error);
      return null;
    }
  }

  // 初期化
  document.addEventListener('DOMContentLoaded', async () => {
    const hasAccess = await checkAdminAccess();
    if (!hasAccess) return;

    await loadStaff();
    await loadAnnouncements();
    setupEventListeners();
  });

  // スタッフ一覧を読み込み
  async function loadStaff() {
    try {
      const response = await fetch(`${API_BASE}/workers`);
      if (response.ok) {
        const data = await response.json();
        allStaff = Array.isArray(data) ? data : (data.items || data.workers || []);

        // セレクトボックスに追加
        const select = document.getElementById('target-staff-select');
        select.innerHTML = allStaff.map(staff =>
          `<option value="${staff.id}">${staff.name || staff.email || 'Unknown'}</option>`
        ).join('');
      }
    } catch (error) {
      console.error('Error loading staff:', error);
    }
  }

  // 業務連絡一覧を読み込み
  async function loadAnnouncements() {
    try {
      const idToken = await getCognitoIdToken();
      const response = await fetch(`${REPORT_API}/admin/announcements`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });

      if (!response.ok) {
        throw new Error('業務連絡の取得に失敗しました');
      }

      const data = await response.json();
      allAnnouncements = data.announcements || [];

      updateStats();
      renderTable();
    } catch (error) {
      console.error('Error loading announcements:', error);
      document.getElementById('announcements-tbody').innerHTML =
        '<tr><td colspan="6" class="loading-cell">読み込みに失敗しました</td></tr>';
    }
  }

  // 統計を更新
  function updateStats() {
    const total = allAnnouncements.length;
    const all = allAnnouncements.filter(a => a.target_type === 'all').length;
    const individual = allAnnouncements.filter(a => a.target_type === 'individual').length;

    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const thisWeek = allAnnouncements.filter(a => {
      const created = new Date(a.created_at);
      return created >= weekAgo;
    }).length;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-all').textContent = all;
    document.getElementById('stat-individual').textContent = individual;
    document.getElementById('stat-thisweek').textContent = thisWeek;
  }

  // テーブルをレンダリング
  function renderTable() {
    const tbody = document.getElementById('announcements-tbody');
    const searchQuery = document.getElementById('search-input').value.toLowerCase();
    const filterType = document.getElementById('filter-type').value;

    let filtered = allAnnouncements.filter(a => {
      const matchesSearch = !searchQuery ||
        a.title.toLowerCase().includes(searchQuery) ||
        a.content.toLowerCase().includes(searchQuery);
      const matchesType = !filterType || a.target_type === filterType;
      return matchesSearch && matchesType;
    });

    // 作成日でソート（降順）
    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">業務連絡がありません</td></tr>';
      return;
    }

    tbody.innerHTML = filtered.map(announcement => {
      const createdDate = new Date(announcement.created_at);
      const dateStr = createdDate.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const targetText = announcement.target_type === 'all'
        ? '全社員'
        : `個別 (${announcement.target_staff_ids?.length || 0}名)`;

      const deadlineText = announcement.has_deadline && announcement.deadline
        ? new Date(announcement.deadline).toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })
        : '-';

      return `
        <tr>
          <td>${dateStr}</td>
          <td><strong>${escapeHtml(announcement.title)}</strong></td>
          <td>${targetText}</td>
          <td>${deadlineText}</td>
          <td>
            <button class="btn btn-text btn-sm" onclick="viewDetail('${announcement.id}')">
              <i class="fas fa-eye"></i> 確認
            </button>
          </td>
          <td>
            <button class="btn btn-text btn-sm" onclick="editAnnouncement('${announcement.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-text btn-sm btn-danger" onclick="deleteAnnouncement('${announcement.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // イベントリスナー設定
  function setupEventListeners() {
    // 新規作成ボタン
    document.getElementById('btn-new-announcement').addEventListener('click', () => {
      openAnnouncementDialog();
    });

    // 送信先ラジオボタン
    document.querySelectorAll('input[name="target_type"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const targetStaffGroup = document.getElementById('target-staff-group');
        if (e.target.value === 'individual') {
          targetStaffGroup.style.display = 'block';
          document.getElementById('target-staff-select').required = true;
        } else {
          targetStaffGroup.style.display = 'none';
          document.getElementById('target-staff-select').required = false;
        }
      });
    });

    // 期限チェックボックス
    document.getElementById('has-deadline').addEventListener('change', (e) => {
      const deadlineGroup = document.getElementById('deadline-group');
      if (e.target.checked) {
        deadlineGroup.style.display = 'block';
        document.getElementById('announcement-deadline').required = true;
      } else {
        deadlineGroup.style.display = 'none';
        document.getElementById('announcement-deadline').required = false;
      }
    });

    // フォーム送信
    document.getElementById('announcement-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveAnnouncement();
    });

    // 検索・フィルター
    document.getElementById('search-input').addEventListener('input', renderTable);
    document.getElementById('filter-type').addEventListener('change', renderTable);
    document.getElementById('btn-reset-filters').addEventListener('click', () => {
      document.getElementById('search-input').value = '';
      document.getElementById('filter-type').value = '';
      renderTable();
    });

    // 編集・削除ボタン
    document.getElementById('btn-edit-announcement').addEventListener('click', () => {
      if (currentAnnouncementId) {
        editAnnouncement(currentAnnouncementId);
      }
    });
    document.getElementById('btn-delete-announcement').addEventListener('click', () => {
      if (currentAnnouncementId) {
        deleteAnnouncement(currentAnnouncementId);
      }
    });

    // 通知音トグル
    document.getElementById('notify-sound-toggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        playNotificationSound();
      }
    });

    // 画像プレビュー
    document.getElementById('announcement-image').addEventListener('change', function (e) {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('image-preview').src = e.target.result;
          document.getElementById('image-preview-container').style.display = 'block';
        };
        reader.readAsDataURL(this.files[0]);
      }
    });

    // 画像削除
    document.getElementById('btn-clear-image').addEventListener('click', () => {
      document.getElementById('announcement-image').value = '';
      document.getElementById('current-image-url').value = '';
      document.getElementById('image-preview-container').style.display = 'none';
    });
  }

  // 通知音を再生
  function playNotificationSound() {
    const audio = new Audio('/assets/eyecatch_se1.mp3');
    audio.play().catch(err => console.error('Sound play error:', err));
  }

  // 新規作成ダイアログを開く
  function openAnnouncementDialog() {
    document.getElementById('form-title').textContent = '新規業務連絡作成';
    document.getElementById('announcement-form').reset();
    document.getElementById('announcement-id').value = '';
    document.getElementById('target-staff-group').style.display = 'none';
    document.getElementById('deadline-group').style.display = 'none';

    // 画像リセット
    document.getElementById('announcement-image').value = '';
    document.getElementById('current-image-url').value = '';
    document.getElementById('image-preview-container').style.display = 'none';

    document.getElementById('announcement-dialog').showModal();
  }

  // 業務連絡を保存
  async function saveAnnouncement() {
    try {
      const form = document.getElementById('announcement-form');
      const formData = new FormData(form);

      const announcementId = formData.get('id');
      const title = formData.get('title');
      const content = formData.get('content');
      const targetType = formData.get('target_type');
      const hasDeadline = formData.get('has_deadline') === 'on';
      const deadline = formData.get('deadline');

      let targetStaffIds = [];
      if (targetType === 'individual') {
        const select = document.getElementById('target-staff-select');
        targetStaffIds = Array.from(select.selectedOptions).map(opt => opt.value);
      }

      const data = {
        title,
        content,
        target_type: targetType,
        target_staff_ids: targetStaffIds,
        has_deadline: hasDeadline,
        deadline: hasDeadline && deadline ? new Date(deadline).toISOString() : null,
        notify_push: formData.get('notify_push') === 'on',
        notify_email: formData.get('notify_email') === 'on',
        notify_line: formData.get('notify_line') === 'on',
        notify_sound: formData.get('notify_sound') === 'on'
      };

      // 画像アップロード処理
      const imageInput = document.getElementById('announcement-image');
      let imageUrl = document.getElementById('current-image-url').value;

      if (imageInput.files.length > 0) {
        // アップロード中表示などが必要だが、簡易的にアラート等は出さない
        try {
          if (window.AWSS3Upload) {
            const file = imageInput.files[0];
            const uploadRes = await window.AWSS3Upload.uploadImage(file, 'image', {
              keyPrefix: 'announcements',
              fileName: `ann_${Date.now()}_${file.name}`
            });
            imageUrl = uploadRes.url;
          } else {
            console.error('S3 Upload library not loaded');
            // Fallback: base64 (not recommended for large files but good for MVP)
            // ... actually better to fail if upload required
            alert('画像アップロード機能が読み込まれていません');
            return;
          }
        } catch (e) {
          console.error('Image upload failed', e);
          alert('画像のアップロードに失敗しました');
          return;
        }
      }
      data.image_url = imageUrl;

      const idToken = await getCognitoIdToken();
      const url = announcementId
        ? `${REPORT_API}/admin/announcements/${announcementId}`
        : `${REPORT_API}/admin/announcements`;
      const method = announcementId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}`
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error('保存に失敗しました');
      }

      document.getElementById('announcement-dialog').close();
      await loadAnnouncements();
      alert('保存しました');
    } catch (error) {
      console.error('Error saving announcement:', error);
      alert('保存に失敗しました: ' + error.message);
    }
  }

  // 詳細を表示
  async function viewDetail(announcementId) {
    try {
      currentAnnouncementId = announcementId;
      const idToken = await getCognitoIdToken();
      const response = await fetch(`${REPORT_API}/admin/announcements/${announcementId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });

      if (!response.ok) {
        throw new Error('取得に失敗しました');
      }

      const announcement = await response.json();

      const createdDate = new Date(announcement.created_at);
      const dateStr = createdDate.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const deadlineText = announcement.has_deadline && announcement.deadline
        ? new Date(announcement.deadline).toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })
        : '期限なし';

      const targetText = announcement.target_type === 'all'
        ? '全社員'
        : `個別送信 (${announcement.target_staff_ids?.length || 0}名)`;

      let readStatusHtml = '';
      if (announcement.read_status && announcement.read_status.length > 0) {
        readStatusHtml = `
          <h4>既読状況 (${announcement.read_count || 0} / ${announcement.total_count || 0})</h4>
          <table class="read-status-table">
            <thead>
              <tr>
                <th>名前</th>
                <th>既読状況</th>
                <th>既読日時</th>
              </tr>
            </thead>
            <tbody>
              ${announcement.read_status.map(status => `
                <tr>
                  <td>${escapeHtml(status.staff_name)}</td>
                  <td class="${status.is_read ? 'status-read' : 'status-unread'}">
                    ${status.is_read ? '既読' : '未読'}
                  </td>
                  <td>${status.read_at ? new Date(status.read_at).toLocaleString('ja-JP') : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      document.getElementById('announcement-detail-content').innerHTML = `
        <div>
          <h3>${escapeHtml(announcement.title)}</h3>
          <div style="margin: 16px 0; padding: 16px; background: #f9fafb; border-radius: 8px;">
            ${announcement.image_url ? `<img src="${announcement.image_url}" style="max-width:100%; max-height:400px; border-radius:8px; margin-bottom:16px; display:block;">` : ''}
            <p style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(announcement.content)}</p>
          </div>
          <div style="margin-top: 24px;">
            <p><strong>作成日:</strong> ${dateStr}</p>
            <p><strong>作成者:</strong> ${escapeHtml(announcement.created_by_name || '管理者')}</p>
            <p><strong>送信先:</strong> ${targetText}</p>
            <p><strong>期限:</strong> ${deadlineText}</p>
          </div>
          ${readStatusHtml}
        </div>
      `;

      document.getElementById('detail-dialog').showModal();
    } catch (error) {
      console.error('Error loading detail:', error);
      alert('詳細の取得に失敗しました');
    }
  }

  // 編集
  async function editAnnouncement(announcementId) {
    const announcement = allAnnouncements.find(a => a.id === announcementId);
    if (!announcement) return;

    document.getElementById('form-title').textContent = '業務連絡編集';
    document.getElementById('announcement-id').value = announcement.id;
    document.getElementById('announcement-title').value = announcement.title;
    document.getElementById('announcement-content').value = announcement.content;

    // 画像設定
    document.getElementById('current-image-url').value = announcement.image_url || '';
    if (announcement.image_url) {
      document.getElementById('image-preview').src = announcement.image_url;
      document.getElementById('image-preview-container').style.display = 'block';
    } else {
      document.getElementById('image-preview-container').style.display = 'none';
      document.getElementById('image-preview').src = '';
    }

    // 送信先
    document.querySelector(`input[name="target_type"][value="${announcement.target_type}"]`).checked = true;
    if (announcement.target_type === 'individual') {
      document.getElementById('target-staff-group').style.display = 'block';
      const select = document.getElementById('target-staff-select');
      Array.from(select.options).forEach(opt => {
        opt.selected = announcement.target_staff_ids?.includes(opt.value);
      });
    }

    // 期限
    if (announcement.has_deadline && announcement.deadline) {
      document.getElementById('has-deadline').checked = true;
      document.getElementById('deadline-group').style.display = 'block';
      const deadline = new Date(announcement.deadline);
      const localDateTime = new Date(deadline.getTime() - deadline.getTimezoneOffset() * 60000)
        .toISOString().slice(0, 16);
      document.getElementById('announcement-deadline').value = localDateTime;
    }

    document.getElementById('detail-dialog').close();
    document.getElementById('announcement-dialog').showModal();
  }

  // 削除
  async function deleteAnnouncement(announcementId) {
    if (!confirm('この業務連絡を削除しますか？')) return;

    try {
      const idToken = await getCognitoIdToken();
      const response = await fetch(`${REPORT_API}/admin/announcements/${announcementId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${idToken}`
        }
      });

      if (!response.ok) {
        throw new Error('削除に失敗しました');
      }

      document.getElementById('detail-dialog').close();
      await loadAnnouncements();
      alert('削除しました');
    } catch (error) {
      console.error('Error deleting announcement:', error);
      alert('削除に失敗しました: ' + error.message);
    }
  }

  // HTMLエスケープ
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>