@layout('layouts.admin')
@json('data/meta/admin_user_detail_title.json', $title)
@json('data/meta/admin_user_detail_body_class.json', $body_class)

<style>
  #default-header-wrapper,
  #normal-header-wrapper {
    display: none !important;
  }
</style>

<main id="main" class="admin-user-detail">
  @include('partials.admin-sidebar')
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <div class="page-header">
      <a href="/admin/users/" class="back-btn" id="back-btn">
        <i class="fas fa-chevron-left"></i>
      </a>
      <h1 class="page-title" id="page-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h1>
      <button class="btn btn-outline btn-sm" id="edit-btn" style="display: none;" onclick="openEditModal()">
        <i class="fas fa-edit"></i> ç·¨é›†
      </button>
    </div>

    <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="error-message" class="error-message" style="display: none;"></div>

    <div id="user-content" style="display: none;">
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
      <div class="info-card">
        <div class="card-header">
          <div class="user-main-info">
            <div class="user-avatar-large" id="user-avatar-large">
              <span id="user-avatar-text">?</span>
            </div>
            <div class="user-info-text">
              <h2 class="user-name" id="user-name">-</h2>
              <div class="user-email" id="user-email">-</div>
              <div class="user-role-badge" id="user-role-badge">
                <span class="role-badge" id="role-badge">-</span>
              </div>
            </div>
          </div>
          <span class="status-badge" id="status-badge">-</span>
        </div>

        <div class="info-grid">
          <div class="info-section">
            <h3 class="section-title">
              <i class="fas fa-user"></i>
              åŸºæœ¬æƒ…å ±
            </h3>
            <div class="info-item">
              <span class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</span>
              <span class="info-value" id="user-id">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">åå‰</span>
              <span class="info-value" id="info-name">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</span>
              <span class="info-value">
                <a href="#" id="info-email">-</a>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">é›»è©±ç•ªå·</span>
              <span class="info-value" id="info-phone">-</span>
            </div>
          </div>

          <div class="info-section">
            <h3 class="section-title">
              <i class="fas fa-briefcase"></i>
              æ‰€å±æƒ…å ±
            </h3>
            <div class="info-item">
              <span class="info-label">ãƒ­ãƒ¼ãƒ«</span>
              <span class="info-value" id="info-role">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">éƒ¨ç½²</span>
              <span class="info-value" id="info-department">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">æ‹…å½“æ¥­å‹™</span>
              <span class="info-value" id="info-job">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
              <span class="info-value" id="info-status">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ç™»éŒ²æ—¥</span>
              <span class="info-value" id="info-created-at">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">è¨€èª</span>
              <span class="info-value" id="info-language">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- äººæDBæƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
      <div class="info-card">
        <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
          <h3 class="section-title" style="margin: 0;">
            <i class="fas fa-database"></i>
            äººæDB
          </h3>
          <button class="btn btn-outline btn-sm" onclick="openHREditModal()">
            <i class="fas fa-edit"></i> ç·¨é›†
          </button>
        </div>

        <div class="info-grid" style="margin-top: 24px;">
          <!-- é›‡ç”¨æƒ…å ± -->
          <div class="info-section">
            <h4 class="section-subtitle">
              <i class="fas fa-file-contract"></i>
              é›‡ç”¨æƒ…å ±
            </h4>
            <div class="info-item">
              <span class="info-label">å…¥ç¤¾æ—¥</span>
              <span class="info-value" id="hr-hire-date">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">é›‡ç”¨å½¢æ…‹</span>
              <span class="info-value" id="hr-employment-type">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">å¥‘ç´„æœŸé–“</span>
              <span class="info-value" id="hr-contract-period">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">å‹¤å‹™æ™‚é–“å¸¯</span>
              <span class="info-value" id="hr-work-schedule">-</span>
            </div>
          </div>

          <!-- ã‚¹ã‚­ãƒ«ãƒ»è³‡æ ¼ -->
          <div class="info-section">
            <h4 class="section-subtitle">
              <i class="fas fa-award"></i>
              ã‚¹ã‚­ãƒ«ãƒ»è³‡æ ¼
            </h4>
            <div class="info-item">
              <span class="info-label">ä¿æœ‰è³‡æ ¼</span>
              <span class="info-value" id="hr-certifications">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ã‚¹ã‚­ãƒ«</span>
              <span class="info-value" id="hr-skills">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">çµŒé¨“å¹´æ•°</span>
              <span class="info-value" id="hr-experience-years">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">å‰è·ãƒ»çµŒæ­´</span>
              <span class="info-value" id="hr-previous-experience">-</span>
            </div>
          </div>

          <!-- ç·Šæ€¥é€£çµ¡å…ˆ -->
          <div class="info-section">
            <h4 class="section-subtitle">
              <i class="fas fa-phone-alt"></i>
              ç·Šæ€¥é€£çµ¡å…ˆ
            </h4>
            <div class="info-item">
              <span class="info-label">ç·Šæ€¥é€£çµ¡å…ˆåå‰</span>
              <span class="info-value" id="hr-emergency-name">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ç·Šæ€¥é€£çµ¡å…ˆé›»è©±</span>
              <span class="info-value" id="hr-emergency-phone">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ç¶šæŸ„</span>
              <span class="info-value" id="hr-emergency-relation">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ä½æ‰€</span>
              <span class="info-value" id="hr-address">-</span>
            </div>
          </div>

          <!-- çµ¦ä¸ãƒ»è©•ä¾¡ -->
          <div class="info-section">
            <h4 class="section-subtitle">
              <i class="fas fa-yen-sign"></i>
              çµ¦ä¸ãƒ»è©•ä¾¡
            </h4>
            <div class="info-item">
              <span class="info-label">æ™‚çµ¦/æœˆçµ¦</span>
              <span class="info-value" id="hr-salary">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">çµ¦ä¸å½¢æ…‹</span>
              <span class="info-value" id="hr-salary-type">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">è©•ä¾¡</span>
              <span class="info-value" id="hr-evaluation">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">å‚™è€ƒ</span>
              <span class="info-value" id="hr-notes">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="attendance-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="fas fa-clock"></i>
            ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰
          </h3>
          <div class="month-selector">
            <button class="btn-icon" id="prev-month-btn" title="å‰æœˆ">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span class="month-display" id="month-display">2025å¹´12æœˆ</span>
            <button class="btn-icon" id="next-month-btn" title="æ¬¡æœˆ">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <!-- æœˆé–“ã‚µãƒãƒªãƒ¼ -->
        <div class="monthly-summary" id="monthly-summary">
          <div class="summary-card">
            <div class="summary-label">å‡ºå‹¤æ—¥æ•°</div>
            <div class="summary-value" id="summary-work-days">-</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">ç·åŠ´åƒæ™‚é–“</div>
            <div class="summary-value" id="summary-total-hours">-</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">æ®‹æ¥­æ™‚é–“</div>
            <div class="summary-value" id="summary-overtime-hours">-</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">é…åˆ»å›æ•°</div>
            <div class="summary-value" id="summary-late-count">-</div>
          </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ°´å¹³æ–¹å‘ï¼‰ -->
        <div class="timecard-table-container">
          <table class="timecard-table timecard-table-horizontal" id="timecard-table">
            <thead id="timecard-thead">
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </thead>
            <tbody id="timecard-tbody">
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- æ—¥å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="attendance-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="fas fa-file-alt"></i>
            æ—¥å ±
          </h3>
          <div class="month-selector">
            <button class="btn-icon" id="daily-report-refresh-btn" title="æ›´æ–°">
              <i class="fas fa-sync"></i>
            </button>
          </div>
        </div>
        <div class="info-card" style="margin-top: 12px;">
          <div class="info-item" style="flex-direction: column; align-items: stretch;">
            <div id="daily-reports-loading" class="muted small">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="daily-reports-empty" class="muted small" style="display: none;">æ—¥å ±ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            <div id="daily-reports-list"></div>
          </div>
        </div>
      </div>

      <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="schedule-section">
        <h3 class="section-title">
          <i class="fas fa-calendar-alt"></i>
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±
        </h3>
        <div class="schedule-card">
          <div id="schedule-list">
            <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
          </div>
        </div>
      </div>

      <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="actions-section">
        <h3 class="section-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
        <div class="action-buttons">
          <a href="#" class="action-btn" id="mypage-btn" style="display: none;">
            <i class="fas fa-user-circle"></i>
            <span>ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’é–‹ã</span>
          </a>
          <a href="#" class="action-btn" id="schedule-btn">
            <i class="fas fa-calendar-plus"></i>
            <span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ </span>
          </a>
          <a href="#" class="action-btn" id="report-btn">
            <i class="fas fa-file-alt"></i>
            <span>ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª</span>
          </a>
          <a href="#" class="action-btn" id="email-btn">
            <i class="fas fa-envelope"></i>
            <span>ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>
          </a>
        </div>
      </div>

      <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <div class="nav-section">
        <a href="/admin/users/" class="btn btn-outline btn-block">
          <i class="fas fa-list"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹
        </a>
      </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="edit-modal" id="edit-modal" style="display:none;">
      <div class="modal-overlay" onclick="closeEditModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†</h2>
          <button class="modal-close" onclick="closeEditModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <form id="edit-form">
            <div class="form-grid">
              <div class="form-group full">
                <label for="edit-name">åå‰ <span class="required">*</span></label>
                <input type="text" id="edit-name" required>
              </div>
              <div class="form-group full">
                <label for="edit-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
                <input type="email" id="edit-email" required placeholder="yamada.taro@example.com">
                <small class="form-hint">ç¾çŠ¶ã¯å€‹äººãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ï¼ˆå°†æ¥çš„ã«ã¯ä¼æ¥­ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ç§»è¡Œã‚’æ¨å¥¨ï¼‰</small>
              </div>
              <div class="form-group">
                <label for="edit-phone">é›»è©±ç•ªå·</label>
                <input type="tel" id="edit-phone" placeholder="090-1234-5678">
              </div>
              <div class="form-group">
                <label for="edit-role">ãƒ­ãƒ¼ãƒ« <span class="required">*</span></label>
                <select id="edit-role" required>
                  <option value="admin">ç®¡ç†è€…</option>
                  <option value="staff">ãªã—</option>
                </select>
                <small class="form-hint">ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¡¨ã—ã¾ã™</small>
              </div>
              <div class="form-group">
                <label for="edit-department">éƒ¨ç½²</label>
                <input type="text" id="edit-department" placeholder="ä¾‹: å–ç· å½¹ä¼šã€å–¶æ¥­ã€äº‹å‹™ã€é–‹ç™ºã€OSèª²ã€é‹å–¶">
                <small class="form-hint">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸ã§ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™</small>
              </div>
              <div class="form-group full">
                <label for="edit-job">æ‹…å½“æ¥­å‹™</label>
                <input type="text" id="edit-job" placeholder="ä¾‹: FSå–¶æ¥­ãƒ»æ¸…æƒã€ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°">
                <small class="form-hint">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒƒã‚¸ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã§ã™ã€‚è¤‡æ•°ã®æ¥­å‹™ã¯ã€Œãƒ»ã€ã§åŒºåˆ‡ã£ã¦ãã ã•ã„</small>
              </div>
              <div class="form-group">
                <label for="edit-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ <span class="required">*</span></label>
                <select id="edit-status" required>
                  <option value="active">æœ‰åŠ¹</option>
                  <option value="inactive">ç„¡åŠ¹</option>
                </select>
              </div>
              <div class="form-group">
                <label for="edit-scheduled-start-time">æ‰€å®šé–‹å§‹æ™‚åˆ»</label>
                <input type="time" id="edit-scheduled-start-time" value="09:00">
              </div>
              <div class="form-group">
                <label for="edit-scheduled-end-time">æ‰€å®šçµ‚äº†æ™‚åˆ»</label>
                <input type="time" id="edit-scheduled-end-time" value="18:00">
              </div>
              <div class="form-group">
                <label for="edit-scheduled-work-hours">æ‰€å®šåŠ´åƒæ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
                <input type="number" id="edit-scheduled-work-hours" step="0.5" min="0" max="24" value="8.0">
              </div>
            </div>
            <div class="form-status" id="edit-form-status"></div>
            <div class="modal-actions">
              <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      :root {
        --sidebar-width: 240px;
        --sidebar-width-collapsed: 64px;
      }

      .admin-user-detail {
        display: flex;
        min-height: 100vh;
        background: #f9fafb;
      }

      .nav-label {
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-size: 0.8125rem;
      }

      .sidebar.collapsed .nav-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 8px 12px;
      }

      /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 24px;
        background: #f9fafb;

        transition: margin-left 0.3s ease;
      }

      .sidebar.collapsed~.main-content {
        margin-left: var(--sidebar-width);
        padding: 24px;
        background: #f9fafb;

        transition: margin-left 0.3s ease;
      }

      /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .page-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
        flex-wrap: wrap;
      }

      .back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        color: #374151;
        text-decoration: none;
        transition: all 0.2s;
      }

      .back-btn:hover {
        background: #f9fafb;
        border-color: var(--primary);
        color: var(--primary);
      }

      .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
        flex: 1;
      }

      .loading {
        text-align: center;
        padding: 48px;
        color: #6b7280;
        font-size: 1rem;
      }

      .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        text-align: center;
      }

      .info-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 24px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f3f4f6;
      }

      .user-main-info {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
      }

      .user-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 2rem;
        flex-shrink: 0;
      }

      .user-info-text {
        flex: 1;
      }

      .user-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin: 0 0 8px 0;
      }

      .user-email {
        font-size: 1rem;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .user-role-badge {
        display: inline-block;
      }

      .role-badge {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .role-admin {
        background: #fce7f3;
        color: #be185d;
      }

      .role-none {
        background: #f1f5f9;
        color: #64748b;
      }

      .section-subtitle {
        font-size: 0.95rem;
        font-weight: 600;
        color: #374151;
        margin: 0 0 12px 0;
        display: flex;
        align-items: center;
        gap: 6px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      .section-subtitle i {
        color: #6366f1;
        font-size: 0.85rem;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        flex-shrink: 0;
        margin-left: 16px;
      }

      .status-active {
        background: #d1fae5;
        color: #065f46;
      }

      .status-inactive {
        background: #fee2e2;
        color: #991b1b;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
      }

      .info-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .section-title i {
        color: var(--primary);
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
      }

      .info-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-size: 0.95rem;
        color: #111827;
        font-weight: 500;
      }

      .info-value a {
        color: var(--primary);
        text-decoration: none;
      }

      .info-value a:hover {
        text-decoration: underline;
      }

      .attendance-section,
      .schedule-section {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 24px;
      }

      .attendance-card {
        margin-top: 16px;
      }

      .attendance-today {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: #f9fafb;
        border-radius: 12px;
        margin-bottom: 24px;
      }

      .attendance-status {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .status-indicator {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #9ca3af;
      }

      .status-indicator.working {
        background: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
      }

      .status-text {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .status-label {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .status-time {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
      }

      .attendance-calendar {
        margin-top: 16px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-selector {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .month-display {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        min-width: 120px;
        text-align: center;
      }

      .btn-icon {
        width: 32px;
        height: 32px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #fff;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .btn-icon:hover {
        background: #f3f4f6;
        border-color: var(--primary);
        color: var(--primary);
      }

      .monthly-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .summary-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        text-align: center;
      }

      .summary-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
      }

      .timecard-table-container {
        overflow-x: auto;
        margin-top: 16px;
      }

      .timecard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }

      .timecard-table thead {
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
      }

      .timecard-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        white-space: nowrap;
      }

      .timecard-table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .timecard-table tbody tr:hover {
        background: #f9fafb;
      }

      /* æ°´å¹³æ–¹å‘ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ */
      .timecard-table-horizontal th:first-child,
      .timecard-table-horizontal td:first-child {
        position: sticky;
        left: 0;
        background: #ffffff;
        z-index: 1;
        border-right: 2px solid #e5e7eb;
        font-weight: 600;
      }

      .timecard-table-horizontal thead th:first-child {
        background: #f9fafb;
        z-index: 2;
      }

      .timecard-table-horizontal tbody tr:hover td:first-child {
        background: #f9fafb;
      }

      .timecard-table-horizontal th {
        text-align: center;
        min-width: 80px;
      }

      .timecard-table-horizontal td {
        text-align: center;
      }

      .timecard-table-horizontal .today-column {
        background: #eff6ff !important;
      }

      .timecard-table-horizontal .today-column:hover {
        background: #dbeafe !important;
      }

      .status-badge-timecard {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .status-completed {
        background: #d1fae5;
        color: #065f46;
      }

      .status-working {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-absent {
        background: #fee2e2;
        color: #991b1b;
      }

      .status-late {
        background: #fef3c7;
        color: #92400e;
      }

      .status-early-leave {
        background: #fce7f3;
        color: #9f1239;
      }

      .today-row {
        background: #eff6ff !important;
        font-weight: 600;
      }

      .today-row:hover {
        background: #dbeafe !important;
      }

      .schedule-card {
        margin-top: 16px;
      }

      .actions-section {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 24px;
      }

      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }

      .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        text-decoration: none;
        color: #374151;
        transition: all 0.2s;
      }

      .action-btn:hover {
        background: #ffffff;
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .action-btn i {
        font-size: 1.5rem;
        color: var(--primary);
      }

      .action-btn span {
        font-size: 0.875rem;
        font-weight: 500;
      }

      .nav-section {
        margin-bottom: 24px;
      }

      @media (max-width: 768px) {
        .admin-user-detail {
          padding: 12px;
        }

        .info-card,
        .attendance-section,
        .schedule-section,
        .actions-section {
          padding: 16px;
        }

        .card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .user-main-info {
          flex-direction: column;
          align-items: flex-start;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .attendance-today {
          flex-direction: column;
          gap: 16px;
          align-items: flex-start;
        }

        .action-buttons {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
      .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        position: relative;
        background: #ffffff;
        border-radius: 12px;
        max-width: 600px;
        width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 1001;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .modal-body {
        padding: 24px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group.full {
        grid-column: 1 / -1;
      }

      .form-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
      }

      .form-group .required {
        color: #ef4444;
      }

      .form-group input,
      .form-group select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-hint {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 4px;
      }

      .form-status {
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 8px;
        font-size: 0.875rem;
        text-align: center;
      }

      .form-status.success {
        background: #d1fae5;
        color: #065f46;
      }

      .form-status.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--primary);
        color: #ffffff;
      }

      .btn-secondary {
        background: #6b7280;
        color: #ffffff;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      .btn-primary:hover {
        opacity: 0.9;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      @media (max-width: 768px) {
        .form-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95vw;
          max-height: 95vh;
        }
      }
    </style>

    <script>
      const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
      let currentUser = null;
      let attendanceRecords = {};
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let monthlyAttendance = [];
      let attendanceRequests = []; // ç·¨é›†ç”³è«‹ã®ä¸€è¦§

      function getAuthToken() {
        if (window.CognitoAuth && window.CognitoAuth.isAuthenticated && window.CognitoAuth.isAuthenticated()) {
          const token = window.CognitoAuth.getIdToken && window.CognitoAuth.getIdToken();
          if (token) return token;
        }
        return localStorage.getItem('cognito_id_token');
      }

      function buildAuthHeaders(includeContentType = false) {
        const headers = {};
        if (includeContentType) {
          headers['Content-Type'] = 'application/json';
        }
        const token = getAuthToken();
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        return headers;
      }

      function getAuthToken() {
        if (window.CognitoAuth && window.CognitoAuth.isAuthenticated && window.CognitoAuth.isAuthenticated()) {
          const token = window.CognitoAuth.getIdToken && window.CognitoAuth.getIdToken();
          if (token) return token;
        }
        return localStorage.getItem('cognito_id_token');
      }

      function buildAuthHeaders(includeContentType = false) {
        const headers = {};
        if (includeContentType) {
          headers['Content-Type'] = 'application/json';
        }
        const token = getAuthToken();
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        return headers;
      }

      // URLã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
      function getUserIdFromUrl() {
        // ã¾ãšã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
        const urlParams = new URLSearchParams(window.location.search);
        const idFromQuery = urlParams.get('id') || urlParams.get('user_id');
        if (idFromQuery) {
          return idFromQuery;
        }

        // ãƒ‘ã‚¹ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
        const path = window.location.pathname;
        let match = path.match(/\/admin\/users\/([^\/]+)(?:\.html)?$/);
        if (match) {
          const id = match[1];
          if (id !== 'detail') {
            return id;
          }
        }

        return null;
      }

      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }

      function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function formatTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Decimalå‹ã‚„æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      function toNumber(value) {
        if (value == null || value === undefined) return 0;
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
          const num = parseFloat(value);
          return isNaN(num) ? 0 : num;
        }
        // Decimalå‹ã‚„ãã®ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
        if (typeof value === 'object' && value !== null) {
          if (typeof value.toNumber === 'function') {
            return value.toNumber();
          }
          if (typeof value.toString === 'function') {
            const num = parseFloat(value.toString());
            return isNaN(num) ? 0 : num;
          }
        }
        return 0;
      }

      // ç·ä¼‘æ†©æ™‚é–“ã‚’è¨ˆç®—
      function calculateTotalBreakTime(breaks) {
        if (!breaks || !Array.isArray(breaks)) return 0;
        return breaks.reduce((total, b) => {
          if (b.break_duration) {
            return total + toNumber(b.break_duration);
          } else if (b.break_start && b.break_end) {
            const start = new Date(b.break_start);
            const end = new Date(b.break_end);
            return total + (end - start) / (1000 * 60 * 60);
          } else if (b.start && b.end) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: start/endå½¢å¼
            const start = new Date(b.start);
            const end = new Date(b.end);
            return total + (end - start) / (1000 * 60 * 60);
          }
          return total;
        }, 0);
      }

      function calculateWorkHours(record) {
        if (!record.clock_in || !record.clock_out) return 0;
        const start = new Date(record.clock_in);
        const end = new Date(record.clock_out);
        const totalHours = (end - start) / (1000 * 60 * 60);

        // ä¼‘æ†©æ™‚é–“ã‚’å–å¾—ï¼ˆbreak_timeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°breaksé…åˆ—ã‹ã‚‰è¨ˆç®—ï¼‰
        let breakTime = 0;
        if (record.break_time !== undefined && record.break_time !== null) {
          // break_timeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆæ™‚é–“å˜ä½ï¼‰
          breakTime = toNumber(record.break_time);
        } else if (record.breaks && record.breaks.length > 0) {
          // breaksé…åˆ—ã‹ã‚‰è¨ˆç®—ï¼ˆæ™‚é–“å˜ä½ï¼‰
          breakTime = calculateTotalBreakTime(record.breaks);
        }

        // å‡ºå‹¤æ™‚åˆ»ã¨é€€å‹¤æ™‚åˆ»ã®å·®ã‹ã‚‰ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
        const workHours = Math.max(0, totalHours - breakTime);

        return Math.round(workHours * 100) / 100; // å°æ•°ç‚¹ç¬¬2ä½ã¾ã§
      }

      function formatHours(hours) {
        if (!hours || hours === 0) return '0h';
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        if (m === 0) return `${h}h`;
        return `${h}h${m}m`;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      async function loadUser() {
        const loadingEl = document.getElementById('loading');
        const contentEl = document.getElementById('user-content');
        const errorEl = document.getElementById('error-message');

        const userId = getUserIdFromUrl();
        if (!userId) {
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorEl.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
          return;
        }

        try {
          loadingEl.style.display = 'block';
          contentEl.style.display = 'none';
          errorEl.style.display = 'none';

          // ã¾ãšAPIã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼‰
          let response = null;
          try {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
            const timestamp = new Date().getTime();
            response = await fetch(`${API_BASE}/workers/${userId}?t=${timestamp}&_=${Date.now()}`, {
              cache: 'no-store',
              headers: buildAuthHeaders()
            });
            if (!response.ok) {
              if (response.status === 404) {
                // APIã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„åå‰ã§æ¤œç´¢ã‚’è©¦ã¿ã‚‹
                const allWorkersResponse = await fetch(`${API_BASE}/workers?t=${timestamp}&_=${Date.now()}`, {
                  cache: 'no-store',
                  headers: buildAuthHeaders()
                });
                if (allWorkersResponse.ok) {
                  const allWorkers = await allWorkersResponse.json();
                  const workersArray = Array.isArray(allWorkers) ? allWorkers : (allWorkers.items || allWorkers.workers || []);
                  const foundUser = workersArray.find(w => w.id === userId);
                  if (foundUser) {
                    currentUser = foundUser;
                  } else {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                  }
                } else {
                  throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
              } else {
                throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
              }
            } else {
              currentUser = await response.json();
            }
          } catch (apiError) {
            console.warn('[UserDetail] APIå–å¾—ã«å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®workers.jsonã‚’è©¦è¡Œ:', apiError);
            // APIã§å–å¾—ã§ããªã„å ´åˆã®ã¿ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®workers.jsonã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
            try {
              const timestamp = new Date().getTime();
              const localResponse = await fetch(`/data/workers.json?t=${timestamp}&_=${Date.now()}`, {
                cache: 'no-store'
              });
              if (localResponse.ok) {
                const localWorkers = await localResponse.json();
                if (Array.isArray(localWorkers) && localWorkers.length > 0) {
                  const matchingUser = localWorkers.find(u => u.id === userId);
                  if (matchingUser) {
                    currentUser = matchingUser;
                    console.log('[UserDetail] Found user from local data (fallback):', matchingUser.name);
                  }
                }
              }
            } catch (localError) {
              console.log('[UserDetail] Local workers.json also not available');
              throw apiError; // å…ƒã®APIã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
            }
          }

          // APIã§å–å¾—ã§ããªã‹ã£ãŸå ´åˆ
          if (!currentUser || !currentUser.id) {
            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          // ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›ï¼ˆroleãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆã€å­˜åœ¨ã—ãªã„å ´åˆã®ã¿role_codeã‹ã‚‰å¤‰æ›ï¼‰
          if (!currentUser.role || currentUser.role === '') {
            if (currentUser.role_code !== undefined && currentUser.role_code !== null) {
              currentUser.role = getRoleFromCode(currentUser.role_code);
            } else {
              // role_codeã‚‚roleã‚‚å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
              currentUser.role = 'staff';
            }
          }
          // roleãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨ï¼ˆrole_codeã¯ç„¡è¦–ï¼‰

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
          renderUser(currentUser);

          // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ï¼ˆå‡ºé€€å‹¤è¨˜éŒ²ã‚‚å«ã‚€ï¼‰
          loadTimecard();
          loadDailyReportsForUser();

          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';
        } catch (error) {
          console.error('Error loading user:', error);
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorEl.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        }
      }

      function getRoleFromCode(code) {
        if (code === '1' || code === 1) return 'admin';
        if (code === '2' || code === 2) return 'sales';
        if (code === '3' || code === 3) return 'office';
        if (code === '4' || code === 4) return 'staff';
        if (code === '5' || code === 5) return 'developer';
        if (code === '6' || code === 6) return 'designer';
        if (code === '7' || code === 7) return 'general_affairs';
        if (code === '8' || code === 8) return 'operation';
        if (code === '9' || code === 9) return 'contractor';
        if (code === '10' || code === 10) return 'accounting';
        if (code === '11' || code === 11) return 'human_resources';
        return 'staff';
      }

      function getRoleLabel(role) {
        // ç®¡ç†è€…ã®ã¿è¡¨ç¤º
        if (role === 'admin') {
          return 'ç®¡ç†è€…';
        }
        return '';
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
      function renderUser(user) {
        // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«
        document.getElementById('page-title').textContent = `${user.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}ã®è©³ç´°`;

        // ã‚¢ãƒã‚¿ãƒ¼
        const avatarText = (user.name || '?')[0].toUpperCase();
        document.getElementById('user-avatar-text').textContent = avatarText;
        document.getElementById('user-avatar-large').style.background = getRoleColor(user.role);

        // åŸºæœ¬æƒ…å ±
        document.getElementById('user-name').textContent = user.name || '-';
        document.getElementById('user-email').textContent = user.email || '-';

        // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¸ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰
        const roleLabel = getRoleLabel(user.role);
        const roleBadge = document.getElementById('role-badge');
        if (roleBadge) {
          if (roleLabel) {
            roleBadge.textContent = roleLabel;
            roleBadge.className = 'role-badge role-admin';
            roleBadge.style.display = 'inline-block';
          } else {
            roleBadge.style.display = 'none';
          }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        const status = user.status || 'active';
        const statusBadge = document.getElementById('status-badge');
        statusBadge.textContent = status === 'inactive' ? 'ç„¡åŠ¹' : 'æœ‰åŠ¹';
        statusBadge.className = `status-badge status-${status}`;

        // è©³ç´°æƒ…å ±
        document.getElementById('user-id').textContent = user.id || '-';
        document.getElementById('info-name').textContent = user.name || '-';
        const emailLink = document.getElementById('info-email');
        emailLink.textContent = user.email || '-';
        emailLink.href = user.email ? `mailto:${user.email}` : '#';
        document.getElementById('info-phone').textContent = user.phone || '-';
        document.getElementById('info-role').textContent = roleLabel;
        document.getElementById('info-department').textContent = user.department || '-';
        // æ‹…å½“æ¥­å‹™ã‚’è¡¨ç¤ºï¼ˆã€Œãƒ»ã€ã§åŒºåˆ‡ã‚‰ã‚ŒãŸè¤‡æ•°ã®æ¥­å‹™ã‚’è¡¨ç¤ºï¼‰
        const jobInfo = user.job || '';
        if (jobInfo) {
          const jobs = jobInfo.split('ãƒ»').map(j => j.trim()).filter(j => j);
          document.getElementById('info-job').textContent = jobs.join('ã€');
        } else {
          document.getElementById('info-job').textContent = '-';
        }
        document.getElementById('info-status').textContent = status === 'inactive' ? 'ç„¡åŠ¹' : 'æœ‰åŠ¹';
        document.getElementById('info-created-at').textContent = formatDate(user.created_at);

        // è¨€èªè¡¨ç¤º
        const langLabels = { 'ja': 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª', 'pt': 'ğŸ‡§ğŸ‡· PortuguÃªs', 'en': 'ğŸ‡ºğŸ‡¸ English' };
        document.getElementById('info-language').textContent = langLabels[user.language] || 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª';

        // äººæDBæƒ…å ±ã®è¡¨ç¤º
        renderHRData(user);

        // ç·¨é›†ãƒœã‚¿ãƒ³
        document.getElementById('edit-btn').style.display = 'inline-flex';

        // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        document.getElementById('email-btn').href = user.email ? `mailto:${user.email}` : '#';

        // ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ - è¡¨ç¤ºä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼‰
        const mypageBtn = document.getElementById('mypage-btn');
        if (mypageBtn && user.id) {
          mypageBtn.href = `/staff/mypage.html?id=${encodeURIComponent(user.id)}`;
          mypageBtn.style.display = 'flex';
        } else if (mypageBtn && user.email && user.email !== '-') {
          mypageBtn.href = `/staff/mypage.html?email=${encodeURIComponent(user.email)}`;
          mypageBtn.style.display = 'flex';
        }
      }

      function renderHRData(user) {
        // é›‡ç”¨æƒ…å ±
        document.getElementById('hr-hire-date').textContent = formatDate(user.hire_date) || '-';
        const empTypes = { 'full_time': 'æ­£ç¤¾å“¡', 'part_time': 'ãƒ‘ãƒ¼ãƒˆ', 'contract': 'å¥‘ç´„ç¤¾å“¡', 'temporary': 'æ´¾é£' };
        document.getElementById('hr-employment-type').textContent = empTypes[user.employment_type] || user.employment_type || '-';
        document.getElementById('hr-contract-period').textContent = user.contract_period || '-';

        const startTime = user.scheduled_start_time || '09:00';
        const endTime = user.scheduled_end_time || '18:00';
        document.getElementById('hr-work-schedule').textContent = `${startTime} ã€œ ${endTime}`;

        // ã‚¹ã‚­ãƒ«ãƒ»è³‡æ ¼
        document.getElementById('hr-certifications').textContent = user.certifications || '-';
        document.getElementById('hr-skills').textContent = user.skills || '-';
        document.getElementById('hr-experience-years').textContent = user.experience_years ? `${user.experience_years}å¹´` : '-';
        document.getElementById('hr-previous-experience').textContent = user.previous_experience || '-';

        // ç·Šæ€¥é€£çµ¡å…ˆ
        document.getElementById('hr-emergency-name').textContent = user.emergency_contact_name || '-';
        document.getElementById('hr-emergency-phone').textContent = user.emergency_contact_phone || '-';
        document.getElementById('hr-emergency-relation').textContent = user.emergency_contact_relation || '-';
        document.getElementById('hr-address').textContent = user.address || '-';

        // çµ¦ä¸ãƒ»è©•ä¾¡
        if (user.salary) {
          const salaryFormatted = new Intl.NumberFormat('ja-JP').format(user.salary);
          document.getElementById('hr-salary').textContent = `Â¥${salaryFormatted}`;
        } else {
          document.getElementById('hr-salary').textContent = '-';
        }
        const salaryTypes = { 'hourly': 'æ™‚çµ¦', 'monthly': 'æœˆçµ¦', 'annual': 'å¹´ä¿¸' };
        document.getElementById('hr-salary-type').textContent = salaryTypes[user.salary_type] || user.salary_type || '-';

        const evalLabels = { 'S': 'â­ Sè©•ä¾¡', 'A': 'ğŸŒŸ Aè©•ä¾¡', 'B': 'âœ¨ Bè©•ä¾¡', 'C': 'ğŸ“‹ Cè©•ä¾¡', 'D': 'ğŸ“ Dè©•ä¾¡' };
        document.getElementById('hr-evaluation').textContent = evalLabels[user.evaluation] || user.evaluation || '-';
        document.getElementById('hr-notes').textContent = user.hr_notes || '-';
      }

      function openHREditModal() {
        alert('äººæDBç·¨é›†æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
        // TODO: Implement HR edit modal
      }

      function getRoleColor(role) {
        const colors = {
          staff: '#f59e0b',
          sales: '#10b981',
          admin: '#ec4899',
          other: '#64748b'
        };
        return colors[role] || '#64748b';
      }

      function renderDailyReports(reports) {
        const listEl = document.getElementById('daily-reports-list');
        const loadingEl = document.getElementById('daily-reports-loading');
        const emptyEl = document.getElementById('daily-reports-empty');
        if (!listEl || !loadingEl || !emptyEl) return;

        loadingEl.style.display = 'none';

        if (!reports || reports.length === 0) {
          emptyEl.style.display = 'block';
          listEl.innerHTML = '';
          return;
        }

        emptyEl.style.display = 'none';

        const rows = reports.map(report => {
          const date = report.date || report.created_at || '';
          const dateLabel = date ? formatDate(date) : '-';
          const content = report.content || report.text || '';
          const safeContent = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `
          <div class="daily-report-item" style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
            <div class="muted small" style="margin-bottom: 6px;">${dateLabel}</div>
            <div style="white-space: pre-wrap; line-height: 1.6;">${safeContent || '-'}</div>
          </div>
        `;
        }).join('');

        listEl.innerHTML = rows;
      }

      async function loadDailyReportsForUser() {
        const loadingEl = document.getElementById('daily-reports-loading');
        const emptyEl = document.getElementById('daily-reports-empty');
        if (loadingEl) loadingEl.style.display = 'block';
        if (emptyEl) emptyEl.style.display = 'none';

        if (!currentUser || !currentUser.id) {
          renderDailyReports([]);
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/daily-reports?staff_id=${encodeURIComponent(currentUser.id)}`, {
            method: 'GET',
            headers: buildAuthHeaders(),
            cache: 'no-store'
          });

          if (response.ok) {
            const data = await response.json();
            const reports = data.items || data.reports || (Array.isArray(data) ? data : []);
            renderDailyReports(reports);
            return;
          }

          renderDailyReports([]);
        } catch (error) {
          console.error('Error loading daily reports:', error);
          renderDailyReports([]);
        }
      }

      // å‡ºé€€å‹¤è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰æ©Ÿèƒ½ã«çµ±åˆã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯ç©ºã«ï¼‰
      function loadAttendanceRecords() {
        // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰æ©Ÿèƒ½ã§å‡ºé€€å‹¤è¨˜éŒ²ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ã“ã®é–¢æ•°ã¯ä¸è¦
        // ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€ç©ºã®é–¢æ•°ã¨ã—ã¦æ®‹ã™
      }

      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç¾çŠ¶ã¯å€‹äººãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚è¨±å¯ï¼‰
      function validateEmail(email) {
        if (!email) {
          return { valid: false, message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™ã€‚' };
        }

        // åŸºæœ¬çš„ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã®ãƒã‚§ãƒƒã‚¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          return {
            valid: false,
            message: 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
          };
        }

        // ç¾çŠ¶ã¯å€‹äººãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚è¨±å¯
        // å°†æ¥çš„ã«ã¯ä¼æ¥­ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ@misesapo.appï¼‰ã¸ã®ç§»è¡Œã‚’æ¨å¥¨
        return { valid: true };
      }

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      function openEditModal() {
        if (!currentUser) return;

        // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
        document.getElementById('edit-name').value = currentUser.name || '';
        document.getElementById('edit-email').value = currentUser.email || '';
        document.getElementById('edit-phone').value = currentUser.phone || '';
        // ãƒ­ãƒ¼ãƒ«ã¯ã€Œç®¡ç†è€…ã€ã‹ã€Œãªã—ã€ã®2ç¨®é¡ã®ã¿
        document.getElementById('edit-role').value = (currentUser.role === 'admin') ? 'admin' : 'staff';
        document.getElementById('edit-department').value = currentUser.department || '';
        document.getElementById('edit-job').value = currentUser.job || '';
        document.getElementById('edit-status').value = currentUser.status || 'active';
        document.getElementById('edit-scheduled-start-time').value = currentUser.scheduled_start_time || '09:00';
        document.getElementById('edit-scheduled-end-time').value = currentUser.scheduled_end_time || '18:00';
        document.getElementById('edit-scheduled-work-hours').value = currentUser.scheduled_work_hours || 8.0;
        document.getElementById('edit-form-status').textContent = '';
        document.getElementById('edit-form-status').className = 'form-status';

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('edit-modal').style.display = 'flex';
      }

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
      }

      // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ï¼ˆDOMContentLoadedå†…ã§å®Ÿè¡Œï¼‰
      function setupEditForm() {
        const editForm = document.getElementById('edit-form');
        if (!editForm) {
          console.warn('Edit form not found');
          return;
        }

        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!currentUser) return;

          const statusEl = document.getElementById('edit-form-status');
          statusEl.textContent = 'ä¿å­˜ä¸­...';
          statusEl.className = 'form-status';

          // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          const email = document.getElementById('edit-email').value;
          const emailValidation = validateEmail(email);

          if (!emailValidation.valid) {
            statusEl.textContent = emailValidation.message;
            statusEl.className = 'form-status error';
            return;
          }

          const data = {
            name: document.getElementById('edit-name').value,
            email: email,
            phone: document.getElementById('edit-phone').value,
            role: document.getElementById('edit-role').value,
            department: document.getElementById('edit-department').value,
            job: document.getElementById('edit-job').value,  // æ‹…å½“æ¥­å‹™ã‚’è¿½åŠ 
            status: document.getElementById('edit-status').value,
            scheduled_start_time: document.getElementById('edit-scheduled-start-time').value,
            scheduled_end_time: document.getElementById('edit-scheduled-end-time').value,
            scheduled_work_hours: parseFloat(document.getElementById('edit-scheduled-work-hours').value) || 8.0
          };

          // ãƒ­ãƒ¼ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šï¼ˆç®¡ç†è€…=1ã€ãã‚Œä»¥å¤–=4ï¼‰
          data.role_code = (data.role === 'admin') ? '1' : '4';

          try {
            const response = await fetch(`${API_BASE}/workers/${currentUser.id}`, {
              method: 'PUT',
              headers: buildAuthHeaders(true),
              body: JSON.stringify(data)
            });

            if (response.ok) {
              statusEl.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
              statusEl.className = 'form-status success';

              // ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹éš›ã«ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
              sessionStorage.setItem('users_list_needs_reload', 'true');
              sessionStorage.setItem('users_list_updated_user_id', currentUser.id);

              // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼‰
              setTimeout(async () => {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
                currentUser = null;
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ï¼ˆDynamoDBã®åæ˜ ã‚’å¾…ã¤ï¼‰
                await new Promise(resolve => setTimeout(resolve, 300));
                await loadUser();
                closeEditModal();
              }, 500);
            } else {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || errorData.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.error('Error updating user:', error);
            statusEl.textContent = error.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
            statusEl.className = 'form-status error';
          }
        });
      }

      // å‡ºé€€å‹¤ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰æ©Ÿèƒ½ã«çµ±åˆã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯ç©ºã«ï¼‰
      function setupAttendanceButton() {
        // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰æ©Ÿèƒ½ã§å‡ºé€€å‹¤è¨˜éŒ²ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ã“ã®é–¢æ•°ã¯ä¸è¦
        // ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€ç©ºã®é–¢æ•°ã¨ã—ã¦æ®‹ã™
      }

      // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
      async function loadTimecard() {
        if (!currentUser) return;

        try {
          const year = currentYear;
          const month = String(currentMonth + 1).padStart(2, '0');

          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const response = await fetch(`${API_BASE}/attendance?staff_id=${currentUser.id}&year=${year}&month=${month}&limit=1000&_t=${Date.now()}`, {
            cache: 'no-cache'
          });
          if (!response.ok) {
            throw new Error('ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          const data = await response.json();
          // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ã«å¯¾å¿œï¼ˆé…åˆ—ã€itemsã€attendanceï¼‰
          let rawAttendance = [];
          if (Array.isArray(data)) {
            rawAttendance = data;
          } else if (data.items && Array.isArray(data.items)) {
            rawAttendance = data.items;
          } else if (data.attendance && Array.isArray(data.attendance)) {
            rawAttendance = data.attendance;
          }

          // åŒã˜æ—¥ä»˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã€æœ€æ–°ã®ã‚‚ã®ã‚’å„ªå…ˆï¼ˆupdated_atã¾ãŸã¯created_atã§ã‚½ãƒ¼ãƒˆï¼‰
          const attendanceByDate = {};
          rawAttendance.forEach(record => {
            if (!record.date) return;
            const date = record.date;
            if (!attendanceByDate[date]) {
              attendanceByDate[date] = record;
            } else {
              // æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒã—ã¦ã€ã‚ˆã‚Šæ–°ã—ã„ã‚‚ã®ã‚’é¸æŠ
              const existing = attendanceByDate[date];
              const existingTime = existing.updated_at || existing.created_at || '';
              const newTime = record.updated_at || record.created_at || '';
              if (newTime > existingTime) {
                attendanceByDate[date] = record;
              }
            }
          });

          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã«å¤‰æ›
          monthlyAttendance = Object.values(attendanceByDate);

          // ç·¨é›†ç”³è«‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
          await loadAttendanceRequests();

          renderTimecard();
          renderMonthlySummary();
        } catch (error) {
          console.error('Error loading timecard:', error);
          monthlyAttendance = [];
          attendanceRequests = [];
          renderTimecard();
          renderMonthlySummary();
        }
      }

      // ç·¨é›†ç”³è«‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      async function loadAttendanceRequests() {
        if (!currentUser) return;

        try {
          const response = await fetch(`${API_BASE}/attendance/requests?staff_id=${currentUser.id}&limit=1000`);

          if (response.ok) {
            const data = await response.json();
            attendanceRequests = data.requests || [];
          } else {
            console.warn('[UserDetail] Failed to load attendance requests:', response.status, response.statusText);
            attendanceRequests = [];
          }
        } catch (error) {
          console.error('[UserDetail] Error loading attendance requests:', error);
          attendanceRequests = [];
        }
      }

      // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆæ°´å¹³æ–¹å‘ï¼‰
      function renderTimecard() {
        const thead = document.getElementById('timecard-thead');
        const tbody = document.getElementById('timecard-tbody');
        if (!thead || !tbody) return;

        // æœˆã®æ—¥æ•°ã‚’å–å¾—
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

        // å‡ºé€€å‹¤è¨˜éŒ²ã‚’æ—¥ä»˜ã§ãƒãƒƒãƒ—
        const attendanceMap = {};
        monthlyAttendance.forEach(record => {
          if (record.date) {
            attendanceMap[record.date] = record;
          }
        });

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç”Ÿæˆ
        let headerHtml = '<tr><th>é …ç›®</th>';
        const todayStr = new Date().toISOString().split('T')[0];

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(currentYear, currentMonth, day);
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const weekday = weekdays[date.getDay()];
          const isToday = dateStr === todayStr;
          const headerClass = isToday ? 'today-column' : '';
          headerHtml += `<th class="${headerClass}">${day}æ—¥<br><span style="font-size: 0.75rem; font-weight: normal; color: #6b7280;">${weekday}</span></th>`;
        }
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;

        // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ç”Ÿæˆ
        const rows = [
          { label: 'å‡ºå‹¤', key: 'clockIn' },
          { label: 'é€€å‹¤', key: 'clockOut' },
          { label: 'ä¼‘æ†©', key: 'breakTime' },
          { label: 'å®ŸåŠ´åƒ', key: 'workHours' },
          { label: 'æ®‹æ¥­', key: 'overtime' },
          { label: 'çŠ¶æ…‹', key: 'status' }
        ];

        let bodyHtml = '';
        rows.forEach(row => {
          bodyHtml += `<tr><td style="font-weight: 600;">${row.label}</td>`;

          for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            let record = attendanceMap[dateStr];
            const isToday = dateStr === todayStr;
            const cellClass = isToday ? 'today-column' : '';

            let cellValue = '-';

            // ç”³è«‹ä¸­ã¾ãŸã¯æ‰¿èªæ¸ˆã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèªï¼ˆç”³è«‹å†…å®¹ã‚’å„ªå…ˆçš„ã«è¡¨ç¤ºï¼‰
            const request = attendanceRequests.find(r => r.date === dateStr && r.staff_id === currentUser?.id && (r.status === 'pending' || r.status === 'approved'));

            // ç”³è«‹ä¸­ã¾ãŸã¯æ‰¿èªæ¸ˆã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã€ç”³è«‹å†…å®¹ã‚’ä»®æƒ³çš„ãªrecordã¨ã—ã¦ä½¿ç”¨
            if (request) {
              // requested_break_hoursã¯æ™‚é–“å˜ä½ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
              let breakTime = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“
              if (request.requested_break_hours !== undefined && request.requested_break_hours !== null) {
                const requestedBreakHours = toNumber(request.requested_break_hours);
                breakTime = requestedBreakHours > 0 ? requestedBreakHours : 1;
              } else if (record?.break_time !== undefined && record?.break_time !== null) {
                const recordBreakTime = toNumber(record.break_time);
                breakTime = recordBreakTime > 0 ? recordBreakTime : 1;
              }

              record = {
                clock_in: request.requested_clock_in || record?.clock_in,
                clock_out: request.requested_clock_out || record?.clock_out,
                break_time: breakTime,
                work_hours: null, // ç”³è«‹ä¸­/æ‰¿èªæ¸ˆã¿ã¯è¨ˆç®—ã—ãªã„
                overtime_hours: null, // ç”³è«‹ä¸­/æ‰¿èªæ¸ˆã¿ã¯è¨ˆç®—ã—ãªã„
                status: record?.status,
                is_late: record?.is_late,
                is_early_leave: record?.is_early_leave,
                late_minutes: record?.late_minutes,
                early_leave_minutes: record?.early_leave_minutes,
                breaks: record?.breaks
              };
            } else if (record && (record.break_time === undefined || record.break_time === null || toNumber(record.break_time) === 0)) {
              // ç”³è«‹ä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªãã€æ—¢å­˜ã®è¨˜éŒ²ã®ä¼‘æ†©æ™‚é–“ãŒ0ã¾ãŸã¯æœªè¨­å®šã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1æ™‚é–“ã‚’è¨­å®š
              record = {
                ...record,
                break_time: 1
              };
            }

            if (record) {
              switch (row.key) {
                case 'clockIn':
                  cellValue = record.clock_in ? formatTime(record.clock_in) : '-';
                  break;
                case 'clockOut':
                  if (record.clock_out) {
                    cellValue = formatTime(record.clock_out);
                  } else {
                    cellValue = '-';
                  }
                  break;
                case 'breakTime':
                  // break_timeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ï¼ˆ0ã®å ´åˆã‚‚å«ã‚€ï¼‰
                  if (record.break_time !== undefined && record.break_time !== null) {
                    const breakHours = toNumber(record.break_time);
                    cellValue = formatHours(breakHours);
                  } else if (record.breaks && record.breaks.length > 0) {
                    const breakHours = calculateTotalBreakTime(record.breaks);
                    cellValue = breakHours > 0 ? formatHours(breakHours) : '-';
                  } else {
                    cellValue = '-';
                  }
                  break;
                case 'workHours':
                  // å‡ºå‹¤æ™‚åˆ»ã¨é€€å‹¤æ™‚åˆ»ãŒã‚ã‚‹å ´åˆã€ãã®å·®ã‹ã‚‰ä¼‘æ†©æ™‚é–“ã‚’å¼•ã„ã¦è¨ˆç®—
                  if (record.clock_in && record.clock_out) {
                    const hours = calculateWorkHours(record);
                    cellValue = formatHours(hours);
                  } else if (record.work_hours) {
                    // work_hoursãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                    const hours = toNumber(record.work_hours);
                    cellValue = formatHours(hours);
                  } else {
                    cellValue = '-';
                  }
                  break;
                case 'overtime':
                  // å®ŸåŠ´åƒæ™‚é–“ãŒ8æ™‚é–“ã‚’è¶…ãˆãŸåˆ†ã‚’æ®‹æ¥­æ™‚é–“ã¨ã—ã¦è¨ˆç®—
                  if (record.clock_in && record.clock_out) {
                    const workHours = calculateWorkHours(record);
                    const overtimeHours = Math.max(0, workHours - 8); // 8æ™‚é–“ã‚’è¶…ãˆãŸåˆ†
                    if (overtimeHours > 0) {
                      cellValue = formatHours(overtimeHours);
                    } else {
                      cellValue = '-';
                    }
                  } else if (record.overtime_hours) {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: overtime_hoursãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    const hours = toNumber(record.overtime_hours);
                    cellValue = formatHours(hours);
                  } else {
                    cellValue = '-';
                  }
                  break;
                case 'status':
                  // ç”³è«‹ä¸­ã¾ãŸã¯æ‰¿èªæ¸ˆã¿ã®å ´åˆã¯ç”³è«‹å†…å®¹ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
                  if (request) {
                    if (record.clock_in && !record.clock_out) {
                      cellValue = '<span class="status-badge-timecard status-working">å‹¤å‹™ä¸­</span>';
                    } else if (record.clock_in && record.clock_out) {
                      cellValue = '<span class="status-badge-timecard status-completed">å®Œäº†</span>';
                    } else {
                      cellValue = '<span class="status-badge-timecard status-absent">æœªå‡ºå‹¤</span>';
                    }
                  } else {
                    // ãƒã‚¤ãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯: clock_inã¨clock_outã§åˆ¤å®š
                    if (record.clock_in && !record.clock_out) {
                      // å‡ºå‹¤ä¸­
                      cellValue = '<span class="status-badge-timecard status-working">å‹¤å‹™ä¸­</span>';
                    } else if (record.clock_in && record.clock_out) {
                      // é€€å‹¤æ¸ˆã¿ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ï¼‰
                      if (record.status === 'completed') {
                        if (record.is_late && record.is_early_leave) {
                          cellValue = '<span class="status-badge-timecard status-late">é…åˆ»ãƒ»æ—©é€€</span>';
                        } else if (record.is_late) {
                          cellValue = `<span class="status-badge-timecard status-late">é…åˆ» ${record.late_minutes || 0}åˆ†</span>`;
                        } else if (record.is_early_leave) {
                          cellValue = `<span class="status-badge-timecard status-early-leave">æ—©é€€ ${record.early_leave_minutes || 0}åˆ†</span>`;
                        } else {
                          cellValue = '<span class="status-badge-timecard status-completed">å®Œäº†</span>';
                        }
                      } else {
                        cellValue = '<span class="status-badge-timecard status-completed">å®Œäº†</span>';
                      }
                    } else {
                      // æœªå‡ºå‹¤
                      cellValue = '<span class="status-badge-timecard status-absent">æœªå‡ºå‹¤</span>';
                    }
                  }
                  break;
              }
            } else if (row.key === 'status') {
              cellValue = '<span class="status-badge-timecard status-absent">æœªå‡ºå‹¤</span>';
            }

            bodyHtml += `<td class="${cellClass}">${cellValue}</td>`;
          }

          bodyHtml += '</tr>';
        });

        tbody.innerHTML = bodyHtml;

        // æœˆè¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('month-display').textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
      }

      // æœˆé–“ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
      function renderMonthlySummary() {
        let workDays = 0;
        let totalHours = 0;
        let overtimeHours = 0;
        let lateCount = 0;

        // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§çµ±è¨ˆã‚’è¨ˆç®—
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // å‡ºé€€å‹¤è¨˜éŒ²ã‚’æ—¥ä»˜ã§ãƒãƒƒãƒ—
        const attendanceMap = {};
        monthlyAttendance.forEach(record => {
          if (record.date) {
            attendanceMap[record.date] = record;
          }
        });

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          let record = attendanceMap[dateStr];

          // ç”³è«‹ä¸­ã¾ãŸã¯æ‰¿èªæ¸ˆã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèªï¼ˆç”³è«‹å†…å®¹ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ï¼‰
          const request = attendanceRequests.find(r => r.date === dateStr && r.staff_id === currentUser?.id && (r.status === 'pending' || r.status === 'approved'));

          // ç”³è«‹ä¸­ã¾ãŸã¯æ‰¿èªæ¸ˆã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã€ç”³è«‹å†…å®¹ã‚’ä»®æƒ³çš„ãªrecordã¨ã—ã¦ä½¿ç”¨
          if (request) {
            let breakTime = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“
            if (request.requested_break_hours !== undefined && request.requested_break_hours !== null) {
              const requestedBreakHours = toNumber(request.requested_break_hours);
              breakTime = requestedBreakHours > 0 ? requestedBreakHours : 1;
            } else if (record?.break_time !== undefined && record?.break_time !== null) {
              const recordBreakTime = toNumber(record.break_time);
              breakTime = recordBreakTime > 0 ? recordBreakTime : 1;
            }

            record = {
              clock_in: request.requested_clock_in || record?.clock_in,
              clock_out: request.requested_clock_out || record?.clock_out,
              break_time: breakTime,
              status: record?.status,
              is_late: record?.is_late,
              breaks: record?.breaks
            };
          } else if (record && (record.break_time === undefined || record.break_time === null || toNumber(record.break_time) === 0)) {
            record = {
              ...record,
              break_time: 1
            };
          }

          // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§å®ŸåŠ´åƒæ™‚é–“ã¨æ®‹æ¥­æ™‚é–“ã‚’è¨ˆç®—
          if (record && record.clock_in && record.clock_out) {
            workDays++;

            // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§å®ŸåŠ´åƒæ™‚é–“ã‚’è¨ˆç®—
            const workHours = calculateWorkHours(record);
            totalHours += workHours;

            // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§æ®‹æ¥­æ™‚é–“ã‚’è¨ˆç®—ï¼ˆ8æ™‚é–“ã‚’è¶…ãˆãŸåˆ†ï¼‰
            const overtime = Math.max(0, workHours - 8);
            overtimeHours += overtime;

            // é…åˆ»ã‚«ã‚¦ãƒ³ãƒˆ
            if (record.is_late) {
              lateCount++;
            }
          }
        }

        document.getElementById('summary-work-days').textContent = `${workDays}æ—¥`;
        document.getElementById('summary-total-hours').textContent = `${Number(totalHours).toFixed(1)}h`;
        document.getElementById('summary-overtime-hours').textContent = `${Number(overtimeHours).toFixed(1)}h`;
        document.getElementById('summary-late-count').textContent = `${lateCount}å›`;
      }

      // æœˆç§»å‹•
      function setupMonthNavigation() {
        const prevBtn = document.getElementById('prev-month-btn');
        const nextBtn = document.getElementById('next-month-btn');

        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
              currentMonth = 11;
              currentYear--;
            }
            loadTimecard();
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
              currentMonth = 0;
              currentYear++;
            }
            loadTimecard();
          });
        }
      }

      // åˆæœŸåŒ–
      document.addEventListener('DOMContentLoaded', () => {
        loadUser();
        setupEditForm();
        setupAttendanceButton();
        setupMonthNavigation();
        initSidebar();

        const refreshBtn = document.getElementById('daily-report-refresh-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            loadDailyReportsForUser();
          });
        }

      });

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®åˆæœŸåŒ–ï¼ˆå…±é€šã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å€‹åˆ¥ã®åˆæœŸåŒ–ã¯ä¸è¦ï¼‰
      function initSidebar() {
        // å…±é€šã‚µã‚¤ãƒ‰ãƒãƒ¼ã®JavaScriptãŒå‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
      }
    </script>
</main>