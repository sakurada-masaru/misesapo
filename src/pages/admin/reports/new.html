@layout('layouts.admin')
@json('data/meta/admin_reports_new_title.json', $title)
@json('data/meta/admin_reports_new_body_class.json', $body_class)

<style>
  #default-header-wrapper,
  #normal-header-wrapper {
    display: none !important;
  }

  /* Admin layout adjustments for report page */
  .admin-reports-v2 {
    display: flex;
    min-height: 100vh;
  }

  .admin-reports-v2 .main-content {
    flex: 1;
    background: #f8fafc;
  }

  .staff-report-page {
    padding-bottom: 220px;
    position: relative;
  }

  .page-header-fixed {
    position: sticky;
    top: 0;
    z-index: 1100;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
  }
</style>

<script src="/js/data_utils.js"></script>
<link rel="stylesheet" href="/css/staff-report-new.css">
<link rel="stylesheet" href="/css/report-shared-view.css">
<link rel="stylesheet" href="/css/report-assistant.css">

<main id="main" class="admin-reports-v2">
  @include('partials.admin-sidebar')

  <div class="main-content">
    <div class="staff-report-page">
      <!-- 固定ヘッダー (Admin用) -->
      <header class="page-header-fixed">
        <a href="/admin/reports" class="back-btn"
          style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #e5e7eb; background: #ffffff; color: #111827; font-size: 1.25rem; text-decoration: none;">
          <i class="fas fa-chevron-left"></i>
        </a>
        <div class="report-top-actions" style="flex: 1; padding: 0; justify-content: flex-end;">
          <button type="button" class="details-btn is-prominent" id="details-btn" aria-label="詳細パネルを開く">
            <i class="fas fa-info-circle"></i>
            <span class="details-btn-text">詳細パネル</span>
          </button>
        </div>
      </header>

      <!-- タブナビゲーション -->
      <div class="tabs-navigation">
        <button type="button" class="tab-btn active" data-tab="new" id="tab-new">
          <i class="fas fa-plus-circle"></i>
          <span>新規作成</span>
        </button>
        <button type="button" class="tab-btn" data-tab="proposal" id="tab-proposal">
          <i class="fas fa-lightbulb"></i>
          <span>次回ご提案</span>
        </button>
      </div>

      <!-- サイドパネルオーバーレイ -->
      <div class="side-panel-overlay" id="side-panel-overlay"></div>

      <!-- サイドパネル（詳細情報） -->
      <div class="side-panel" id="side-panel">
        <div class="side-panel-header">
          <h2 class="side-panel-title">詳細情報</h2>
          <button type="button" class="side-panel-close" id="side-panel-close" aria-label="パネルを閉じる">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="side-panel-content">
          <!-- レポートヘッダーセクション（新規作成・次回ご提案で共用） -->
          <div class="report-header-section" id="shared-report-header" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label class="date-time-label" for="report-schedule-select">スケジュール</label>
                <select id="report-schedule-select" class="form-select">
                  <option value="">未作成のスケジュールを選択</option>
                </select>
                <input type="hidden" id="report-schedule-id" name="schedule_id">
              </div>
            </div>
            <div class="form-row two-col">
              <div class="form-group store-search-group">
                <div class="store-search-wrapper">
                  <div class="input-with-dropdown">
                    <input type="text" id="report-brand-search" class="form-input" placeholder="①ブランド名 *"
                      autocomplete="off" readonly>
                    <button type="button" class="dropdown-arrow-btn" id="brand-dropdown-btn" aria-label="ドロップダウンを開く">
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <select id="report-brand-select" class="form-select" name="brand_id" style="display: none;">
                      <option value="">①ブランド名 *</option>
                    </select>
                  </div>
                  <input type="hidden" id="report-brand" name="brand_id">
                  <input type="hidden" id="report-brand-name" name="brand_name">
                  <div id="brand-search-results" class="store-search-results" style="display: none;"></div>
                </div>
              </div>
              <div class="form-group store-search-group">
                <div class="store-search-wrapper">
                  <div class="input-with-dropdown">
                    <input type="text" id="report-store-search" class="form-input" placeholder="②店舗名 *"
                      autocomplete="off" readonly>
                    <button type="button" class="dropdown-arrow-btn" id="store-dropdown-btn" aria-label="ドロップダウンを開く">
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <select id="report-store-select" class="form-select" name="store_id" style="display: none;">
                      <option value="">②店舗名 *</option>
                    </select>
                  </div>
                  <input type="hidden" id="report-store" name="store_id">
                  <input type="hidden" id="report-store-name" name="store_name">
                  <div id="store-search-results" class="store-search-results" style="display: none;"></div>
                </div>
              </div>
            </div>
            <div class="form-row three-col date-time-row">
              <div class="form-group date-time-group">
                <label class="date-time-label" for="report-date">日付</label>
                <div class="date-time-input-wrapper" data-placeholder="日付">
                  <input type="date" id="report-date" name="cleaning_date" class="form-input date-time-input" required>
                </div>
              </div>
              <div class="form-group date-time-group">
                <label class="date-time-label" for="report-start">開始</label>
                <div class="date-time-input-wrapper" data-placeholder="開始時間">
                  <input type="time" id="report-start" name="cleaning_start_time" class="form-input date-time-input">
                </div>
              </div>
              <div class="form-group date-time-group">
                <label class="date-time-label" for="report-end">終了</label>
                <div class="date-time-input-wrapper" data-placeholder="終了時刻">
                  <input type="time" id="report-end" name="cleaning_end_time" class="form-input date-time-input"
                    placeholder="終了時刻">
                </div>
              </div>
            </div>
            <div class="form-row" id="karte-reference-row" style="margin-top: 12px; display: none;">
              <button type="button" class="btn btn-outline btn-block" id="btn-view-karte"
                style="border-color: #ff679c; color: #ff679c;">
                <i class="fas fa-history"></i>
                この店舗の過去のレポート（カルテ）を見る
              </button>
            </div>

            <!-- HACCP Additional Info -->
            <div class="form-row two-col haccp-info-row"
              style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #eee;">
              <div class="form-group">
                <label class="date-time-label" for="report-weather">天候 (任意)</label>
                <input type="text" id="report-weather" class="form-input" placeholder="例: 晴れ">
              </div>
              <div class="form-group">
                <label class="date-time-label">作業区分</label>
                <div class="radio-group" style="display: flex; gap: 12px; margin-top: 8px; font-size: 0.9rem;">
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio"
                      name="work_type" value="regular" checked> 定期</label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio"
                      name="work_type" value="temporary"> 臨時</label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="radio"
                      name="work_type" value="correction"> 是正</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Request Sheet (Work Instructions) -->
          <div class="request-sheet-section"
            style="margin-top: 20px; padding-top: 16px; border-top: 2px solid #ec4899;">
            <h3 style="font-size: 1rem; color: #ec4899; margin-bottom: 12px; font-weight: 700;">
              <i class="fas fa-clipboard-list"></i> 作業依頼書 / 詳細
            </h3>
            <div id="request-sheet-content"
              style="background: #fdf2f8; padding: 12px; border-radius: 8px; font-size: 0.9rem;">
              <p style="color: #6b7280;">スケジュールを選択すると、ここに作業依頼内容が表示されます。</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 新規作成タブ -->
      <div id="tab-content-new" class="tab-content active">

        <!-- HACCP Toggle Section -->
        <div style="padding: 70px 16px 0;">
          <button type="button" id="haccp-toggle-btn" class="haccp-toggle-btn" style="
            width: 100%;
            padding: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            cursor: pointer;
          ">
            <span><i class="fas fa-clipboard-check" style="color: #3b82f6; margin-right: 8px;"></i> HACCP 清掃実施記録 (様式
              1-3)</span>
            <i class="fas fa-chevron-down" id="haccp-toggle-icon"></i>
          </button>

          <div id="haccp-form-container" style="
            display: none;
            margin-top: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
          ">
            <div class="loading-spinner" style="text-align: center; padding: 20px; color: #6b7280;">
              <i class="fas fa-spinner fa-spin"></i> 読み込み中...
            </div>
          </div>
        </div>

        <form id="report-form" class="report-form">
          <!-- コンテンツエリア -->
          <div class="report-content" id="report-content">
            <!-- セクション追加アイコンエリア -->
            <div class="section-add-icons-area" id="section-add-icons-area">
              <div class="section-add-hint" id="section-add-hint">
                <span>↓セクションを追加↓</span>
              </div>
              <div style="display: flex; gap: 12px; justify-content: center; align-items: center;">
                <button type="button" class="section-add-toggle-btn" id="section-add-toggle-btn" title="空のセクションを追加">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- 追加ボタン（固定フッター） -->
          <div class="add-buttons-footer" id="add-buttons-footer" style="display: none;">
            <button type="button" class="btn-section-select-mode" id="section-select-mode-btn" style="display:none;">
              <i class="fas fa-check-square"></i>
              <span>セクション選択</span>
            </button>
            <button type="button" class="btn-section-copy" id="section-copy-btn" style="display:none;">
              <i class="fas fa-copy"></i>
              <span>コピー</span>
            </button>
            <button type="button" class="btn-section-bulk-delete" id="section-bulk-delete-btn" style="display:none;">
              <i class="fas fa-trash"></i>
              <span>削除</span>
            </button>
          </div>

          <!-- 送信ボタン -->
          <div class="submit-section" style="display: flex; gap: 8px; margin-top: 20px; padding: 0 16px;">
            <button type="button" class="btn-preview" id="formal-preview-btn"
              style="flex: 1; background-color: #6b7280; color: white;">
              <i class="fas fa-eye"></i>
              プレビュー
            </button>
            <button type="submit" class="btn-submit" id="report-submit-btn" style="flex: 2;">
              <i class="fas fa-paper-plane"></i>
              レポートを提出
            </button>
          </div>
        </form>
      </div>

      <!-- 次回ご提案タブ -->
      <div id="tab-content-proposal" class="tab-content">
        <form id="report-form-proposal" class="report-form">
          <!-- コンテンツエリア -->
          <div class="report-content" id="report-content-proposal">
            <!-- セクション追加アイコンエリア -->
            <div class="section-add-icons-area" id="section-add-icons-area-proposal">
              <div class="section-add-hint" id="section-add-hint-proposal">
                <span>↓セクションを追加↓</span>
              </div>
              <div style="display: flex; gap: 12px; justify-content: center; align-items: center;">
                <button type="button" class="section-add-toggle-btn" id="section-add-toggle-btn-proposal"
                  title="空のセクションを追加">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- 追加ボタン（固定フッター） -->
          <div class="add-buttons-footer" id="add-buttons-footer-proposal" style="display: none;">
            <button type="button" class="btn-section-select-mode" id="section-select-mode-btn-proposal"
              style="display:none;">
              <i class="fas fa-check-square"></i>
              <span>セクション選択</span>
            </button>
            <button type="button" class="btn-section-copy" id="section-copy-btn-proposal" style="display:none;">
              <i class="fas fa-copy"></i>
              <span>コピー</span>
            </button>
            <button type="button" class="btn-section-bulk-delete" id="section-bulk-delete-btn-proposal"
              style="display:none;">
              <i class="fas fa-trash"></i>
              <span>削除</span>
            </button>
          </div>

          <!-- 送信ボタン -->
          <div class="submit-section" style="display: flex; gap: 8px; margin-top: 20px; padding: 0 16px;">
            <button type="button" class="btn-preview" id="formal-preview-btn-proposal"
              style="flex: 1; background-color: #6b7280; color: white;">
              <i class="fas fa-eye"></i>
              プレビュー
            </button>
            <button type="submit" class="btn-submit" id="report-submit-btn-proposal" style="flex: 2;">
              <i class="fas fa-paper-plane"></i>
              レポートを提出
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- All Modals (Same as staff version) -->
  <div id="warehouse-dialog" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>画像を選択</h3>
        <button type="button" class="modal-close" onclick="closeWarehouseDialog()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="warehouse-tabs">
          <button type="button" class="tab-btn active" data-tab="stock"><i class="fas fa-box"></i> 画像ストック</button>
          <button type="button" class="tab-btn" data-tab="library"><i class="fas fa-images"></i> 画像倉庫</button>
        </div>
        <div id="tab-stock" class="tab-content active">
          <div class="stock-selection-header" style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
            <label class="btn-upload-stock"
              style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #FF679C; color: #fff; border-radius: 8px; cursor: pointer; border: none;">
              <input type="file" accept="image/*" multiple id="warehouse-stock-file-input" style="display:none;">
              <i class="fas fa-plus"></i><span>画像を追加</span>
            </label>
          </div>
          <div class="stock-selection-grid" id="stock-selection-grid">
            <p class="loading">読み込み中...</p>
          </div>
        </div>
        <div id="tab-library" class="tab-content">
          <div class="library-filters"><input type="date" id="library-date" class="form-input"><select
              id="library-category" class="form-select">
              <option value="">すべて</option>
              <option value="before">作業前</option>
              <option value="after">作業後</option>
              <option value="completed">施工後</option>
            </select></div>
          <div class="library-grid" id="library-grid">
            <p class="loading">読み込み中...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline"
          onclick="closeWarehouseDialog()">キャンセル</button><button type="button" class="btn btn-primary"
          id="save-images-btn"><i class="fas fa-check"></i> 選択を確定</button></div>
    </div>
  </div>

  <!-- Cleaning Item Image Add Modal -->
  <div id="cleaning-item-image-add-modal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;"
    onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content"
      style="max-width:400px; width:90%; background:#fff; border-radius:12px; padding:0; overflow:hidden;"
      onclick="event.stopPropagation()">
      <div class="modal-header"
        style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:1.25rem; font-weight:600; color:#111827;">画像を追加</h3>
        <button type="button" class="modal-close"
          onclick="document.getElementById('cleaning-item-image-add-modal').style.display='none'"
          style="background:transparent; border:none; cursor:pointer; font-size:1.25rem; color:#6b7280; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;"><i
            class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding:24px;">
        <div style="display:flex; flex-direction:column; gap:12px;">
          <button type="button" class="btn-image-source" data-source="media"
            style="padding:16px; background:#f9fafb; border:2px solid #e5e7eb; border-radius:8px; cursor:pointer; text-align:left; transition:all 0.2s;">
            <div style="font-weight:600; color:#111827; margin-bottom:4px;"><i class="fas fa-images"></i> メディアから選択</div>
            <div style="font-size:0.875rem; color:#6b7280;">アップロード済みのメディアから選択</div>
          </button>
          <button type="button" class="btn-image-source" data-source="library"
            style="padding:16px; background:#f9fafb; border:2px solid #e5e7eb; border-radius:8px; cursor:pointer; text-align:left; transition:all 0.2s;">
            <div style="font-weight:600; color:#111827; margin-bottom:4px;"><i class="fas fa-mobile-alt"></i> スマホから写真を選択
            </div>
            <div style="font-size:0.875rem; color:#6b7280;">スマホの写真ライブラリから選択</div>
          </button>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-outline"
          onclick="document.getElementById('cleaning-item-image-add-modal').style.display='none'">キャンセル</button></div>
    </div>
  </div>

  <!-- Media Selection Dialog -->
  <div id="media-selection-dialog" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div class="modal-content"
      style="max-width:90vw; max-height:90vh; width:600px; background:#fff; border-radius:12px; padding:0; overflow:hidden; display:flex; flex-direction:column;"
      onclick="event.stopPropagation()">
      <div class="modal-header"
        style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:1.25rem; font-weight:600; color:#111827;">メディアから選択</h3>
        <button type="button" class="modal-close" onclick="closeMediaSelectionDialog()"
          style="background:transparent; border:none; cursor:pointer; font-size:1.25rem; color:#6b7280; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;"><i
            class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" style="padding:20px; overflow-y:auto; flex:1;">
        <div style="margin-bottom:16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <div style="flex:1; min-width:150px;"><label
              style="display:block; margin-bottom:6px; font-size:0.875rem; font-weight:600; color:#374151;">日付</label><input
              type="date" id="media-selection-date" class="form-input"
              style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:0.875rem;">
          </div>
          <div style="flex:1; min-width:180px;"><label
              style="display:block; margin-bottom:6px; font-size:0.875rem; font-weight:600; color:#374151;">スケジュールID</label><select
              id="media-selection-schedule" class="form-select"
              style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:0.875rem;">
              <option value="">選択してください</option>
            </select></div>
          <div style="flex:1; min-width:160px;"><label
              style="display:block; margin-bottom:6px; font-size:0.875rem; font-weight:600; color:#374151;">サービスID</label><input
              type="text" id="media-selection-service" class="form-input"
              style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:0.875rem;"
              list="media-selection-service-options" placeholder="例: 12"><datalist
              id="media-selection-service-options"></datalist></div>
          <div style="flex:1; min-width:150px;"><label
              style="display:block; margin-bottom:6px; font-size:0.875rem; font-weight:600; color:#374151;">フォルダ</label><select
              id="media-selection-folder" class="form-select"
              style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:0.875rem;">
              <option value="">全てのフォルダ</option>
            </select></div>
          <div style="flex:1; min-width:120px;"><label
              style="display:block; margin-bottom:6px; font-size:0.875rem; font-weight:600; color:#374151;">カテゴリ</label><select
              id="media-selection-category" class="form-select"
              style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:0.875rem;">
              <option value="">全て</option>
              <option value="before">作業前</option>
              <option value="after">作業後</option>
            </select></div>
        </div>
        <div id="media-selection-folder-preview"
          style="font-size:0.85rem; color:#6b7280; background:#f3f4f6; border-radius:8px; padding:10px 12px; border:1px solid #e5e7eb; margin-bottom:16px;">
          フォルダ未設定</div>
        <div id="media-selection-grid"
          style="display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:12px; min-height:200px;">
          <div style="grid-column:1/-1; text-align:center; padding:40px; color:#6b7280;"><i
              class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:12px;"></i>
            <p>読み込み中...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer"
        style="padding:16px 20px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
        <div id="media-selection-info" style="font-size:0.875rem; color:#6b7280;"></div>
        <div style="display:flex; gap:12px;"><button type="button" class="btn btn-outline"
            onclick="closeMediaSelectionDialog()">キャンセル</button><button type="button" class="btn btn-primary"
            id="save-media-selection-btn"><i class="fas fa-check"></i> 選択を確定</button></div>
      </div>
    </div>
  </div>

  <!-- More Modals (Service, Brand, Store, Help, etc.) -->
  <!-- ... existing modal structures from staff version ... -->

  <div id="toast-container" class="toast-container"></div>
  <div id="confirm-dialog" class="confirm-dialog-overlay" style="display: none;">
    <div class="confirm-dialog">
      <div class="confirm-dialog-header">
        <h3 class="confirm-dialog-title" id="confirm-dialog-title">確認</h3>
      </div>
      <div class="confirm-dialog-body">
        <p class="confirm-dialog-message" id="confirm-dialog-message"></p>
      </div>
      <div class="confirm-dialog-footer"><button type="button" class="btn btn-outline"
          id="confirm-dialog-cancel">キャンセル</button><button type="button" class="btn btn-primary"
          id="confirm-dialog-ok">OK</button></div>
    </div>
  </div>

</main>

<script src="/js/report-shared-view.js"></script>
<script type="module" src="/js/modules/report/index.js"></script>