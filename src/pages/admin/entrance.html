@layout('layouts.admin')
@json('data/meta/admin_dashboard_title.json', $title)
@json('data/meta/admin_dashboard_body_class.json', $body_class)

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap');

    #default-header-wrapper,
    #normal-header-wrapper {
        display: none !important;
    }

    /* Override Layout Styles for this specific page */
    .admin-dashboard {
        background-color: #000 !important;
        /* Force black background for the whole area behind content */
    }

    /* Dark Sidebar Overrides for MISOGI Theme */
    #admin-sidebar {
        background-color: transparent !important;
        border-right: none !important;
        position: absolute !important;
        left: 20px !important;
        top: 0 !important;
        height: 100% !important;
        width: 250px !important;
        z-index: 100 !important;
        display: none;
        flex-direction: column;
        justify-content: center;
    }

    #admin-sidebar .sidebar-header,
    #admin-sidebar .sidebar-role,
    #admin-sidebar .sidebar-toggle,
    #admin-sidebar .nav-divider {
        display: none !important;
    }

    #admin-sidebar .nav-item {
        opacity: 0;
        transform: translateX(-20px);
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.03) !important;
        border: 1px solid rgba(255, 255, 255, 0.05) !important;
        border-radius: 12px !important;
        padding: 12px 20px !important;
        transition: all 0.3s ease;
        pointer-events: none;
        display: flex;
        align-items: center;
        gap: 15px;
        text-decoration: none;
    }

    #admin-sidebar .nav-item.show {
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
    }

    #admin-sidebar .nav-item:hover {
        background: rgba(59, 130, 246, 0.1) !important;
        border-color: rgba(59, 130, 246, 0.3) !important;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }

    #admin-sidebar .logo-text,
    #admin-sidebar .nav-label,
    #admin-sidebar .nav-item i {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    #admin-sidebar .nav-item:hover i,
    #admin-sidebar .nav-item:hover .nav-label {
        color: #fff !important;
    }

    #sidebar-toggle {
        display: none !important;
    }

    .main-content {
        padding: 0 !important;
        background-color: #000;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        /* Fill screen height */
    }

    /* MISOGI Styles (Scoped) */
    :root {
        --accent-color: #3b82f6;
        --accent-glow: rgba(59, 130, 246, 0.5);
    }

    /* Visualizer Container */
    .visualizer-container {
        width: 300px;
        height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        cursor: pointer;
        z-index: 10;
    }

    /* Core Pulse */
    .core-circle {
        width: 80px;
        height: 80px;
        background: var(--accent-color);
        border-radius: 50%;
        box-shadow: 0 0 30px var(--accent-glow), 0 0 60px var(--accent-glow);
        position: absolute;
        z-index: 10;
        animation: breathe 4s infinite ease-in-out;
    }

    /* Waves */
    .wave {
        position: absolute;
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        pointer-events: none;
    }

    .wave:nth-child(1) {
        width: 100px;
        height: 100px;
        animation: ripple 3s infinite 0s;
    }

    .wave:nth-child(2) {
        width: 100px;
        height: 100px;
        animation: ripple 3s infinite 1s;
    }

    .wave:nth-child(3) {
        width: 100px;
        height: 100px;
        animation: ripple 3s infinite 2s;
    }

    @keyframes breathe {

        0%,
        100% {
            transform: scale(1);
            opacity: 0.8;
        }

        50% {
            transform: scale(1.1);
            opacity: 1;
            box-shadow: 0 0 50px var(--accent-glow), 0 0 90px var(--accent-glow);
        }
    }

    @keyframes ripple {
        0% {
            width: 80px;
            height: 80px;
            opacity: 0.8;
            border-color: var(--accent-color);
        }

        100% {
            width: 300px;
            height: 300px;
            opacity: 0;
            border-color: transparent;
        }
    }

    .visualizer-container.active .wave {
        animation-duration: 1s;
    }

    .core-circle.active {
        transform: scale(1.3) !important;
        filter: blur(2px);
        background: #fff;
        box-shadow: 0 0 100px var(--accent-color), 0 0 200px var(--accent-color);
        transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Status Text */
    .status-text {
        margin-top: 40px;
        font-weight: 300;
        letter-spacing: 2px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
        font-family: 'Inter', sans-serif;
        animation: text-fade 3s infinite alternate;
    }

    @keyframes text-fade {
        0% {
            opacity: 0.4;
        }

        100% {
            opacity: 0.8;
        }
    }

    /* Rotating Text */
    .circle-text-container {
        position: absolute;
        width: 320px;
        height: 320px;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none;
        z-index: 5;
        --base-scale: 0.45;
        transform: scale(var(--base-scale));
        animation: rotate-circle 30s linear infinite;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0.6;
    }

    .circle-text-container.active {
        --base-scale: 1.1;
        transform: scale(var(--base-scale));
        animation-play-state: paused;
        opacity: 1;
    }

    @keyframes rotate-circle {
        from {
            transform: scale(var(--base-scale, 0.45)) rotate(0deg);
        }

        to {
            transform: scale(var(--base-scale, 0.45)) rotate(360deg);
        }
    }

    #circlePath {
        fill: none;
    }

    .circle-svg text {
        fill: rgba(255, 255, 255, 0.5);
        font-size: 8.5px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 3.5px;
        font-family: 'Inter', sans-serif;
    }

    /* Mode Switcher */
    .mode-switch-container {
        position: absolute;
        /* Relative to main-content */
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        background: rgba(255, 255, 255, 0.05);
        padding: 5px;
        border-radius: 40px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        z-index: 1000;
    }

    .mode-btn {
        border: none;
        background: none;
        color: rgba(255, 255, 255, 0.5);
        padding: 10px 30px;
        border-radius: 35px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.4s;
        white-space: nowrap;
        font-family: 'Inter', sans-serif;
    }

    .mode-btn.active {
        color: #fff;
        background: linear-gradient(135deg, var(--accent-color), #2563eb);
        box-shadow: 0 5px 15px var(--accent-glow);
    }

    /* Chat UI */
    #chat-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding: 40px 100px 100px 100px;
        /* Adjusted padding */
        box-sizing: border-box;
        background: radial-gradient(circle at center, #111 0%, #000 100%);
        display: flex;
        flex-direction: column;
        opacity: 0;
        pointer-events: none;
        transform: translateY(20px);
        transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 500;
    }

    #chat-container.active {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
    }

    .chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .chat-bubble {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        font-family: 'Inter', sans-serif;
        position: relative;
    }

    .chat-bubble.ai {
        align-self: flex-start;
        background: #f0f9ff;
        color: #0c4a6e;
        border-bottom-left-radius: 4px;
        border: 1px solid #bae6fd;
    }

    .chat-bubble.user {
        align-self: flex-end;
        background: #000;
        color: #fff;
        border-bottom-right-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chat-input-wrapper {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        background: rgba(255, 255, 255, 0.05);
        padding: 8px;
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #text-input {
        flex: 1;
        background: none;
        border: none;
        color: #fff;
        padding: 8px 15px;
        outline: none;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-color);
        border: none;
        color: #fff;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .voice-mode-content {
        transition: all 0.5s ease;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .voice-mode-content.hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
        display: none;
    }

    /* AI Overlay */
    .ai-response-overlay {
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        width: auto;
        min-width: 300px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 16px;
        color: #fff;
        font-size: 1rem;
        text-align: center;
        opacity: 0;
        pointer-events: none;
        transition: all 0.4s;
        z-index: 120;
    }

    .ai-response-overlay.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }

    .ai-response-icon {
        color: var(--accent-color);
        margin-bottom: 8px;
        font-size: 1.2rem;
    }

    /* Start Button Overlay */
    #start-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    #start-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .start-btn {
        width: 100px;
        height: 100px;
        background: transparent;
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    .start-btn i {
        font-size: 2rem;
        transition: all 0.4s;
    }

    .start-btn-label {
        font-size: 0.5rem;
        margin-top: 8px;
        letter-spacing: 2px;
        font-weight: 700;
        opacity: 0.5;
        transition: all 0.4s;
    }

    .start-btn:hover {
        border-color: var(--accent-color);
        color: #fff;
        box-shadow: 0 0 40px var(--accent-glow);
        transform: scale(1.1);
    }

    .start-btn:hover i {
        color: var(--accent-color);
        text-shadow: 0 0 10px var(--accent-glow);
    }

    .start-btn:hover .start-btn-label {
        opacity: 1;
        color: var(--accent-color);
    }

    .start-btn::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border: 1px solid var(--accent-color);
        border-radius: 50%;
        opacity: 0;
        transform: scale(1);
        transition: all 0.6s;
    }

    .start-btn:hover::after {
        opacity: 0.5;
        transform: scale(1.3);
    }

    /* Conversational Login UI */
    .login-bubble-container {
        position: absolute;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 400px;
        z-index: 600;
        display: none;
        flex-direction: column;
        gap: 15px;
        animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translate(-50%, 20px);
        }

        to {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }

    .login-input-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .login-input-card input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 12px 15px;
        color: #fff;
        outline: none;
        font-family: 'Inter', sans-serif;
    }

    .login-input-card input:focus {
        border-color: var(--accent-color);
        background: rgba(255, 255, 255, 0.1);
    }

    .login-submit-btn {
        background: var(--accent-color);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .login-submit-btn:hover {
        filter: brightness(1.2);
        box-shadow: 0 0 15px var(--accent-glow);
    }

    /* Attendance Button UI */
    .action-bubble-container {
        align-self: flex-start;
        margin-top: 10px;
        display: none;
    }

    .attendance-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
        border: none;
        border-radius: 20px;
        padding: 10px 25px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        transition: all 0.3s;
    }

    .attendance-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
</style>

<main id="main" class="admin-dashboard">
    @include('partials.admin-sidebar')

    <div id="start-overlay">
        <div class="visualizer-container" style="margin-bottom: 40px; cursor: default;">
            <div class="wave"></div>
            <div class="wave"></div>
            <div class="wave"></div>
            <div class="core-circle"></div>
        </div>
        <button class="start-btn" onclick="startWorkflow()">
            <i class="fas fa-power-off"></i>
            <div class="start-btn-label">LOGIN</div>
        </button>
    </div>

    <div class="main-content">

        <!-- Voice Content -->
        <div class="voice-mode-content" id="voice-content">
            <div class="visualizer-container">
                <div class="circle-text-container" id="circle-text">
                    <svg viewBox="0 0 200 200" class="circle-svg" width="320" height="320">
                        <path id="circlePath" d="M 100, 100 m -80, 0 a 80,80 0 1,1 160,0 a 80,80 0 1,1 -160,0" />
                        <text>
                            <textPath href="#circlePath">
                                Misesapo Intelligent System for Operational Guidance &amp; Integration &bull; Misesapo
                                Intelligent System for Operational Guidance &amp; Integration &bull;
                            </textPath>
                        </text>
                    </svg>
                </div>
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="core-circle"></div>
            </div>
            <div class="status-text" id="status-text">LISTENING...</div>
            <div class="ai-response-overlay" id="ai-response">
                <div class="ai-response-icon"><i class="fas fa-sparkles"></i> MISOGI</div>
                <div id="ai-message-text"></div>
            </div>
        </div>

        <!-- Chat Content -->
        <div id="chat-container">
            <div class="chat-history" id="chat-history">
                <!-- Initial welcome will be injected by JS -->
            </div>

            <!-- Login Bubble -->
            <div class="login-bubble-container" id="login-form">
                <div class="login-input-card">
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-bottom: 5px;">ACCOUNT
                        AUTHENTICATION</div>
                    <input type="email" id="login-email" placeholder="メールアドレス" autocomplete="email">
                    <input type="password" id="login-password" placeholder="パスワード" autocomplete="current-password">
                    <button class="login-submit-btn" onclick="performLogin()">認証</button>
                </div>
            </div>

            <div class="chat-input-wrapper">
                <input type="text" id="text-input" placeholder="メッセージを入力..." autocomplete="off">
                <button class="send-btn" onclick="sendTextMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Mode Switcher -->
        <div class="mode-switch-container">
            <button class="mode-btn active" id="btn-voice-mode" onclick="switchMode('voice')">
                <i class="fas fa-microphone"></i> 音声
            </button>
            <button class="mode-btn" id="btn-chat-mode" onclick="switchMode('chat')">
                <i class="fas fa-comment-dots"></i> チャット
            </button>
        </div>
    </div>

</main>

<script>
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';

    function ensureAuthOrRedirect() {
        // Simple token check
        const token = localStorage.getItem('cognito_id_token');
        if (!token) {
            // alert("認証が必要です。");
            return null;
        }
        return token;
    }

    // UI Variables
    const visualizer = document.querySelector('.visualizer-container');
    const core = document.querySelector('.core-circle');
    const circleText = document.getElementById('circle-text');
    const statusText = document.getElementById('status-text');
    const responseOverlay = document.getElementById('ai-response');
    const messageText = document.getElementById('ai-message-text');
    const voiceContent = document.getElementById('voice-content');
    const chatContainer = document.getElementById('chat-container');
    const chatHistory = document.getElementById('chat-history');
    const textInput = document.getElementById('text-input');
    const btnVoice = document.getElementById('btn-voice-mode');
    const btnChat = document.getElementById('btn-chat-mode');
    const sidebar = document.getElementById('admin-sidebar');
    const startOverlay = document.getElementById('start-overlay');
    const loginForm = document.getElementById('login-form');

    let currentMode = 'voice';

    // Hide sidebar by default for AI-centric feel
    if (sidebar) sidebar.style.display = 'none';

    async function startWorkflow() {
        startOverlay.classList.add('hidden');
        switchMode('chat');

        const token = localStorage.getItem('cognito_id_token');
        if (!token) {
            appendChatMessage('ai', 'おはようございます。ミセサポ管理AIのMISOGIです。セッションを開始するために、まずはログイン情報を入力してください。');
            setTimeout(() => {
                loginForm.style.display = 'flex';
            }, 800);
        } else {
            const user = JSON.parse(localStorage.getItem('cognito_user') || '{}');
            const today = new Date().toLocaleDateString('sv-SE');

            try {
                // Check if already clocked in today
                const response = await fetch(`${API_BASE}/attendance?staff_id=${user.id || user.sub}&date=${today}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let isClockedIn = false;
                if (response.ok) {
                    const data = await response.json();
                    const records = Array.isArray(data) ? data : (data.items || []);
                    isClockedIn = records.some(r => r.clock_in && !r.clock_out);
                }

                if (isClockedIn) {
                    appendChatMessage('ai', `${user.name || 'ユーザー'}様、お疲れ様です。既に出勤記録を確認しております。引き続き業務をサポートいたします。`);
                    handleAiCommands({ ui_commands: [{ type: 'show_sidebar' }] });
                } else {
                    appendChatMessage('ai', `${user.name || 'ユーザー'}様、おはようございます。業務を開始しますか？`);
                    handleAiCommands({ ui_commands: [{ type: 'show_attendance' }] });
                }
            } catch (e) {
                console.error('Failed to check attendance:', e);
                appendChatMessage('ai', `${user.name || 'ユーザー'}様、おはようございます。業務を開始しますか？`);
                handleAiCommands({ ui_commands: [{ type: 'show_attendance' }] });
            }
        }
    }

    async function performLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) return;

        const loginBtn = document.querySelector('.login-submit-btn');
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 認証中...';
        loginBtn.disabled = true;

        try {
            // Use existing CognitoAuth if available, or simulate for now
            if (window.CognitoAuth) {
                const result = await window.CognitoAuth.login(email, password);
                if (result.success) {
                    loginForm.style.display = 'none';
                    // Re-run workflow to check attendance state
                    await startWorkflow();
                } else {
                    throw new Error(result.message);
                }
            } else {
                throw new Error('認証システムが読み込まれていません');
            }
        } catch (err) {
            alert('ログインに失敗しました: ' + err.message);
            loginBtn.innerHTML = '認証';
            loginBtn.disabled = false;
        }
    }

    async function performClockIn() {
        const btn = document.getElementById('active-attendance-btn');
        if (btn) btn.disabled = true;

        const user = JSON.parse(localStorage.getItem('cognito_user') || '{}');
        const token = localStorage.getItem('cognito_id_token');

        if (!user.id || !token) {
            appendChatMessage('ai', 'エラー：ログイン情報が見つかりません。再ログインしてください。');
            return;
        }

        appendChatMessage('user', '出勤します');

        try {
            const today = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD
            const now = new Date().toISOString();

            const sanitizedData = {
                staff_id: user.id || user.sub,
                staff_name: user.name || user.username,
                date: today,
                clock_in: now
            };

            const response = await fetch(`${API_BASE}/attendance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(sanitizedData)
            });

            if (response.ok) {
                appendChatMessage('ai', `${user.name || 'ユーザー'}様、出勤を記録しました。本日の業務を開始します。それでは、良い1日を！左側のメニューから各機能へアクセスできます。`);
                handleAiCommands({ ui_commands: [{ type: 'show_sidebar' }] });
                if (btn) btn.innerHTML = '<i class="fas fa-check"></i> 出勤済み';
            } else {
                const err = await response.json();
                throw new Error(err.message || 'API Error');
            }
        } catch (err) {
            console.error('Attendance Error:', err);
            appendChatMessage('ai', 'エラーが発生しました：' + err.message);
            if (btn) btn.disabled = false;
        }
    }

    function switchMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        if (mode === 'voice') {
            btnVoice.classList.add('active');
            btnChat.classList.remove('active');
            chatContainer.classList.remove('active');
            voiceContent.classList.remove('hidden');
            voiceContent.style.display = 'flex';
        } else {
            btnChat.classList.add('active');
            btnVoice.classList.remove('active');
            voiceContent.classList.add('hidden');
            setTimeout(() => { if (currentMode === 'chat') voiceContent.style.display = 'none'; }, 500);
            chatContainer.classList.add('active');
            textInput.focus();
        }
    }

    function appendChatMessage(role, text) {
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${role}`;
        bubble.innerHTML = text.replace(/\n/g, '<br>');
        chatHistory.appendChild(bubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendTextMessage() {
        const text = textInput.value.trim();
        if (!text) return;
        appendChatMessage('user', text);
        textInput.value = '';

        const token = ensureAuthOrRedirect();

        const loadingBubble = document.createElement('div');
        loadingBubble.className = 'chat-bubble ai';
        loadingBubble.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 解析中...';
        chatHistory.appendChild(loadingBubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // Force Persona (Temporary fix for outdated backend)
        const systemPrompt = "(System: あなたは管理AI『Misogi』です。Sakuraと名乗らないでください。常に『Misogi』として振る舞ってください。)\n";
        const textToSend = systemPrompt + text;

        try {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            // Try the new admin action first
            const response = await fetch(`${API_BASE}/ai/process`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ action: 'admin_concierge', text: textToSend })
            });

            if (!response.ok) {
                // Return to old action if new one fails (e.g. backend not deployed)
                console.warn("admin_concierge failed, trying assistant_concierge with forced persona");
                const fallbackResponse = await fetch(`${API_BASE}/ai/process`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ action: 'assistant_concierge', text: textToSend })
                });
                if (!fallbackResponse.ok) throw new Error('API Error');
                const data = await fallbackResponse.json();
                await handleAiResponse(data, loadingBubble, text);
                return;
            }

            const data = await response.json();
            await handleAiResponse(data, loadingBubble, text);

        } catch (err) {
            console.error(err);
            if (loadingBubble.parentNode) loadingBubble.remove();
            appendChatMessage('ai', 'エラーが発生しました。');
        }
    }

    async function handleAiResponse(data, loadingBubble, userText) {
        if (loadingBubble.parentNode) loadingBubble.remove();

        let aiResult = data.result;
        if (typeof aiResult === 'string') {
            try {
                const jsonMatch = aiResult.match(/\{[\s\S]*\}/);
                if (jsonMatch) aiResult = JSON.parse(jsonMatch[0]);
            } catch (e) { }
        }

        let reply = aiResult.reply || aiResult.text || JSON.stringify(aiResult);
        let intent = aiResult.intent;
        let targetUrl = aiResult.target_url;

        // --- NEW: UI Command Handling ---
        handleAiCommands(aiResult);

        // --- Local Fallback Logic (Mock Navigation) ---
        // If the backend didn't return an intent (e.g. backend code not yet deployed), 
        // we simulate the navigation intent based on keywords.
        if (!intent || intent === 'chat') {
            const map = {
                '/admin/dashboard': ['ダッシュボード', 'アクティビティ'],
                '/admin/schedules/': ['スケジュール', 'カレンダー', '予定'],
                '/admin/customers/': ['顧客', 'お客様'],
                '/admin/reports/': ['レポート', '報告'],
                '/admin/estimates/': ['見積', '請求'],
                '/admin/orders': ['発注', '仕入'],
                '/admin/partners': ['パートナー', '協力会社'],
                '/admin/users/': ['ユーザー', '従業員', 'スタッフ'],
                '/admin/attendance/errors': ['勤怠', '打刻'],
                '/admin/services/': ['サービス', 'メニュー'],
                '/admin/analytics/': ['分析', '売上', '統計'],
                '/admin/images/': ['画像', '写真', 'メディア'],
                '/admin/zaiko': ['在庫', '棚卸'],
                '/admin/announcements': ['業務連絡', 'お知らせ', '通知'],
                '/wiki': ['WIKI', 'マニュアル'],
                '/admin/sitemap': ['サイトマップ']
            };

            for (const [url, keywords] of Object.entries(map)) {
                // Check if user input contains keyword OR if AI mention it and says "move/go"
                if (keywords.some(k => userText.includes(k))) {
                    // Force navigate intent
                    intent = 'navigate';
                    targetUrl = url;
                    if (!reply.includes('移動します')) {
                        reply += `<br><br><i class="fas fa-external-link-alt"></i> ${keywords[0]}へ移動します...`;
                    }
                    break;
                }
            }
        }

        appendChatMessage('ai', reply);

        if (intent === 'navigate' && targetUrl) {
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 1200);
        }
    }

    async function handleAiCommands(aiResult) {
        if (!aiResult.ui_commands) return;

        for (const cmd of aiResult.ui_commands) {
            switch (cmd.type) {
                case 'request_login':
                    loginForm.style.display = 'flex';
                    break;
                case 'show_attendance':
                    const container = document.createElement('div');
                    container.className = 'action-bubble-container';
                    container.style.display = 'block';
                    container.innerHTML = `
                        <button class="attendance-btn" id="active-attendance-btn" onclick="performClockIn()">
                            <i class="fas fa-sign-in-alt"></i> 出勤する
                        </button>
                    `;
                    chatHistory.appendChild(container);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    break;
                case 'show_sidebar':
                    if (sidebar) {
                        sidebar.style.display = 'flex';
                        const navItems = sidebar.querySelectorAll('.nav-item');
                        navItems.forEach((item, index) => {
                            setTimeout(() => {
                                item.classList.add('show');
                            }, index * 100);
                        });
                    }
                    break;
            }
        }
    }

    if (textInput) {
        textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendTextMessage(); });
    }

    // Toggle Visualizer Simulation
    let isRecording = false;
    if (visualizer) {
        visualizer.addEventListener('click', () => {
            if (!isRecording) {
                isRecording = true;
                statusText.textContent = "LISTENING... (Simulation)";
                core.classList.add('active');
                circleText.classList.add('active');
            } else {
                isRecording = false;
                statusText.textContent = "PROCESSING...";
                core.classList.remove('active');
                circleText.classList.remove('active');
                setTimeout(() => { statusText.textContent = "READY TO ASSIST"; }, 1500);
            }
        });
    }
</script>