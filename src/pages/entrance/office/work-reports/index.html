@layout('layouts.admin')
@json('data/meta/entrance_office_title.json', $title)
@json('data/meta/entrance_office_body_class.json', $body_class)

<base href="/" />
<link rel="stylesheet" href="/css/admin-sidebar.css" />
<script src="/js/office-work-reports.js"></script>
<style>
  .office-wr { max-width: 1200px; margin: 0 auto; padding: 1rem; }
  .office-wr h1 { font-size: 1.25rem; margin-bottom: 1rem; }
  .office-wr-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .office-wr-table th, .office-wr-table td { padding: 0.6rem 0.8rem; text-align: left; border-bottom: 1px solid #eee; }
  .office-wr-table th { background: #f8fafc; font-weight: 600; }
  .office-wr-table tbody tr { cursor: pointer; }
  .office-wr-table tbody tr:hover { background: #f1f5f9; }
  .office-wr-detail { display: none; margin-top: 1rem; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .office-wr-detail.show { display: block; }
  .office-wr-detail h2 { font-size: 1rem; margin-bottom: 0.5rem; }
  .office-wr-actions { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .office-wr-actions button { padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
  .office-wr-actions button.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
  .office-wr-actions button.danger { background: #dc2626; color: #fff; border-color: #dc2626; }
  .office-wr-actions button:disabled { opacity: 0.5; cursor: not-allowed; }
  .office-wr-toast { position: fixed; bottom: 1rem; right: 1rem; padding: 0.75rem 1rem; border-radius: 8px; background: #1e293b; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; opacity: 0; transition: opacity 0.2s; }
  .office-wr-toast.show { opacity: 1; }
  .office-wr-toast.warn { background: #b45309; }
  .office-wr-refresh-cta { margin-top: 0.5rem; }
  .office-wr-refresh-cta button { padding: 0.4rem 0.8rem; font-size: 0.875rem; background: #0ea5e9; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
  .office-wr-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 9998; }
  .office-wr-modal.show { display: flex; }
  .office-wr-modal-inner { background: #fff; padding: 1.5rem; border-radius: 8px; min-width: 320px; }
  .office-wr-modal-inner label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
  .office-wr-modal-inner textarea { width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; }
  .office-wr-modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
  .office-wr-state { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
  .office-wr-state.submitted { background: #dbeafe; color: #1d4ed8; }
  .office-wr-state.triaged { background: #e0e7ff; color: #3730a3; }
  .office-wr-state.approved { background: #d1fae5; color: #065f46; }
  .office-wr-state.rejected { background: #fee2e2; color: #991b1b; }
  .office-wr-loading { text-align: center; padding: 2rem; color: #64748b; }
  .office-wr-auth-required { padding: 2rem; text-align: center; color: #dc2626; }
</style>

<main id="main" class="office-wr">
  <h1>作業報告（事務）</h1>

  <div id="office-wr-auth-required" class="office-wr-auth-required" style="display: none;">
    管理者ロールでログインしてください。<br />
    <a href="/pages/entrance/index.html">入り口へ</a>
  </div>

  <div id="office-wr-list-wrap" style="display: none;">
    <div class="office-wr-refresh-cta" id="office-wr-refresh-wrap" style="display: none;">
      <button type="button" id="office-wr-refresh-btn">再読み込み</button>
    </div>
    <table class="office-wr-table" id="office-wr-table">
      <thead>
        <tr>
          <th>報告日</th>
          <th>状態</th>
          <th>作業者</th>
          <th>テンプレート</th>
        </tr>
      </thead>
      <tbody id="office-wr-tbody"></tbody>
    </table>
    <div id="office-wr-loading" class="office-wr-loading">読み込み中...</div>
  </div>

  <div id="office-wr-detail" class="office-wr-detail">
    <button type="button" id="office-wr-back-btn">&larr; 一覧へ</button>
    <h2 id="office-wr-detail-title">詳細</h2>
    <pre id="office-wr-detail-body" style="font-size: 0.85rem; white-space: pre-wrap; margin: 0.5rem 0;"></pre>
    <div class="office-wr-actions" id="office-wr-actions"></div>
  </div>
</main>

<div id="office-wr-toast" class="office-wr-toast" aria-live="polite"></div>

<div id="office-wr-reason-modal" class="office-wr-modal" aria-hidden="true">
  <div class="office-wr-modal-inner">
    <label for="office-wr-reason-input">差戻し理由（必須）</label>
    <textarea id="office-wr-reason-input" placeholder="理由を入力"></textarea>
    <div class="office-wr-modal-actions">
      <button type="button" id="office-wr-reason-cancel">キャンセル</button>
      <button type="button" id="office-wr-reason-submit">送信</button>
    </div>
  </div>
</div>

<script>
(function () {
  const API_BASE = window.OfficeWorkReports ? window.OfficeWorkReports.API_BASE : 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  const tbody = document.getElementById('office-wr-tbody');
  const listWrap = document.getElementById('office-wr-list-wrap');
  const detailEl = document.getElementById('office-wr-detail');
  const detailBody = document.getElementById('office-wr-detail-body');
  const detailTitle = document.getElementById('office-wr-detail-title');
  const actionsEl = document.getElementById('office-wr-actions');
  const authRequired = document.getElementById('office-wr-auth-required');
  const loadingEl = document.getElementById('office-wr-loading');
  const refreshWrap = document.getElementById('office-wr-refresh-wrap');
  const refreshBtn = document.getElementById('office-wr-refresh-btn');
  const reasonModal = document.getElementById('office-wr-reason-modal');
  const reasonInput = document.getElementById('office-wr-reason-input');
  const reasonCancel = document.getElementById('office-wr-reason-cancel');
  const reasonSubmit = document.getElementById('office-wr-reason-submit');

  function getToken() {
    return window.OfficeWorkReports ? window.OfficeWorkReports.getAuthToken() : (localStorage.getItem('cognito_id_token') || '');
  }

  async function hasAdminRole() {
    if (window.AdminSidebar && window.AdminSidebar.getCurrentUserRole) {
      const role = await window.AdminSidebar.getCurrentUserRole();
      return role === 'admin' || role === '管理者';
    }
    return true;
  }

  function showList() {
    listWrap.style.display = 'block';
    detailEl.classList.remove('show');
  }
  function showDetail() {
    listWrap.style.display = 'none';
    detailEl.classList.add('show');
  }

  function safeDefaultParams() {
    const to = new Date();
    const from = new Date(to);
    from.setDate(from.getDate() - 7);
    return {
      from: from.toISOString().slice(0, 10),
      to: to.toISOString().slice(0, 10),
      states: 'submitted,triaged,rejected'
    };
  }

  async function loadList() {
    if (!tbody) return;
    loadingEl.style.display = 'block';
    tbody.innerHTML = '';
    const params = safeDefaultParams();
    const res = await window.OfficeWorkReports.fetchAdminReports(params);
    loadingEl.style.display = 'none';
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        authRequired.style.display = 'block';
        listWrap.style.display = 'none';
        return;
      }
      window.OfficeWorkReports.showToast('一覧の取得に失敗しました。', 'warn');
      refreshWrap.style.display = 'block';
      return;
    }
    const rows = res.data.rows || res.data.items || [];
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">該当なし</td></tr>';
      return;
    }
    rows.forEach(function (row) {
      const tr = document.createElement('tr');
      tr.dataset.logId = row.log_id || '';
      const workDate = row.work_date || row.report_date || row.date || '-';
      const state = row.state || '-';
      const workerId = row.worker_id || row.created_by_name || '-';
      const templateId = row.template_id || '-';
      tr.innerHTML = '<td>' + escapeHtml(workDate) + '</td><td><span class="office-wr-state ' + escapeHtml(state) + '">' + (window.OfficeWorkReports ? window.OfficeWorkReports.stateLabel(state) : state) + '</span></td><td>' + escapeHtml(workerId) + '</td><td>' + escapeHtml(templateId) + '</td>';
      tr.addEventListener('click', function () { openDetail(row.log_id); });
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s) {
    if (s == null) return '';
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  let currentDetailId = null;
  let currentDetailItem = null;

  async function openDetail(id) {
    currentDetailId = id;
    currentDetailItem = null;
    showDetail();
    detailBody.textContent = '読み込み中...';
    actionsEl.innerHTML = '';
    const res = await window.OfficeWorkReports.fetchReportDetail(id);
    if (!res.ok) {
      detailBody.textContent = '取得に失敗しました。';
      if (res.status === 401 || res.status === 403) {
        authRequired.style.display = 'block';
      }
      return;
    }
    currentDetailItem = res.data;
    detailTitle.textContent = '報告 ID: ' + (id || '');
    detailBody.textContent = JSON.stringify(res.data, null, 2);
    renderActionButtons(res.data);
  }

  function renderActionButtons(item) {
    actionsEl.innerHTML = '';
    const state = item.state || '';
    const version = item.version;
    const templateId = item.template_id || '';

    function addBtn(label, to, style, needReason) {
      const btn = document.createElement('button');
      btn.textContent = label;
      if (style === 'primary') btn.className = 'primary';
      if (style === 'danger') btn.className = 'danger';
      btn.type = 'button';
      btn.addEventListener('click', function () {
        if (needReason) {
          openReasonModal(to, version);
        } else {
          doPatchState(to, '', version);
        }
      });
      actionsEl.appendChild(btn);
    }

    if (state === 'submitted') {
      addBtn('受付', 'triaged', 'primary', false);
      addBtn('承認', 'approved', 'primary', false);
      addBtn('差戻し', 'rejected', 'danger', true);
    }
    if (state === 'triaged') {
      addBtn('承認', 'approved', 'primary', false);
      addBtn('差戻し', 'rejected', 'danger', true);
    }
    if (state === 'approved' && templateId === 'CLEANING_PDF') {
      const pdfBtn = document.createElement('button');
      pdfBtn.textContent = 'PDF生成';
      pdfBtn.type = 'button';
      pdfBtn.addEventListener('click', doExportPdf);
      actionsEl.appendChild(pdfBtn);
    }
  }

  async function doPatchState(to, reason, version) {
    if (!currentDetailId) return;
    const body = { to: to };
    if (reason) body.reason = reason;
    if (version != null) body.version = version;
    const res = await window.OfficeWorkReports.patchState(currentDetailId, body);
    if (res.ok) {
      window.OfficeWorkReports.showToast('状態を更新しました。');
      currentDetailItem = res.data;
      detailBody.textContent = JSON.stringify(res.data, null, 2);
      renderActionButtons(res.data);
      loadList();
      return;
    }
    if (res.status === 409) {
      const action = window.OfficeWorkReports.handle409(res.data, loadList);
      if (action === 'refresh') refreshWrap.style.display = 'block';
      return;
    }
    if (res.status === 403) {
      window.OfficeWorkReports.handle409({ reason: 'not_authorized', message: '権限がありません。' });
      return;
    }
    window.OfficeWorkReports.showToast(res.data.message || 'エラーが発生しました。', 'warn');
  }

  function openReasonModal(to, version) {
    reasonInput.value = '';
    reasonModal.classList.add('show');
    reasonModal.setAttribute('aria-hidden', 'false');
    reasonSubmit.onclick = function () {
      const reason = reasonInput.value.trim();
      if (!reason) {
        window.OfficeWorkReports.showToast('差戻し理由を入力してください。', 'warn');
        return;
      }
      reasonModal.classList.remove('show');
      reasonModal.setAttribute('aria-hidden', 'true');
      doPatchState(to, reason, version);
    };
  }
  reasonCancel.addEventListener('click', function () {
    reasonModal.classList.remove('show');
    reasonModal.setAttribute('aria-hidden', 'true');
  });

  async function doExportPdf() {
    if (!currentDetailId) return;
    const res = await window.OfficeWorkReports.exportPdf(currentDetailId);
    if (res.ok && res.data.pdf_url) {
      window.open(res.data.pdf_url, '_blank');
      window.OfficeWorkReports.showToast('PDFを生成しました。');
      return;
    }
    window.OfficeWorkReports.showToast(res.data.error || 'PDFの生成に失敗しました。', 'warn');
  }

  document.getElementById('office-wr-back-btn').addEventListener('click', function () {
    showList();
    loadList();
  });
  refreshBtn.addEventListener('click', function () {
    refreshWrap.style.display = 'none';
    loadList();
  });

  async function init() {
    const token = getToken();
    const admin = await hasAdminRole();
    if (!token || !admin) {
      authRequired.style.display = 'block';
      listWrap.style.display = 'none';
      return;
    }
    authRequired.style.display = 'none';
    listWrap.style.display = 'block';
    await loadList();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
