@layout('layouts.admin')
@json('data/meta/line_title.json', $title)

<style>
    /* === Line UI Styles === */
    :root {
        --line-bg: #0a1128;
        --line-card: rgba(255, 255, 255, 0.05);
        --line-border: rgba(255, 255, 255, 0.1);
        --line-text: #fff;
        --line-accent: #10b981;
        --line-warning: #f59e0b;
        --line-error: #ef4444;
    }

    body {
        background: radial-gradient(circle at center, #0a1128 0%, #000 100%) !important;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        color: var(--line-text);
    }

    .line-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .line-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 0;
        border-bottom: 1px solid var(--line-border);
        margin-bottom: 30px;
    }

    .line-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .line-back-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--line-card);
        border: 1px solid var(--line-border);
        color: var(--line-text);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .line-back-btn:hover {
        background: var(--line-accent);
        border-color: var(--line-accent);
    }

    /* Step Indicator */
    .step-indicator {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
    }

    .step-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--line-border);
        transition: all 0.3s;
    }

    .step-dot.active {
        background: var(--line-accent);
        box-shadow: 0 0 10px var(--line-accent);
    }

    .step-dot.completed {
        background: var(--line-accent);
    }

    /* Process List */
    .process-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
        flex: 1;
    }

    .process-card {
        background: var(--line-card);
        border: 1px solid var(--line-border);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .process-card:hover {
        border-color: var(--line-accent);
        transform: translateY(-2px);
    }

    .process-card.selected {
        border-color: var(--line-accent);
        background: rgba(16, 185, 129, 0.1);
    }

    .process-card h3 {
        font-size: 1.1rem;
        margin: 0 0 8px 0;
    }

    .process-card p {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        margin: 0;
    }

    /* Check Items */
    .check-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
    }

    .check-item {
        display: flex;
        align-items: center;
        gap: 15px;
        background: var(--line-card);
        border: 1px solid var(--line-border);
        border-radius: 12px;
        padding: 16px 20px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .check-item:hover {
        border-color: var(--line-accent);
    }

    .check-item.checked {
        border-color: var(--line-accent);
        background: rgba(16, 185, 129, 0.1);
    }

    .check-box {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 2px solid var(--line-border);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .check-item.checked .check-box {
        background: var(--line-accent);
        border-color: var(--line-accent);
    }

    .check-box i {
        color: #fff;
        font-size: 0.9rem;
        opacity: 0;
    }

    .check-item.checked .check-box i {
        opacity: 1;
    }

    .check-label {
        font-size: 1rem;
        font-weight: 500;
    }

    /* Exception Toggle */
    .exception-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--line-card);
        border: 1px solid var(--line-border);
        border-radius: 12px;
        padding: 16px 20px;
        margin-top: 20px;
    }

    .exception-toggle.active {
        border-color: var(--line-warning);
        background: rgba(245, 158, 11, 0.1);
    }

    .exception-label {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .exception-label i {
        color: var(--line-warning);
    }

    /* Reason Code Selector */
    .reason-selector {
        display: none;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
    }

    .reason-selector.visible {
        display: flex;
    }

    .reason-option {
        background: var(--line-card);
        border: 1px solid var(--line-border);
        border-radius: 10px;
        padding: 14px 18px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }

    .reason-option:hover {
        border-color: var(--line-warning);
    }

    .reason-option.selected {
        border-color: var(--line-warning);
        background: rgba(245, 158, 11, 0.15);
    }

    /* Action Buttons */
    .line-actions {
        display: flex;
        gap: 12px;
        padding: 20px 0;
        margin-top: auto;
    }

    .line-btn {
        flex: 1;
        padding: 16px 24px;
        border-radius: 30px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
    }

    .line-btn-primary {
        background: linear-gradient(135deg, var(--line-accent), #059669);
        color: #fff;
    }

    .line-btn-primary:disabled {
        background: #4b5563;
        cursor: not-allowed;
    }

    .line-btn-secondary {
        background: var(--line-card);
        border: 1px solid var(--line-border);
        color: var(--line-text);
    }

    /* Completion Screen */
    .completion-screen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex: 1;
        gap: 20px;
    }

    .completion-screen.visible {
        display: flex;
    }

    .completion-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--line-accent), #059669);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    .completion-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
    }

    .completion-message {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        margin: 0;
    }

    .certificate-id {
        font-family: monospace;
        background: var(--line-card);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    /* Pending Approval Screen */
    .pending-screen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex: 1;
        gap: 20px;
    }

    .pending-screen.visible {
        display: flex;
    }

    .pending-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--line-warning), #d97706);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
    }

    /* Loading */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.visible {
        display: flex;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--line-border);
        border-top-color: var(--line-accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div class="line-container">
    <!-- Header -->
    <header class="line-header">
        <button class="line-back-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 id="page-title">ライン通過</h1>
        <div style="width: 44px;"></div>
    </header>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step-dot active" data-step="1"></div>
        <div class="step-dot" data-step="2"></div>
        <div class="step-dot" data-step="3"></div>
    </div>

    <!-- Step 1: Process Selection -->
    <div id="step-1" class="step-content">
        <div class="process-list" id="process-list">
            <p style="text-align: center; color: rgba(255,255,255,0.6);">工程を読み込み中...</p>
        </div>
        <div class="line-actions">
            <button class="line-btn line-btn-primary" id="btn-step1-next" disabled onclick="goToStep(2)">
                次へ
            </button>
        </div>
    </div>

    <!-- Step 2: Check Items -->
    <div id="step-2" class="step-content" style="display: none;">
        <div class="check-list" id="check-list">
            <!-- Check items loaded dynamically -->
        </div>

        <!-- Exception Toggle -->
        <div class="exception-toggle" id="exception-toggle" onclick="toggleException()">
            <div class="exception-label">
                <i class="fas fa-exclamation-triangle"></i>
                <span>例外として報告</span>
            </div>
            <div class="toggle-switch">
                <input type="checkbox" id="exception-checkbox">
                <span class="toggle-slider"></span>
            </div>
        </div>

        <!-- Reason Code Selector (visible only when exception) -->
        <div class="reason-selector" id="reason-selector">
            <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin: 0 0 10px 0;">
                <i class="fas fa-info-circle"></i> 理由を選択してください（必須）
            </p>
            <div class="reason-option" data-code="EXCEPTION_EQUIPMENT_ISSUE" onclick="selectReason(this)">
                設備トラブル
            </div>
            <div class="reason-option" data-code="EXCEPTION_ACCESS_DENIED" onclick="selectReason(this)">
                アクセス不可
            </div>
            <div class="reason-option" data-code="EXCEPTION_WEATHER" onclick="selectReason(this)">
                天候による中断
            </div>
            <div class="reason-option" data-code="EXCEPTION_OTHER" onclick="selectReason(this)">
                その他
            </div>
        </div>

        <div class="line-actions">
            <button class="line-btn line-btn-secondary" onclick="goToStep(1)">
                戻る
            </button>
            <button class="line-btn line-btn-primary" id="btn-step2-next" onclick="goToStep(3)">
                確認へ
            </button>
        </div>
    </div>

    <!-- Step 3: Confirmation -->
    <div id="step-3" class="step-content" style="display: none;">
        <div
            style="background: var(--line-card); border: 1px solid var(--line-border); border-radius: 16px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">確認内容</h3>
            <div id="confirmation-summary">
                <!-- Summary loaded dynamically -->
            </div>
        </div>

        <div class="line-actions">
            <button class="line-btn line-btn-secondary" onclick="goToStep(2)">
                戻る
            </button>
            <button class="line-btn line-btn-primary" id="btn-pass" onclick="submitPass()">
                通過する
            </button>
        </div>
    </div>

    <!-- Completion Screen -->
    <div class="completion-screen" id="completion-screen">
        <div class="completion-icon">
            <i class="fas fa-check"></i>
        </div>
        <h2 class="completion-title">通過完了</h2>
        <p class="completion-message">実施証明が発行されました</p>
        <div class="certificate-id" id="certificate-id"></div>
        <button class="line-btn line-btn-primary" onclick="goBack()" style="width: 200px; margin-top: 20px;">
            完了
        </button>
    </div>

    <!-- Pending Approval Screen -->
    <div class="pending-screen" id="pending-screen">
        <div class="pending-icon">
            <i class="fas fa-clock"></i>
        </div>
        <h2 class="completion-title">承認待ち</h2>
        <p class="completion-message">管理者の承認をお待ちください</p>
        <button class="line-btn line-btn-secondary" onclick="goBack()" style="width: 200px; margin-top: 20px;">
            戻る
        </button>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<script>
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';

    // State
    let currentStep = 1;
    let selectedProcess = null;
    let checkResults = {};
    let isException = false;
    let selectedReasonCode = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await loadProcesses();
    });

    // Navigation
    function goBack() {
        location.href = '/entrance/';
    }

    function goToStep(step) {
        // Validate before moving
        if (step === 2 && !selectedProcess) {
            alert('工程を選択してください');
            return;
        }
        if (step === 3) {
            if (isException && !selectedReasonCode) {
                alert('例外理由を選択してください');
                return;
            }
            updateConfirmationSummary();
        }

        // Hide all steps
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');

        // Show target step
        document.getElementById(`step-${step}`).style.display = 'flex';
        document.getElementById(`step-${step}`).style.flexDirection = 'column';

        // Update step indicator
        document.querySelectorAll('.step-dot').forEach((dot, i) => {
            dot.classList.remove('active', 'completed');
            if (i + 1 < step) dot.classList.add('completed');
            if (i + 1 === step) dot.classList.add('active');
        });

        currentStep = step;

        // Load check items when entering step 2
        if (step === 2 && selectedProcess) {
            loadCheckItems();
        }
    }

    // Load processes from API
    async function loadProcesses() {
        const processList = document.getElementById('process-list');

        try {
            const user = JSON.parse(localStorage.getItem('cognito_user') || '{}');
            const workerId = user.sub || user.uid;
            const today = new Date().toISOString().split('T')[0];
            const idToken = localStorage.getItem('cognito_id_token') || '';

            const response = await fetch(`${API_BASE}/schedules?worker_id=${workerId}&date=${today}`, {
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('Failed to load processes');

            const data = await response.json();
            const schedules = data.items || data.schedules || [];

            if (schedules.length === 0) {
                processList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6);">本日の割当工程がありません</p>';
                return;
            }

            processList.innerHTML = schedules.map(schedule => `
                <div class="process-card" data-id="${schedule.id}" onclick="selectProcess(this, '${schedule.id}')">
                    <h3>${escapeHtml(schedule.store_name || '店舗名なし')}</h3>
                    <p>${schedule.time_slot || schedule.scheduled_time || ''} | ${escapeHtml(schedule.address || '')}</p>
                </div>
            `).join('');

        } catch (e) {
            console.error('Error loading processes:', e);
            processList.innerHTML = '<p style="text-align: center; color: #ef4444;">工程の読み込みに失敗しました</p>';
        }
    }

    // Select process
    function selectProcess(el, processId) {
        document.querySelectorAll('.process-card').forEach(card => card.classList.remove('selected'));
        el.classList.add('selected');
        selectedProcess = processId;
        document.getElementById('btn-step1-next').disabled = false;
    }

    // Load check items for selected process
    async function loadCheckItems() {
        const checkList = document.getElementById('check-list');
        checkList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6);">チェック項目を読み込み中...</p>';

        try {
            const idToken = localStorage.getItem('cognito_id_token') || '';
            const response = await fetch(`${API_BASE}/schedules/${selectedProcess}`, {
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('Failed to load check items');

            const schedule = await response.json();
            const items = schedule.cleaning_items || [];

            if (items.length === 0) {
                checkList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6);">チェック項目がありません</p>';
                return;
            }

            // Initialize check results
            checkResults = {};
            items.forEach(item => {
                checkResults[item.item_id || item.id || item.name] = true; // Default checked
            });

            checkList.innerHTML = items.map(item => {
                const itemId = item.item_id || item.id || item.name;
                return `
                    <div class="check-item checked" data-item-id="${itemId}" onclick="toggleCheck(this)">
                        <div class="check-box">
                            <i class="fas fa-check"></i>
                        </div>
                        <span class="check-label">${escapeHtml(item.name || itemId)}</span>
                    </div>
                `;
            }).join('');

        } catch (e) {
            console.error('Error loading check items:', e);
            checkList.innerHTML = '<p style="text-align: center; color: #ef4444;">チェック項目の読み込みに失敗しました</p>';
        }
    }

    // Toggle check item
    function toggleCheck(el) {
        const itemId = el.dataset.itemId;
        const isChecked = el.classList.toggle('checked');
        checkResults[itemId] = isChecked;
    }

    // Toggle exception
    function toggleException() {
        const toggle = document.getElementById('exception-toggle');
        const checkbox = document.getElementById('exception-checkbox');
        const reasonSelector = document.getElementById('reason-selector');

        isException = !isException;
        checkbox.checked = isException;
        toggle.classList.toggle('active', isException);
        reasonSelector.classList.toggle('visible', isException);

        if (!isException) {
            selectedReasonCode = null;
            document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
        }
    }

    // Select reason code
    function selectReason(el) {
        document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
        el.classList.add('selected');
        selectedReasonCode = el.dataset.code;
    }

    // Update confirmation summary
    function updateConfirmationSummary() {
        const summary = document.getElementById('confirmation-summary');
        const checkedCount = Object.values(checkResults).filter(v => v).length;
        const totalCount = Object.keys(checkResults).length;

        summary.innerHTML = `
            <div style="margin-bottom: 12px;">
                <span style="color: rgba(255,255,255,0.6);">工程ID:</span>
                <span style="margin-left: 10px;">${selectedProcess}</span>
            </div>
            <div style="margin-bottom: 12px;">
                <span style="color: rgba(255,255,255,0.6);">チェック項目:</span>
                <span style="margin-left: 10px;">${checkedCount} / ${totalCount} 完了</span>
            </div>
            <div>
                <span style="color: rgba(255,255,255,0.6);">ステータス:</span>
                <span style="margin-left: 10px; ${isException ? 'color: #f59e0b;' : 'color: #10b981;'}">
                    ${isException ? '例外報告（承認待ち）' : '通常通過'}
                </span>
            </div>
            ${isException ? `
                <div style="margin-top: 12px;">
                    <span style="color: rgba(255,255,255,0.6);">理由:</span>
                    <span style="margin-left: 10px;">${selectedReasonCode}</span>
                </div>
            ` : ''}
        `;
    }

    // Submit pass
    async function submitPass() {
        const loading = document.getElementById('loading-overlay');
        loading.classList.add('visible');

        try {
            const user = JSON.parse(localStorage.getItem('cognito_user') || '{}');
            const workerId = user.sub || user.uid;
            const idToken = localStorage.getItem('cognito_id_token') || '';

            const payload = {
                process_id: selectedProcess,
                worker_id: workerId,
                check_results: Object.entries(checkResults).map(([id, passed]) => ({
                    item_id: id,
                    passed: passed
                })),
                is_exception: isException,
                reason_code: isException ? selectedReasonCode : null
            };

            const response = await fetch(`${API_BASE}/line/pass`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || data.error || 'Failed to pass');
            }

            loading.classList.remove('visible');

            if (data.status === 'passed') {
                // Show completion screen
                document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
                document.getElementById('completion-screen').classList.add('visible');
                document.getElementById('certificate-id').textContent = data.certificate_id || '';
            } else if (data.status === 'pending_approval') {
                // Show pending screen
                document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
                document.getElementById('pending-screen').classList.add('visible');
            }

        } catch (e) {
            loading.classList.remove('visible');
            console.error('Error submitting pass:', e);
            alert('通過処理に失敗しました: ' + e.message);
        }
    }

    // Utility
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>