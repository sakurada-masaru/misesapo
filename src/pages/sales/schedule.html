@layout('layouts.base')
@json('data/meta/sales_schedule_title.json', $title)
@json('data/meta/sales_schedule_body_class.json', $body_class)
@json('data/sales_schedule.json', schedule_data)
@json('data/clients.json', clients_data)

<main id="main" class="google-calendar-wrapper">
  <!-- Left Sidebar -->
  <aside class="calendar-sidebar">
    <div class="sidebar-header">
      <a href="/sales/dashboard.html" class="back-btn-sidebar">
        <i class="fas fa-chevron-left"></i>
      </a>
      <button class="create-btn">
        <i class="fas fa-plus"></i> 作成
      </button>
    </div>
    
    <div class="sidebar-content">
      <!-- Search -->
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="検索" id="calendar-search">
      </div>

      <!-- View Tabs -->
      <div class="view-tabs-sidebar">
        <button class="view-tab-sidebar active" data-view="month">
          <i class="fas fa-calendar-alt"></i> 月
        </button>
        <button class="view-tab-sidebar" data-view="week">
          <i class="fas fa-calendar-week"></i> 週
        </button>
        <button class="view-tab-sidebar" data-view="day">
          <i class="fas fa-calendar-day"></i> 日
        </button>
      </div>

      <!-- Calendar List -->
      <div class="calendar-list">
        <div class="calendar-list-header">
          <h3>カレンダー</h3>
        </div>
        <div class="calendar-list-items" id="calendar-list-items">
          <!-- Calendar items will be generated by JavaScript -->
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="calendar-main">
    <!-- Top Bar -->
    <div class="calendar-topbar">
      <div class="topbar-left">
        <button class="menu-toggle" id="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <div class="date-navigation">
          <button class="nav-btn-icon" id="prev-btn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn-icon" id="next-btn">
            <i class="fas fa-chevron-right"></i>
          </button>
          <button class="today-btn-google" id="today-btn">今日</button>
          <h2 class="current-date-title" id="current-date-title">2025年3月</h2>
        </div>
      </div>
      <div class="topbar-right">
        <button class="icon-btn" id="settings-btn" title="設定">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>

    <!-- Month View -->
    <div class="calendar-view" id="month-view">
      <div class="calendar-grid-month">
        <div class="calendar-weekdays-month">
          <div class="weekday-month">日</div>
          <div class="weekday-month">月</div>
          <div class="weekday-month">火</div>
          <div class="weekday-month">水</div>
          <div class="weekday-month">木</div>
          <div class="weekday-month">金</div>
          <div class="weekday-month">土</div>
        </div>
        <div class="calendar-days-month" id="calendar-days-month">
          <!-- Calendar days will be generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Week View -->
    <div class="calendar-view hidden" id="week-view">
      <div class="calendar-grid-week">
        <div class="time-column">
          <div class="time-header"></div>
          <div class="time-slots" id="time-slots-week">
            <!-- Time slots will be generated by JavaScript -->
          </div>
        </div>
        <div class="days-column">
          <div class="days-header" id="days-header-week">
            <!-- Day headers will be generated by JavaScript -->
          </div>
          <div class="days-content" id="days-content-week">
            <!-- Day columns will be generated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Day View -->
    <div class="calendar-view hidden" id="day-view">
      <div class="calendar-grid-day">
        <div class="time-column">
          <div class="time-header"></div>
          <div class="time-slots" id="time-slots-day">
            <!-- Time slots will be generated by JavaScript -->
          </div>
        </div>
        <div class="day-column">
          <div class="day-header" id="day-header-day">
            <!-- Day header will be generated by JavaScript -->
          </div>
          <div class="day-content" id="day-content-day">
            <!-- Day content will be generated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal-overlay hidden" id="schedule-modal">
    <div class="modal-content-google">
      <div class="modal-header-google">
        <h3 id="modal-title">スケジュール</h3>
        <button class="modal-close-google" id="modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="schedule-form">
        <input type="hidden" id="schedule-id" name="id">
        
        <div class="form-group-google">
          <label>タイトル</label>
          <input type="text" id="schedule-title" name="title" class="form-input-google" required>
        </div>

        <div class="form-row-google">
          <div class="form-group-google">
            <label>日付</label>
            <input type="date" id="schedule-date" name="date" class="form-input-google" required>
          </div>
          <div class="form-group-google">
            <label>開始時刻</label>
            <input type="time" id="schedule-time-start" name="time_start" class="form-input-google" required>
          </div>
          <div class="form-group-google">
            <label>終了時刻</label>
            <input type="time" id="schedule-time-end" name="time_end" class="form-input-google" required>
          </div>
        </div>

        <div class="form-group-google">
          <label>カレンダー</label>
          <select id="schedule-calendar-type" name="calendar_type" class="form-input-google">
            <option value="見積もり提出">見積もり提出</option>
            <option value="商談">商談</option>
            <option value="定期訪問">定期訪問</option>
            <option value="清掃状況確認">清掃状況確認</option>
            <option value="その他">その他</option>
          </select>
        </div>

        <div class="form-group-google">
          <label>顧客</label>
          <select id="schedule-client" name="client_id" class="form-input-google">
            <option value="">選択してください</option>
          </select>
        </div>

        <div class="form-group-google">
          <label>店舗</label>
          <input type="text" id="schedule-store" name="store_name" class="form-input-google" placeholder="店舗名を入力">
        </div>

        <div class="form-group-google">
          <label>住所</label>
          <input type="text" id="schedule-address" name="address" class="form-input-google" placeholder="住所を入力">
        </div>

        <div class="form-group-google">
          <label>備考</label>
          <textarea id="schedule-notes" name="notes" class="form-input-google form-textarea-google" rows="3"></textarea>
        </div>

        <div class="form-actions-google">
          <button type="button" class="btn-cancel" id="modal-cancel">キャンセル</button>
          <button type="button" class="btn-delete hidden" id="modal-delete">削除</button>
          <button type="submit" class="btn-save">保存</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    /* Reset and Base */
    body.page-sales-schedule {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    body.page-sales-schedule #default-header-wrapper,
    body.page-sales-schedule #normal-header-wrapper,
    body.page-sales-schedule .site-footer {
      display: none !important;
    }
    
    .google-calendar-wrapper {
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #fff;
      font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Back Button (hidden on desktop, shown in sidebar) */
    .back-btn-google {
      display: none;
    }

    /* Sidebar */
    .calendar-sidebar {
      width: 256px;
      background: #fff;
      border-right: 1px solid #dadce0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #dadce0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .back-btn-sidebar {
      width: 100%;
      padding: 8px 16px;
      background: #f8f9fa;
      color: #5f6368;
      text-decoration: none;
      border: 1px solid #dadce0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .back-btn-sidebar:hover {
      background: #e8eaed;
      color: #202124;
    }
    @media (max-width: 768px) {
      .back-btn-sidebar {
        display: none;
      }
    }
    .create-btn {
      width: 100%;
      padding: 12px 24px;
      background: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(60,64,67,0.3);
    }
    .create-btn:hover {
      background: #1557b0;
      box-shadow: 0 2px 4px rgba(60,64,67,0.3);
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }
    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #5f6368;
      font-size: 14px;
    }
    .search-box input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .search-box input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26,115,232,0.1);
    }
    .view-tabs-sidebar {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 24px;
    }
    .view-tab-sidebar {
      padding: 10px 16px;
      border: none;
      background: transparent;
      text-align: left;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #5f6368;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
    }
    .view-tab-sidebar:hover {
      background: #f1f3f4;
    }
    .view-tab-sidebar.active {
      background: #e8f0fe;
      color: #1a73e8;
      font-weight: 500;
    }
    .calendar-list-header h3 {
      font-size: 13px;
      font-weight: 500;
      color: #5f6368;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .calendar-list-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .calendar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .calendar-item:hover {
      background: #f1f3f4;
    }
    .calendar-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .calendar-name {
      flex: 1;
      font-size: 14px;
      color: #202124;
    }
    .calendar-toggle {
      width: 18px;
      height: 18px;
      border: 2px solid #dadce0;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .calendar-item.hidden .calendar-toggle {
      background: #fff;
    }
    .calendar-item:not(.hidden) .calendar-toggle {
      background: #1a73e8;
      border-color: #1a73e8;
    }
    .calendar-item:not(.hidden) .calendar-toggle::after {
      content: '✓';
      color: #fff;
      font-size: 12px;
    }

    /* Main Content */
    .calendar-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .calendar-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      border-bottom: 1px solid #dadce0;
      background: #fff;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .menu-toggle {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      transition: all 0.2s;
    }
    .menu-toggle:hover {
      background: #f1f3f4;
    }
    .date-navigation {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-btn-icon {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      transition: all 0.2s;
    }
    .nav-btn-icon:hover {
      background: #f1f3f4;
    }
    .today-btn-google {
      padding: 8px 16px;
      border: 1px solid #dadce0;
      background: #fff;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
    }
    .today-btn-google:hover {
      background: #f8f9fa;
    }
    .current-date-title {
      font-size: 22px;
      font-weight: 400;
      color: #202124;
      margin: 0;
      min-width: 200px;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      transition: all 0.2s;
    }
    .icon-btn:hover {
      background: #f1f3f4;
    }

    /* Calendar Views */
    .calendar-view {
      flex: 1;
      overflow: auto;
      background: #fff;
    }
    .calendar-view.hidden {
      display: none;
    }

    /* Month View */
    .calendar-grid-month {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .calendar-weekdays-month {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom: 1px solid #dadce0;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .weekday-month {
      padding: 8px 4px;
      text-align: center;
      font-size: 10px;
      font-weight: 500;
      color: #5f6368;
      text-transform: uppercase;
    }
    .calendar-days-month {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      flex: 1;
      border-right: 1px solid #dadce0;
      border-bottom: 1px solid #dadce0;
    }
    .calendar-day-month {
      min-height: 80px;
      border-left: 1px solid #dadce0;
      border-top: 1px solid #dadce0;
      padding: 4px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-day-month:hover {
      background: #f8f9fa;
    }
    .calendar-day-month.other-month {
      background: #f8f9fa;
      color: #9aa0a6;
    }
    .calendar-day-month.today {
      background: #e8f0fe;
    }
    .day-number {
      font-size: 12px;
      font-weight: 500;
      color: #202124;
      margin-bottom: 2px;
    }
    .calendar-day-month.today .day-number {
      color: #1a73e8;
      font-weight: 700;
    }
    .day-events {
      display: flex;
      flex-direction: column;
      gap: 1px;
      margin-top: 2px;
    }
    .day-event {
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 10px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-left: 2px solid;
      transition: all 0.2s;
    }
    .day-event:hover {
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .day-event-more {
      font-size: 10px;
      color: #5f6368;
      padding: 1px 4px;
      cursor: pointer;
    }
    .day-event-more:hover {
      background: #f1f3f4;
      border-radius: 3px;
    }

    /* Week View */
    .calendar-grid-week {
      display: flex;
      height: 100%;
    }
    .time-column {
      width: 50px;
      border-right: 1px solid #dadce0;
      background: #fff;
      position: sticky;
      left: 0;
      z-index: 5;
      flex-shrink: 0;
    }
    .time-header {
      height: 48px;
      border-bottom: 1px solid #dadce0;
    }
    .time-slots {
      display: flex;
      flex-direction: column;
    }
    .time-slot {
      height: 40px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding-right: 8px;
      padding-top: 2px;
      font-size: 11px;
      color: #5f6368;
    }
    .days-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-x: auto;
    }
    .days-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom: 1px solid #dadce0;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .day-header {
      padding: 8px 4px;
      text-align: center;
      border-right: 1px solid #dadce0;
    }
    .day-header.today {
      background: #e8f0fe;
    }
    .day-header-name {
      font-size: 11px;
      color: #5f6368;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .day-header-number {
      font-size: 20px;
      font-weight: 400;
      color: #202124;
    }
    .day-header.today .day-header-number {
      color: #1a73e8;
      font-weight: 500;
    }
    .days-content {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      flex: 1;
    }
    .day-column-week {
      border-right: 1px solid #dadce0;
      position: relative;
    }
    .day-column-week .day-time-slot {
      height: 40px;
      border-bottom: 1px solid #e8eaed;
      position: relative;
      cursor: pointer;
    }
    .day-column-week .day-time-slot:hover {
      background: #f8f9fa;
    }
    .week-event {
      position: absolute;
      left: 1px;
      right: 1px;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      cursor: move;
      overflow: hidden;
      border-left: 2px solid;
      z-index: 1;
      user-select: none;
      transition: box-shadow 0.2s;
    }
    .week-event:hover {
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .week-event.dragging {
      opacity: 0.7;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .week-event .resize-handle {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      cursor: ns-resize;
      background: rgba(0,0,0,0.1);
      border-radius: 0 0 4px 4px;
    }
    .week-event .resize-handle:hover {
      background: rgba(0,0,0,0.2);
    }
    .week-event .resize-handle-top {
      top: 0;
      bottom: auto;
      border-radius: 4px 4px 0 0;
    }

    /* Day View */
    .calendar-grid-day {
      display: flex;
      height: 100%;
    }
    .day-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .day-header {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #dadce0;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .day-content {
      flex: 1;
      position: relative;
    }
    .day-content .day-time-slot {
      height: 40px;
      border-bottom: 1px solid #e8eaed;
      position: relative;
      cursor: pointer;
    }
    .day-content .day-time-slot:hover {
      background: #f8f9fa;
    }
    .day-event {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: move;
      border-left: 4px solid;
      transition: all 0.2s;
      user-select: none;
    }
    .day-event:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .day-event.dragging {
      opacity: 0.7;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Calendar Colors */
    .calendar-color.purpose-見積もり提出 { background: #4285f4; }
    .calendar-color.purpose-商談 { background: #fbbc04; }
    .calendar-color.purpose-定期訪問 { background: #34a853; }
    .calendar-color.purpose-清掃状況確認 { background: #ea4335; }
    .calendar-color.purpose-その他 { background: #9aa0a6; }

    .day-event.purpose-見積もり提出,
    .week-event.purpose-見積もり提出 {
      background: #e8f0fe;
      border-left-color: #4285f4;
      color: #1967d2;
    }
    .day-event.purpose-商談,
    .week-event.purpose-商談 {
      background: #fef7e0;
      border-left-color: #fbbc04;
      color: #f9ab00;
    }
    .day-event.purpose-定期訪問,
    .week-event.purpose-定期訪問 {
      background: #e6f4ea;
      border-left-color: #34a853;
      color: #137333;
    }
    .day-event.purpose-清掃状況確認,
    .week-event.purpose-清掃状況確認 {
      background: #fce8e6;
      border-left-color: #ea4335;
      color: #c5221f;
    }
    .day-event.purpose-その他,
    .week-event.purpose-その他 {
      background: #f1f3f4;
      border-left-color: #9aa0a6;
      color: #5f6368;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-overlay.hidden {
      display: none;
    }
    .modal-content-google {
      background: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 10px 1px rgba(0,0,0,0.14), 0 3px 14px 2px rgba(0,0,0,0.12);
    }
    .modal-header-google {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid #dadce0;
    }
    .modal-header-google h3 {
      font-size: 20px;
      font-weight: 400;
      margin: 0;
      color: #202124;
    }
    .modal-close-google {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      transition: all 0.2s;
    }
    .modal-close-google:hover {
      background: #f1f3f4;
    }
    .form-group-google {
      margin-bottom: 16px;
      padding: 0 24px;
    }
    .form-row-google {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      padding: 0 24px;
      margin-bottom: 16px;
    }
    .form-group-google label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #5f6368;
      margin-bottom: 4px;
    }
    .form-input-google {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      color: #202124;
      transition: all 0.2s;
    }
    .form-input-google:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26,115,232,0.1);
    }
    .form-textarea-google {
      resize: vertical;
      min-height: 80px;
    }
    .form-actions-google {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 24px;
      border-top: 1px solid #dadce0;
      margin-top: 24px;
    }
    .btn-cancel,
    .btn-delete,
    .btn-save {
      padding: 8px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-cancel {
      background: transparent;
      color: #5f6368;
    }
    .btn-cancel:hover {
      background: #f1f3f4;
    }
    .btn-delete {
      background: transparent;
      color: #ea4335;
      margin-right: auto;
    }
    .btn-delete:hover {
      background: #fce8e6;
    }
    .btn-save {
      background: #1a73e8;
      color: #fff;
    }
    .btn-save:hover {
      background: #1557b0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .calendar-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transform: translateX(-100%);
      }
      .calendar-sidebar.open {
        transform: translateX(0);
      }
      .calendar-main {
        width: 100%;
        padding: 0;
      }
      .calendar-topbar {
        padding: 8px 12px;
      }
      .calendar-view {
        padding: 0;
      }
      .calendar-weekdays-month {
        padding: 0;
      }
      .weekday-month {
        padding: 8px 2px;
      }
      .calendar-days-month {
        padding: 0;
      }
      .days-header {
        padding: 0;
      }
      .day-header {
        padding: 8px 2px;
      }
      .day-header-day {
        padding: 8px 12px;
      }
      .current-date-title {
        font-size: 18px;
        min-width: auto;
      }
      .form-row-google {
        grid-template-columns: 1fr;
      }
      .calendar-days-month {
        padding: 0;
      }
      .calendar-day-month {
        padding: 4px 2px;
      }
      .days-content {
        padding: 0;
      }
      .day-content {
        padding: 0;
      }
    }
  </style>

  <script type="application/json" id="schedule-data">@jsonvar schedule_data</script>
  <script type="application/json" id="clients-data">@jsonvar clients_data</script>
  
  <script>
    (function() {
      // Load data
      const scheduleData = JSON.parse(document.getElementById('schedule-data').textContent);
      const clientsData = JSON.parse(document.getElementById('clients-data').textContent);
      
      // Store schedules in memory
      let schedules = scheduleData.schedules || [];
      
      // Calendar state
      let currentDate = new Date();
      let currentView = 'month';
      let selectedDate = null;
      
      // Calendar types
      const calendarTypes = [
        { id: '見積もり提出', name: '見積もり提出', color: '#4285f4', visible: true },
        { id: '商談', name: '商談', color: '#fbbc04', visible: true },
        { id: '定期訪問', name: '定期訪問', color: '#34a853', visible: true },
        { id: '清掃状況確認', name: '清掃状況確認', color: '#ea4335', visible: true },
        { id: 'その他', name: 'その他', color: '#9aa0a6', visible: true }
      ];
      
      // Drag & Drop state
      let dragState = {
        isDragging: false,
        isResizing: false,
        scheduleId: null,
        scheduleElement: null,
        startX: 0,
        startY: 0,
        startDate: null,
        startTime: null,
        resizeType: null
      };
      
      // Initialize
      init();
      
      function init() {
        // Render calendar list
        renderCalendarList();
        
        // View tabs
        document.querySelectorAll('.view-tab-sidebar').forEach(tab => {
          tab.addEventListener('click', () => {
            switchView(tab.dataset.view);
          });
        });
        
        // Navigation
        document.getElementById('prev-btn').addEventListener('click', () => navigate(-1));
        document.getElementById('next-btn').addEventListener('click', () => navigate(1));
        document.getElementById('today-btn').addEventListener('click', () => {
          currentDate = new Date();
          renderCurrentView();
        });
        
        // Menu toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
          document.querySelector('.calendar-sidebar').classList.toggle('open');
        });
        
        // Create button
        document.querySelector('.create-btn').addEventListener('click', () => {
          openScheduleModal();
        });
        
        // Modal
        document.getElementById('modal-close').addEventListener('click', closeScheduleModal);
        document.getElementById('modal-cancel').addEventListener('click', closeScheduleModal);
        document.getElementById('schedule-form').addEventListener('submit', handleScheduleSubmit);
        document.getElementById('modal-delete').addEventListener('click', handleScheduleDelete);
        
        // Populate client select
        populateClientSelect();
        
        // Initial render
        renderCurrentView();
      }
      
      function renderCalendarList() {
        const container = document.getElementById('calendar-list-items');
        container.innerHTML = '';
        
        calendarTypes.forEach(type => {
          const item = document.createElement('div');
          item.className = `calendar-item ${type.visible ? '' : 'hidden'}`;
          item.innerHTML = `
            <div class="calendar-color purpose-${type.id}" style="background: ${type.color}"></div>
            <span class="calendar-name">${type.name}</span>
            <div class="calendar-toggle"></div>
          `;
          item.addEventListener('click', (e) => {
            if (e.target.classList.contains('calendar-toggle') || e.target.closest('.calendar-toggle')) {
              type.visible = !type.visible;
              item.classList.toggle('hidden');
              renderCurrentView();
            }
          });
          container.appendChild(item);
        });
      }
      
      function switchView(view) {
        currentView = view;
        document.querySelectorAll('.view-tab-sidebar').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.view === view);
        });
        document.querySelectorAll('.calendar-view').forEach(v => {
          v.classList.add('hidden');
        });
        document.getElementById(`${view}-view`).classList.remove('hidden');
        renderCurrentView();
      }
      
      function navigate(direction) {
        if (currentView === 'month') {
          currentDate.setMonth(currentDate.getMonth() + direction);
        } else if (currentView === 'week') {
          currentDate.setDate(currentDate.getDate() + (direction * 7));
        } else if (currentView === 'day') {
          currentDate.setDate(currentDate.getDate() + direction);
        }
        renderCurrentView();
      }
      
      function renderCurrentView() {
        if (currentView === 'month') {
          renderMonthView();
        } else if (currentView === 'week') {
          renderWeekView();
        } else if (currentView === 'day') {
          renderDayView();
        }
        updateDateTitle();
      }
      
      function updateDateTitle() {
        const titleEl = document.getElementById('current-date-title');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const day = currentDate.getDate();
        
        if (currentView === 'month') {
          titleEl.textContent = `${year}年${month}月`;
        } else if (currentView === 'week') {
          const startOfWeek = getStartOfWeek(currentDate);
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(endOfWeek.getDate() + 6);
          titleEl.textContent = `${formatDateDisplay(startOfWeek)} - ${formatDateDisplay(endOfWeek)}`;
        } else if (currentView === 'day') {
          titleEl.textContent = `${year}年${month}月${day}日`;
        }
      }
      
      function renderMonthView() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const container = document.getElementById('calendar-days-month');
        container.innerHTML = '';
        
        // Previous month days
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = startingDayOfWeek - 1; i >= 0; i--) {
          const dayNum = prevMonthLastDay - i;
          const prevMonth = month === 0 ? 11 : month - 1;
          const prevYear = month === 0 ? year - 1 : year;
          const dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
          container.appendChild(createDayElement(dayNum, true, dateStr));
        }
        
        // Current month days
        const today = new Date();
        for (let i = 1; i <= daysInMonth; i++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          const dayEl = createDayElement(i, false, dateStr);
          if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
            dayEl.classList.add('today');
          }
          container.appendChild(dayEl);
        }
        
        // Next month days
        const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
        for (let i = 1; i <= remainingDays; i++) {
          const nextMonth = month === 11 ? 0 : month + 1;
          const nextYear = month === 11 ? year + 1 : year;
          const dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          container.appendChild(createDayElement(i, true, dateStr));
        }
      }
      
      function createDayElement(dayNumber, isOtherMonth, dateStr) {
        const day = document.createElement('div');
        day.className = 'calendar-day-month';
        if (isOtherMonth) {
          day.classList.add('other-month');
        }
        day.dataset.date = dateStr;
        
        const dayNumberEl = document.createElement('div');
        dayNumberEl.className = 'day-number';
        dayNumberEl.textContent = dayNumber;
        day.appendChild(dayNumberEl);
        
        // Get visible schedules for this day
        const daySchedules = schedules.filter(s => {
          if (s.date !== dateStr || s.status === 'completed') return false;
          const calendarType = calendarTypes.find(t => t.id === s.purpose);
          return calendarType && calendarType.visible;
        });
        
        if (daySchedules.length > 0) {
          daySchedules.sort((a, b) => a.time.localeCompare(b.time));
          const eventsDiv = document.createElement('div');
          eventsDiv.className = 'day-events';
          
          const maxVisible = 3;
          daySchedules.slice(0, maxVisible).forEach(schedule => {
            const eventEl = document.createElement('div');
            eventEl.className = `day-event purpose-${schedule.purpose}`;
            eventEl.textContent = `${schedule.time} ${schedule.client_name || schedule.purpose}`;
            eventEl.addEventListener('click', (e) => {
              e.stopPropagation();
              openScheduleModal(null, schedule.id);
            });
            eventsDiv.appendChild(eventEl);
          });
          
          if (daySchedules.length > maxVisible) {
            const moreEl = document.createElement('div');
            moreEl.className = 'day-event-more';
            moreEl.textContent = `+${daySchedules.length - maxVisible}件`;
            eventsDiv.appendChild(moreEl);
          }
          
          day.appendChild(eventsDiv);
        }
        
        day.addEventListener('click', (e) => {
          if (!e.target.closest('.day-event')) {
            openScheduleModal(dateStr);
          }
        });
        
        return day;
      }
      
      function renderWeekView() {
        const startOfWeek = getStartOfWeek(currentDate);
        const today = new Date();
        
        // Render time slots
        const timeSlots = document.getElementById('time-slots-week');
        timeSlots.innerHTML = '';
        for (let hour = 0; hour < 24; hour++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          slot.textContent = `${String(hour).padStart(2, '0')}:00`;
          timeSlots.appendChild(slot);
        }
        
        // Render day headers
        const daysHeader = document.getElementById('days-header-week');
        daysHeader.innerHTML = '';
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        for (let i = 0; i < 7; i++) {
          const day = new Date(startOfWeek);
          day.setDate(startOfWeek.getDate() + i);
          const dateStr = formatDate(day);
          const header = document.createElement('div');
          header.className = 'day-header';
          if (formatDate(day) === formatDate(today)) {
            header.classList.add('today');
          }
          header.innerHTML = `
            <div class="day-header-name">${dayNames[i]}</div>
            <div class="day-header-number">${day.getDate()}</div>
          `;
          daysHeader.appendChild(header);
        }
        
        // Render day columns
        const daysContent = document.getElementById('days-content-week');
        daysContent.innerHTML = '';
        for (let i = 0; i < 7; i++) {
          const day = new Date(startOfWeek);
          day.setDate(startOfWeek.getDate() + i);
          const dateStr = formatDate(day);
          
          const dayColumn = document.createElement('div');
          dayColumn.className = 'day-column-week';
          
          for (let hour = 0; hour < 24; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'day-time-slot';
            timeSlot.dataset.date = dateStr;
            timeSlot.dataset.hour = hour;
            
            // Find schedules for this day and hour
            const hourSchedules = schedules.filter(s => {
              if (s.date !== dateStr || s.status === 'completed') return false;
              const scheduleHour = parseInt(s.time.split(':')[0]);
              if (scheduleHour !== hour) return false;
              const calendarType = calendarTypes.find(t => t.id === s.purpose);
              return calendarType && calendarType.visible;
            });
            
            hourSchedules.forEach(schedule => {
              const eventEl = createWeekEvent(schedule, dateStr, hour);
              timeSlot.appendChild(eventEl);
            });
            
            timeSlot.addEventListener('click', (e) => {
              if (!e.target.closest('.week-event')) {
                const defaultTime = `${String(hour).padStart(2, '0')}:00`;
                openScheduleModal(dateStr, null, defaultTime);
              }
            });
            
            dayColumn.appendChild(timeSlot);
          }
          
          daysContent.appendChild(dayColumn);
        }
      }
      
      function createWeekEvent(schedule, dateStr, hour) {
        const eventEl = document.createElement('div');
        eventEl.className = `week-event purpose-${schedule.purpose}`;
        eventEl.dataset.scheduleId = schedule.id;
        const [scheduleHour, scheduleMinute] = schedule.time.split(':').map(Number);
        const topPercent = (scheduleMinute / 60) * 100;
        eventEl.style.top = `${topPercent}%`;
        eventEl.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 2px;">${schedule.time}</div>
          <div style="font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${schedule.client_name || schedule.purpose}</div>
          <div class="resize-handle resize-handle-top"></div>
          <div class="resize-handle"></div>
        `;
        
        eventEl.addEventListener('click', (e) => {
          if (!dragState.isDragging && !dragState.isResizing) {
            e.stopPropagation();
            openScheduleModal(null, schedule.id);
          }
        });
        
        // Setup drag handlers
        setupDragHandlers(eventEl, schedule, 'week');
        
        return eventEl;
      }
      
      function renderDayView() {
        const dateStr = formatDate(currentDate);
        const today = new Date();
        
        // Render time slots
        const timeSlots = document.getElementById('time-slots-day');
        timeSlots.innerHTML = '';
        for (let hour = 0; hour < 24; hour++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          slot.textContent = `${String(hour).padStart(2, '0')}:00`;
          timeSlots.appendChild(slot);
        }
        
        // Render day header
        const dayHeader = document.getElementById('day-header-day');
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        const dayName = dayNames[currentDate.getDay()];
        dayHeader.innerHTML = `
          <div class="day-header-name">${dayName}</div>
          <div class="day-header-number">${currentDate.getDate()}</div>
        `;
        if (formatDate(currentDate) === formatDate(today)) {
          dayHeader.classList.add('today');
        }
        
        // Render day content
        const dayContent = document.getElementById('day-content-day');
        dayContent.innerHTML = '';
        
        const daySchedules = schedules.filter(s => {
          if (s.date !== dateStr || s.status === 'completed') return false;
          const calendarType = calendarTypes.find(t => t.id === s.purpose);
          return calendarType && calendarType.visible;
        });
        daySchedules.sort((a, b) => a.time.localeCompare(b.time));
        
        for (let hour = 0; hour < 24; hour++) {
          const timeSlot = document.createElement('div');
          timeSlot.className = 'day-time-slot';
          timeSlot.dataset.hour = hour;
          
          const hourSchedules = daySchedules.filter(s => {
            const scheduleHour = parseInt(s.time.split(':')[0]);
            return scheduleHour === hour;
          });
          
          if (hourSchedules.length > 0) {
            hourSchedules.forEach(schedule => {
              const eventEl = createDayEvent(schedule);
              timeSlot.appendChild(eventEl);
            });
          } else {
            timeSlot.addEventListener('click', () => {
              const defaultTime = `${String(hour).padStart(2, '0')}:00`;
              openScheduleModal(dateStr, null, defaultTime);
            });
          }
          
          dayContent.appendChild(timeSlot);
        }
      }
      
      function createDayEvent(schedule) {
        const eventEl = document.createElement('div');
        eventEl.className = `day-event purpose-${schedule.purpose}`;
        eventEl.dataset.scheduleId = schedule.id;
        eventEl.innerHTML = `
          <div class="day-schedule-time">${schedule.time}</div>
          <div class="day-schedule-title">${schedule.client_name}</div>
          ${schedule.store_name ? `<div class="day-schedule-details">${schedule.store_name}</div>` : ''}
          <div class="day-schedule-details">${schedule.purpose}</div>
        `;
        
        eventEl.addEventListener('click', (e) => {
          if (!dragState.isDragging) {
            e.stopPropagation();
            openScheduleModal(null, schedule.id);
          }
        });
        
        // Setup drag handlers
        setupDragHandlers(eventEl, schedule, 'day');
        
        return eventEl;
      }
      
      function setupDragHandlers(element, schedule, view) {
        // Drag start
        element.addEventListener('mousedown', (e) => {
          if (e.target.classList.contains('resize-handle')) {
            dragState.isResizing = true;
            dragState.resizeType = e.target.classList.contains('resize-handle-top') ? 'top' : 'bottom';
          } else {
            dragState.isDragging = true;
          }
          dragState.scheduleId = schedule.id;
          dragState.scheduleElement = element;
          dragState.startX = e.clientX;
          dragState.startY = e.clientY;
          dragState.startDate = schedule.date;
          dragState.startTime = schedule.time;
          element.classList.add('dragging');
          e.preventDefault();
        });
        
        // Drag move
        document.addEventListener('mousemove', (e) => {
          if (!dragState.isDragging && !dragState.isResizing) return;
          e.preventDefault();
          // Drag implementation would go here
        });
        
        // Drag end
        document.addEventListener('mouseup', () => {
          if (dragState.isDragging || dragState.isResizing) {
            dragState.isDragging = false;
            dragState.isResizing = false;
            if (dragState.scheduleElement) {
              dragState.scheduleElement.classList.remove('dragging');
            }
            dragState.scheduleElement = null;
          }
        });
      }
      
      function openScheduleModal(dateStr = null, scheduleId = null, defaultTime = null) {
        const modal = document.getElementById('schedule-modal');
        const form = document.getElementById('schedule-form');
        const modalTitle = document.getElementById('modal-title');
        const deleteBtn = document.getElementById('modal-delete');
        
        form.reset();
        document.getElementById('schedule-id').value = '';
        
        if (scheduleId) {
          const schedule = schedules.find(s => s.id === scheduleId);
          if (schedule) {
            modalTitle.textContent = 'スケジュールを編集';
            deleteBtn.classList.remove('hidden');
            document.getElementById('schedule-id').value = schedule.id;
            document.getElementById('schedule-title').value = schedule.client_name || '';
            document.getElementById('schedule-date').value = schedule.date;
            const [startHour, startMin] = schedule.time.split(':');
            document.getElementById('schedule-time-start').value = `${startHour}:${startMin}`;
            // Assume 1 hour duration
            const endTime = new Date(`2000-01-01T${startHour}:${startMin}`);
            endTime.setHours(endTime.getHours() + 1);
            document.getElementById('schedule-time-end').value = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
            document.getElementById('schedule-calendar-type').value = schedule.purpose;
            document.getElementById('schedule-client').value = schedule.client_id || '';
            document.getElementById('schedule-store').value = schedule.store_name || '';
            document.getElementById('schedule-address').value = schedule.address || '';
            document.getElementById('schedule-notes').value = schedule.notes || '';
          }
        } else {
          modalTitle.textContent = 'スケジュールを作成';
          deleteBtn.classList.add('hidden');
          if (dateStr) {
            document.getElementById('schedule-date').value = dateStr;
          }
          if (defaultTime) {
            document.getElementById('schedule-time-start').value = defaultTime;
            const [hour, min] = defaultTime.split(':');
            const endTime = new Date(`2000-01-01T${hour}:${min}`);
            endTime.setHours(endTime.getHours() + 1);
            document.getElementById('schedule-time-end').value = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
          }
        }
        
        modal.classList.remove('hidden');
      }
      
      function closeScheduleModal() {
        document.getElementById('schedule-modal').classList.add('hidden');
      }
      
      function handleScheduleSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const scheduleId = formData.get('id');
        
        const schedule = {
          id: scheduleId || `schedule-${Date.now()}`,
          date: formData.get('date'),
          time: formData.get('time_start'),
          client_id: formData.get('client_id'),
          client_name: getClientName(formData.get('client_id')) || formData.get('title'),
          store_name: formData.get('store_name'),
          purpose: formData.get('calendar_type'),
          address: formData.get('address'),
          notes: formData.get('notes'),
          status: 'upcoming'
        };
        
        if (scheduleId) {
          const index = schedules.findIndex(s => s.id === scheduleId);
          if (index !== -1) {
            schedules[index] = schedule;
          }
        } else {
          schedules.push(schedule);
        }
        
        closeScheduleModal();
        renderCurrentView();
        alert('スケジュールを保存しました');
      }
      
      function handleScheduleDelete() {
        const scheduleId = document.getElementById('schedule-id').value;
        if (!scheduleId) return;
        
        if (confirm('このスケジュールを削除しますか？')) {
          schedules = schedules.filter(s => s.id !== scheduleId);
          closeScheduleModal();
          renderCurrentView();
          alert('スケジュールを削除しました');
        }
      }
      
      function populateClientSelect() {
        const select = document.getElementById('schedule-client');
        select.innerHTML = '<option value="">選択してください</option>';
        
        if (clientsData.clients) {
          clientsData.clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.company_name;
            select.appendChild(option);
          });
        }
      }
      
      function getClientName(clientId) {
        if (!clientsData.clients) return '';
        const client = clientsData.clients.find(c => c.id === clientId);
        return client ? client.company_name : '';
      }
      
      function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day;
        return new Date(d.setDate(diff));
      }
      
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      
      function formatDateDisplay(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${year}年${month}月${day}日`;
      }
    })();
  </script>
</main>
