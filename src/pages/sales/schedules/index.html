@layout('layouts.base')
@json('data/meta/sales_schedules_title.json', $title)
@json('data/meta/sales_schedules_body_class.json', $body_class)

<link rel="stylesheet" href="/css/sales-schedules.css" />
<link rel="stylesheet" href="/css/sales-clients.css" />
<link rel="stylesheet" href="/css/staff-mypage-inline.css" />
<script src="/js/data_utils.js"></script>
<script src="/js/aws-services-api.js"></script>
<style>
  .page-title-block {
    display: flex;
    margin: 12px 0 10px;
  }

  /* Modal Form Styles Override */
  .schedule-dialog .dialog-content {
    max-width: 800px;
    width: 95%;
    max-height: 90vh;
    max-height: 90dvh;
    /* Mobile friendly */
    padding: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border-radius: 8px;
    /* Ensure rounded corners */
  }

  .schedule-dialog h3 {
    padding: 12px 16px;
    margin: 0;
    border-bottom: 1px solid #e2e8f0;
    font-size: 1.1rem;
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
    flex-shrink: 0;
    /* Prevent shrinking */
  }

  .schedule-dialog form {
    padding: 16px;
    overflow-y: auto;
    flex: 1;
    -webkit-overflow-scrolling: touch;
    /* iOS smooth scrolling */
    overscroll-behavior: contain;
    /* Prevent body scroll chaining */
  }

  .dialog-actions {
    padding: 12px 16px;
    border-top: 1px solid #e2e8f0;
    background: #f8fafc;
    position: sticky;
    bottom: 0;
    z-index: 10;
  }

  #calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e2e8f0;
    border: 1px solid #e2e8f0;
  }

  .calendar-day {
    background: #fff;
    min-height: 100px;
    padding: 4px;
    position: relative;
    cursor: pointer;
  }

  .calendar-day.empty {
    background: #f8fafc;
    cursor: default;
  }

  .hierarchy-section {
    margin-bottom: 20px;
    background: #f8fafc;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #e2e8f0;
  }

  .hierarchy-header {
    font-weight: 600;
    color: #475569;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
  }

  .request-basic-info-section {
    background: #fff;
    border: 2px solid #ff679c;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 20px;
  }

  .intake-category {
    margin-bottom: 16px;
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .intake-category-title {
    font-weight: 600;
    color: #334155;
    border-bottom: 2px solid #cbd5e1;
    padding-bottom: 8px;
    margin-bottom: 16px;
    font-size: 0.95rem;
  }

  /* Filter Pills */
  .filter-pill {
    cursor: pointer;
  }

  .filter-pill input {
    display: none;
  }

  .filter-pill span {
    display: inline-block;
    padding: 6px 12px;
    background: #f1f5f9;
    color: #64748b;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    border: 1px solid transparent;
  }

  .filter-pill input:checked+span {
    background: #fdf2f8;
    /* Light Pink */
    color: #db2777;
    /* Deep Pink */
    border-color: #fce7f3;
    background: #FF679C;
    color: white;
  }
</style>

<main id="main" class="container sales-schedules" style="padding-bottom: 80px; margin-bottom: 80px;">
  <div class="page-header">
    <div class="header-actions">
      <!-- Default View is Calendar now -->
      <button type="button" class="btn-icon" id="view-toggle" title="リスト表示">
        <i class="fas fa-list"></i>
      </button>
      <button type="button" class="btn btn-primary btn-sm" id="add-schedule-btn">
        <i class="fas fa-plus"></i> 依頼書作成
      </button>
    </div>
  </div>

  <!-- 新規案件アラート -->
  <div class="new-project-alert hidden" id="draft-alert">
    <div class="new-project-alert-icon">
      <i class="fas fa-clock"></i>
    </div>
    <div class="new-project-alert-content">
      <div class="new-project-alert-title">未アサインの依頼書</div>
      <div class="new-project-alert-text" id="draft-alert-text">担当者未定の依頼書が<span id="draft-count">0</span>件あります。</div>
    </div>
    <button class="new-project-alert-btn" onclick="filterNewProjects()">
      <i class="fas fa-list"></i> 確認する
    </button>
  </div>

  <div class="page-title-block">
    <button class="client-tab active" type="button" aria-label="スケジュール管理">
      <i class="fas fa-calendar"></i>
      <span>スケジュール管理</span>
    </button>
  </div>

  <!-- フィルター -->
  <div class="filter-section">
    <div class="action-bar" style="justify-content: flex-start; gap: 16px;">
      <div class="filter-group">
        <label><i class="fas fa-calendar-alt"></i> 年月</label>
        <input type="month" id="month-picker" onchange="changeMonth()"
          style="border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px;">
      </div>
      <!-- Store, DateRange, Reset removed -->
    </div>
  </div>

  <!-- リスト表示 (Default Hidden) -->
  <div class="schedule-list-view" id="list-view" style="display:none;">
    <div class="schedule-card-list" id="schedule-card-list">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i> 読み込み中...
      </div>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- カレンダー表示 (Default Visible) -->
  <div class="schedule-calendar-view" id="calendar-view">
    <div class="calendar-header">
      <button type="button" class="btn btn-icon" id="prev-month">
        <i class="fas fa-chevron-left"></i>
      </button>
      <h2 id="calendar-month">2025年11月</h2>
      <button type="button" class="btn btn-icon" id="next-month">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    <div class="calendar-weekdays">
      <div class="calendar-day-header sun">日</div>
      <div class="calendar-day-header">月</div>
      <div class="calendar-day-header">火</div>
      <div class="calendar-day-header">水</div>
      <div class="calendar-day-header">木</div>
      <div class="calendar-day-header">金</div>
      <div class="calendar-day-header sat">土</div>
    </div>
    <div class="calendar-grid" id="calendar-days"></div>
  </div>
</main>

<!-- クイックアクションドック -->
<nav class="quick-actions-dock" aria-label="クイックアクション">
  <a href="/sales/mypage" class="dock-item">
    <i class="fas fa-chart-line"></i>
    <span>アクティビティ</span>
  </a>
  <a href="/sales/dashboard" class="dock-item">
    <i class="fas fa-user-plus"></i>
    <span>顧客</span>
  </a>
  <a href="/sales/schedules" class="dock-item is-active">
    <i class="fas fa-calendar"></i>
    <span>スケジュール</span>
  </a>
  <!-- 日次依頼一覧モーダル -->
  <dialog id="daily-schedule-dialog" class="schedule-dialog">
    <div class="dialog-content">
      <h3>
        <span id="daily-dialog-date"></span> の依頼一覧
        <button type="button" class="close-btn" onclick="document.getElementById('daily-schedule-dialog').close()"
          style="float:right; border:none; background:none; font-size:1.2rem; cursor:pointer;">&times;</button>
      </h3>
      <div id="daily-schedule-list" style="padding:16px; overflow-y:auto; flex:1;">
        <!-- Schedules will be rendered here -->
      </div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary"
          onclick="document.getElementById('daily-schedule-dialog').close()">閉じる</button>
      </div>
    </div>
  </dialog>
  <dialog id="print-preview-dialog"
    style="border:none;border-radius:12px;padding:0;width:95%;max-width:900px;height:90vh;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <div style="display:flex;flex-direction:column;height:100%;">
      <div
        style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;background:#fff;">
        <h3 style="margin:0;font-size:1.1rem;font-weight:600;color:#333;">依頼書プレビュー</h3>
        <button onclick="document.getElementById('print-preview-dialog').close()"
          style="border:none;background:none;font-size:1.5rem;cursor:pointer;color:#666;line-height:1;">&times;</button>
      </div>
      <!-- Iframe Container -->
      <div style="flex:1;background:#525659;padding:0;overflow:hidden;position:relative;">
        <iframe id="print-preview-frame" style="width:100%;height:100%;border:none;display:block;"></iframe>
      </div>
      <div
        style="padding:16px;display:flex;justify-content:flex-end;gap:12px;border-top:1px solid #eee;background:#fff;">
        <button class="btn btn-secondary" onclick="document.getElementById('print-preview-dialog').close()">閉じる</button>
        <button class="btn btn-primary" onclick="document.getElementById('print-preview-frame').contentWindow.print()">
          <i class="fas fa-print"></i> 印刷する
        </button>
      </div>
    </div>
  </dialog>
  <dialog id="schedule-dialog" class="schedule-dialog">
    <div class="dialog-content">
      <button type="button" class="dialog-close" onclick="document.getElementById('schedule-dialog').close()">
        <i class="fas fa-times"></i>
      </button>
      <h3 id="dialog-title">依頼書作成</h3>
      <form id="schedule-form">
        <input type="hidden" id="schedule-id" name="id">

        <!-- 顧客選択セクション -->
        <div class="hierarchy-section">
          <div class="hierarchy-header">
            <i class="fas fa-building"></i> 顧客選択
            <button type="button" class="btn btn-sm btn-text" id="reload-customers-data-btn" style="margin-left:auto;">
              <i class="fas fa-sync-alt"></i> 更新
            </button>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="schedule-store-search">店舗・ブランド・法人名 <span class="required">*</span></label>
              <div class="store-search-wrapper">
                <div class="store-search-type-selector" style="display:flex; gap:8px; margin-bottom:8px;">
                  <label class="filter-pill"><input type="radio" name="store_search_mode" value=""
                      checked><span>全て</span></label>
                  <label class="filter-pill"><input type="radio" name="store_search_mode"
                      value="store"><span>店舗</span></label>
                  <label class="filter-pill"><input type="radio" name="store_search_mode"
                      value="brand"><span>ブランド</span></label>
                  <label class="filter-pill"><input type="radio" name="store_search_mode"
                      value="client"><span>法人</span></label>
                </div>
                <input type="text" id="schedule-store-search" placeholder="検索..." autocomplete="off" required>
                <input type="hidden" id="schedule-store" name="store_id">
                <div class="store-search-results" id="schedule-store-results" style="display: none;"></div>
              </div>
              <div id="schedule-store-summary" style="margin-top:8px;color:#6b7280;font-size:0.875rem;">
                <span id="schedule-store-summary-text">未選択</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 依頼基本情報セクション -->
        <div class="request-basic-info-section">
          <div class="hierarchy-header" style="color:#ff679c; border-bottom:1px solid #ff679c; padding-bottom:4px;">
            <i class="fas fa-clock"></i> 依頼基本情報
          </div>
          <div class="form-row">
            <div class="form-field half">
              <label for="schedule-date">日付 <span class="required">*</span></label>
              <input type="date" id="schedule-date" name="scheduled_date" required>
            </div>
            <div class="form-field half">
              <label for="schedule-time">時間 <span class="required">*</span></label>
              <input type="time" id="schedule-time" name="scheduled_time" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>清掃内容 <span class="required">*</span></label>
              <div class="cleaning-items-search-wrapper">
                <input type="text" id="cleaning-items-search" placeholder="清掃内容を追加..." autocomplete="off">
                <div class="cleaning-items-results" id="cleaning-items-results" style="display: none;"></div>
              </div>
              <div class="cleaning-items-selected" id="cleaning-items-selected" style="margin-top:8px;"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field half">
              <label for="schedule-sales">営業担当</label>
              <select id="schedule-sales" name="sales_id">
                <option value="">未設定</option>
              </select>
            </div>
            <div class="form-field half">
              <label>指定清掃員（OS）</label>
              <div class="worker-search-wrapper" style="position:relative;">
                <input type="text" id="worker-search-input" placeholder="清掃員を指定（クリックで一覧）" autocomplete="off"
                  style="width:100%; border:1px solid #ccc; padding:10px; border-radius:4px;">
                <div id="worker-search-results"
                  style="display:none; position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e5e7eb; border-radius:8px; max-height:250px; overflow-y:auto; z-index:1000; box-shadow:0 10px 25px rgba(0,0,0,0.1);">
                </div>
              </div>
              <div id="selected-workers-container" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:4px;">
                <span style="color:#9ca3af; font-size:0.85rem;">オープン（未割当）</span>
              </div>
              <small style="color:#666;">※選択しない場合「オープン」となります</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label for="schedule-notes">備考</label>
              <textarea id="schedule-notes" name="notes" rows="2" placeholder="特記事項があれば入力"></textarea>
            </div>
          </div>
        </div>

        <!-- カルテ（問診票）セクション -->
        <div class="hierarchy-section">
          <div class="hierarchy-header">
            <i class="fas fa-clipboard-list"></i> カルテ情報
            <small style="color:#64748b; font-weight:normal; margin-left:8px;">※この内容は顧客カルテにも保存されます</small>
          </div>

          <!-- 基本ヒアリング (Stacked) -->
          <div class="intake-category">
            <div class="intake-category-title"><i class="fas fa-clipboard-check"></i> 基本ヒアリング</div>
            <div class="form-row">
              <div class="form-field">
                <label style="font-weight:600; font-size:0.9rem; margin-bottom:4px; display:block;">清掃の悩み</label>
                <textarea class="form-field" id="survey-issue" rows="2"></textarea>
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label style="font-weight:600; font-size:0.9rem; margin-bottom:4px; display:block;">店内環境</label>
                <textarea class="form-field" id="survey-environment" rows="2"></textarea>
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label style="font-weight:600; font-size:0.9rem; margin-bottom:4px; display:block;">通常清掃の頻度</label>
                <input class="form-field" id="survey-cleaning-frequency" type="text" placeholder="例：毎日30分">
              </div>
            </div>
          </div>

          <!-- 店舗仕様 -->
          <div class="intake-category">
            <div class="intake-category-title"><i class="fas fa-store"></i> 店舗仕様</div>
            <!-- Compact fields kept as is, but ensuring wrapper exists if needed -->
            <div class="info-item form-item">
              <div class="compact-fields">
                <label class="compact-field">
                  <span>平米数/坪数</span>
                  <input class="form-field" id="survey-area-sqm" type="text">
                </label>
                <label class="compact-field">
                  <span>出入口</span>
                  <input class="form-field" id="survey-entrances" type="text">
                </label>
                <label class="compact-field">
                  <span>天井高さ</span>
                  <input class="form-field" id="survey-ceiling-height" type="text">
                </label>
                <label class="compact-field">
                  <span>鍵の位置</span>
                  <input class="form-field" id="survey-key-location" type="text">
                </label>
                <label class="compact-field">
                  <span>ブレーカー</span>
                  <input class="form-field" id="survey-breaker-location" type="text">
                </label>
              </div>
            </div>
          </div>

          <!-- 設備・内装 (Stacked Checkboxes) -->
          <div class="intake-category">
            <div class="intake-category-title"><i class="fas fa-cogs"></i> 設備・内装</div>
            <div class="info-item form-item">
              <div class="compact-fields">
                <label class="compact-field"><span>壁材質</span><input class="form-field" id="survey-wall-material"
                    type="text"></label>
                <label class="compact-field"><span>床材質</span><input class="form-field" id="survey-floor-material"
                    type="text"></label>
                <label class="compact-field"><span>トイレ数</span><input class="form-field" id="survey-toilet-count"
                    type="text"></label>
              </div>
            </div>
            <div class="form-row" style="margin-top:16px;">
              <div class="form-field">
                <label style="font-weight:600; font-size:0.9rem; margin-bottom:8px; display:block;">設備チェック</label>
                <div class="checkbox-group" id="survey-equipment" style="display:flex; flex-wrap:wrap; gap:8px;">
                  <label class="checkbox-chip"><input type="checkbox" value="aircon"><span>空調</span></label>
                  <label class="checkbox-chip"><input type="checkbox" value="duct"><span>ダクト</span></label>
                  <label class="checkbox-chip"><input type="checkbox" value="hood"><span>フード</span></label>
                  <label class="checkbox-chip"><input type="checkbox" value="grease_trap"><span>グリスト</span></label>
                  <label class="checkbox-chip"><input type="checkbox" value="floor"><span>床</span></label>
                  <label class="checkbox-chip"><input type="checkbox" value="drain"><span>排水溝</span></label>
                </div>
              </div>
            </div>
          </div>

          <!-- 注意事項・計画 (Stacked) -->
          <div class="intake-category">
            <div class="intake-category-title"><i class="fas fa-exclamation-circle"></i> 注意事項・計画</div>
            <div class="form-row">
              <div class="form-field">
                <label style="font-weight:600; font-size:0.9rem; margin-bottom:4px; display:block;">特に気になる場所</label>
                <textarea class="form-field" id="survey-hotspots" rows="2"></textarea>
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label style="font-weight:600; font-size:0.9rem; margin-bottom:4px; display:block;">注意事項（特記事項）</label>
                <textarea class="form-field" id="survey-notes" rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="info-item form-item">
          <span class="info-label">注意事項（特記事項）</span>
          <textarea class="form-field" id="survey-notes" rows="2"></textarea>
        </div>
    </div>
    </div>

    <div class="form-status" id="form-status"></div>
    <div class="dialog-actions" style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <!-- Print Button (Hidden for new) -->
        <button type="button" class="btn btn-outline" id="print-request-btn" style="display:none; margin-right:auto;">
          <i class="fas fa-print"></i> 依頼書発行
        </button>
      </div>
      <div style="display:flex; gap:12px;">
        <button type="button" class="btn btn-secondary"
          onclick="document.getElementById('schedule-dialog').close()">キャンセル</button>
        <button type="button" class="btn btn-primary" id="edit-btn" style="display:none;">編集する</button>
        <button type="submit" class="btn btn-primary" id="save-btn">保存</button>
      </div>
    </div>
    </form>
    </div>
  </dialog>

  <!-- 削除確認ダイアログ -->
  <dialog id="delete-dialog" class="delete-dialog">
    <div class="dialog-content dialog-sm">
      <h3>削除確認</h3>
      <p id="delete-message">この依頼書を削除しますか？</p>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary"
          onclick="document.getElementById('delete-dialog').close()">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
      </div>
    </div>
  </dialog>

  <script src="/js/aws-s3-upload.js"></script>
  <script src="/js/sales-schedules.js"></script>