@layout('layouts.base')
@json('data/meta/sales_schedules_new_title.json', $title)
@json('data/meta/sales_schedules_new_body_class.json', $body_class)

<link rel="stylesheet" href="/css/sales-schedules.css" />
<script src="/js/data_utils.js"></script>
<script src="/js/aws-services-api.js"></script>

<main id="main" class="container sales-schedules-new">
  <div class="page-header">
    <a href="/sales/schedules" class="back-btn">
      <i class="fas fa-chevron-left"></i>
    </a>
    <h1 class="page-title">スケジュール作成</h1>
  </div>

  <form id="schedule-form" class="schedule-form-new">
    <input type="hidden" id="schedule-id" name="id">

    <div class="form-row three-col">
      <div class="form-field">
        <label for="select-client">法人名 <span class="required">*</span></label>
        <select id="select-client" class="form-select search-select">
          <option value="">法人を選択してください</option>
        </select>
        <div class="search-helper-text">法人を選択するとブランドが絞り込まれます</div>
      </div>
      <div class="form-field">
        <label for="select-brand">ブランド名 <span class="required">*</span></label>
        <select id="select-brand" class="form-select search-select" disabled>
          <option value="">先に法人を選択してください</option>
        </select>
      </div>
      <div class="form-field">
        <label for="select-store">店舗名 <span class="required">*</span></label>
        <select id="select-store" class="form-select search-select" disabled>
          <option value="">先にブランドを選択してください</option>
        </select>
        <input type="hidden" id="schedule-store" name="store_id">
      </div>
    </div>

    <!-- 住所等の自動表示エリア -->
    <div id="store-info-display"
      style="display:none; background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:20px;">
      <div style="font-size:0.9rem; color:#374151;">
        <strong><i class="fas fa-map-marker-alt"></i> 住所:</strong> <span id="display-address">-</span>
      </div>
      <div style="font-size:0.9rem; color:#374151; margin-top:4px;">
        <strong><i class="fas fa-phone"></i> 電話:</strong> <span id="display-phone">-</span>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="schedule-address">住所（必要に応じて編集）</label>
        <textarea id="schedule-address" name="address" rows="2" placeholder="住所を入力（店舗選択で自動入力されます）"></textarea>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field half">
        <label for="schedule-phone">電話番号</label>
        <input type="tel" id="schedule-phone" name="phone" placeholder="店舗の電話番号（店舗選択で自動入力）">
      </div>
      <div class="form-field half">
        <label for="schedule-email">メール</label>
        <input type="email" id="schedule-email" name="email" placeholder="連絡先メール（店舗選択で自動入力）">
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="schedule-contact-person">相手先担当者名</label>
        <input type="text" id="schedule-contact-person" name="contact_person" placeholder="当日の相手先担当者（店舗選択で自動入力）">
      </div>
    </div>

    <div class="form-row">
      <div class="form-field half">
        <label for="schedule-date">日付 <span class="required">*</span></label>
        <input type="date" id="schedule-date" name="scheduled_date" required>
      </div>
      <div class="form-field half">
        <label for="schedule-time">時間 <span class="required">*</span></label>
        <input type="time" id="schedule-time" name="scheduled_time" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field half">
        <label for="schedule-duration">作業時間（分）</label>
        <input type="number" id="schedule-duration" name="duration_minutes" value="60" min="15" step="15">
      </div>
      <div class="form-field half">
        <label for="schedule-sales">営業担当者</label>
        <select id="schedule-sales" name="sales_id">
          <option value="">未設定</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field half">
        <label for="schedule-worker">担当清掃員</label>
        <select id="schedule-worker" name="worker_id">
          <option value="">全員（オープン）</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="cleaning-items-search">清掃内容</label>
        <div class="cleaning-items-search-wrapper">
          <div class="store-search-controls">
            <select id="cleaning-category-filter" class="store-category-filter">
              <option value="">全て</option>
              <option value="service">サービス名</option>
            </select>
            <input type="text" id="cleaning-items-search" placeholder="清掃内容（サービス）を検索..." autocomplete="off">
          </div>
          <div class="cleaning-items-results" id="cleaning-items-results" style="display: none;"></div>
        </div>
        <div class="cleaning-items-selected" id="cleaning-items-selected">
          <div style="color: #9ca3af; font-size: 0.875rem; padding: 8px;">選択された清掃内容がありません</div>
        </div>
        <input type="hidden" id="selected-cleaning-items-json" name="cleaning_items">
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="schedule-status">ステータス</label>
        <select id="schedule-status" name="status">
          <option value="draft">未確定</option>
          <option value="scheduled">確定</option>
          <option value="in_progress">作業中</option>
          <option value="completed">完了</option>
          <option value="cancelled">キャンセル</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="schedule-notes">備考</label>
        <textarea id="schedule-notes" name="notes" rows="3" placeholder="特記事項があれば入力"></textarea>
      </div>
    </div>

    <!-- HACCP 問診票 (簡易版) -->
    <div class="form-section haccp-section"
      style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #e5e7eb;">
      <h3 style="color: #059669; margin-bottom: 16px;">
        <i class="fas fa-clipboard-check"></i> HACCP 衛生管理問診票
      </h3>

      <div class="form-row">
        <div class="form-field">
          <label style="font-weight:600; margin-bottom:8px; display:block;">重点管理項目 (指示事項)</label>
          <div class="checkbox-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <label><input type="checkbox" name="haccp_instruction[]" value="temp_control"> 温度管理の徹底</label>
            <label><input type="checkbox" name="haccp_instruction[]" value="cross_contamination"> 交差汚染の防止</label>
            <label><input type="checkbox" name="haccp_instruction[]" value="hand_washing"> 手洗い・身だしなみ</label>
            <label><input type="checkbox" name="haccp_instruction[]" value="cleaning_record"> 清掃実施記録の確認</label>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="haccp-notes">衛生管理に関する特記事項</label>
          <textarea id="haccp-notes" name="haccp_notes" rows="2" placeholder="例: 冷蔵庫の温度記録表を確認すること"></textarea>
        </div>
      </div>
    </div>

    <div class="form-status" id="form-status"></div>
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" onclick="window.location.href='/sales/schedules'">キャンセル</button>
      <button type="submit" class="btn btn-primary">保存</button>
    </div>
  </form>
</main>

<script src="/js/sales-schedules-new.js"></script>