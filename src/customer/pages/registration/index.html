@layout('layouts.base')
@json('data/meta/customer_registration_title.json', $title)
@json('data/meta/customer_registration_body_class.json', $body_class)

<style>
    :root {
        --primary: #f43f5e;
        --primary-600: #e11d48;
        --spot-color: #3b82f6;
        --spot-600: #2563eb;
        --bg-light: #fdf2f8;
        --text-dark: #1f2937;
        --text-muted: #6b7280;
        --border: #e5e7eb;
        --input-bg: #fff;
        --success: #10b981;
        --error: #ef4444;
    }

    * {
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
        min-height: 100vh;
        font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .registration-wrapper {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 24px 80px;
    }

    .registration-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .registration-header img {
        width: 80px;
        height: 80px;
        margin-bottom: 16px;
    }

    .registration-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 0 8px 0;
    }

    .registration-header p {
        color: var(--text-muted);
        font-size: 0.95rem;
        margin: 0;
    }

    /* Form Type Selection */
    .form-type-selection {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    @media (max-width: 600px) {
        .form-type-selection {
            grid-template-columns: 1fr;
        }
    }

    .form-type-card {
        background: #fff;
        border: 3px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .form-type-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .form-type-card.regular:hover,
    .form-type-card.regular.selected {
        border-color: var(--primary);
    }

    .form-type-card.regular.selected {
        background: rgba(244, 63, 94, 0.05);
    }

    .form-type-card.spot:hover,
    .form-type-card.spot.selected {
        border-color: var(--spot-color);
    }

    .form-type-card.spot.selected {
        background: rgba(59, 130, 246, 0.05);
    }

    .form-type-card .icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 24px;
    }

    .form-type-card.regular .icon {
        background: rgba(244, 63, 94, 0.1);
        color: var(--primary);
    }

    .form-type-card.spot .icon {
        background: rgba(59, 130, 246, 0.1);
        color: var(--spot-color);
    }

    .form-type-card h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 0 8px 0;
    }

    .form-type-card p {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0;
        line-height: 1.6;
    }

    .form-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 12px;
    }

    .form-type-card.regular .form-type-badge {
        background: var(--primary);
        color: #fff;
    }

    .form-type-card.spot .form-type-badge {
        background: var(--spot-color);
        color: #fff;
    }

    .registration-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        padding: 40px 32px;
        margin-bottom: 24px;
    }

    .form-section {
        margin-bottom: 32px;
    }

    .form-section:last-child {
        margin-bottom: 0;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0 0 20px 0;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title i {
        color: var(--primary);
    }

    .spot-mode .section-title {
        border-bottom-color: var(--spot-color);
    }

    .spot-mode .section-title i {
        color: var(--spot-color);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    @media (max-width: 600px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    .form-label {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .required-badge {
        background: var(--primary);
        color: white;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: 500;
    }

    .spot-mode .required-badge {
        background: var(--spot-color);
    }

    .optional-badge {
        background: #e5e7eb;
        color: #6b7280;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: 500;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s;
        background: var(--input-bg);
        color: var(--text-dark);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
    }

    .spot-mode .form-input:focus,
    .spot-mode .form-select:focus,
    .spot-mode .form-textarea:focus {
        border-color: var(--spot-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 6px;
    }

    .store-list {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .store-item {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
    }

    .store-item:last-child {
        border-bottom: none;
    }

    .store-item input {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .store-item input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .spot-mode .store-item input:focus {
        border-color: var(--spot-color);
    }

    .add-store-btn {
        width: 100%;
        padding: 12px;
        background: #f9fafb;
        border: 1px dashed var(--border);
        border-radius: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 12px;
    }

    .add-store-btn:hover {
        background: #f3f4f6;
        border-color: var(--primary);
        color: var(--primary);
    }

    .spot-mode .add-store-btn:hover {
        border-color: var(--spot-color);
        color: var(--spot-color);
    }

    .terms-section {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .terms-title {
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 16px;
    }

    .terms-content {
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.85rem;
        line-height: 1.8;
        color: var(--text-muted);
        padding: 16px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 16px;
    }

    .terms-content h4 {
        color: var(--text-dark);
        margin: 16px 0 8px 0;
        font-size: 0.9rem;
    }

    .terms-content h4:first-child {
        margin-top: 0;
    }

    .checkbox-label {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
        font-size: 0.95rem;
        color: var(--text-dark);
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-top: 2px;
        accent-color: var(--primary);
    }

    .spot-mode .checkbox-label input[type="checkbox"] {
        accent-color: var(--spot-color);
    }

    .submit-section {
        text-align: center;
        padding-top: 24px;
    }

    .submit-btn {
        width: 100%;
        max-width: 400px;
        padding: 16px 32px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .spot-mode .submit-btn {
        background: var(--spot-color);
    }

    .submit-btn:hover:not(:disabled) {
        background: var(--primary-600);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(244, 63, 94, 0.3);
    }

    .spot-mode .submit-btn:hover:not(:disabled) {
        background: var(--spot-600);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .success-message {
        display: none;
        text-align: center;
        padding: 60px 24px;
    }

    .success-message.show {
        display: block;
    }

    .success-icon {
        width: 80px;
        height: 80px;
        background: var(--success);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
    }

    .success-icon i {
        font-size: 40px;
        color: #fff;
    }

    .success-message h2 {
        font-size: 1.5rem;
        color: var(--text-dark);
        margin: 0 0 12px 0;
    }

    .success-message p {
        color: var(--text-muted);
        margin: 0;
    }

    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.9rem;
        display: none;
    }

    .error-message.show {
        display: block;
    }

    .provider-info {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-top: 24px;
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .provider-info strong {
        color: var(--text-dark);
    }

    /* Radio group for payment terms */
    .payment-options {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .payment-option {
        flex: 1;
        min-width: 120px;
    }

    .payment-option input[type="radio"] {
        display: none;
    }

    .payment-option label {
        display: block;
        padding: 12px 16px;
        background: #f9fafb;
        border: 2px solid var(--border);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .payment-option input[type="radio"]:checked+label {
        background: rgba(244, 63, 94, 0.1);
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
    }

    .spot-mode .payment-option input[type="radio"]:checked+label {
        background: rgba(59, 130, 246, 0.1);
        border-color: var(--spot-color);
        color: var(--spot-color);
    }

    .payment-option label:hover {
        border-color: var(--primary);
    }

    .spot-mode .payment-option label:hover {
        border-color: var(--spot-color);
    }

    /* Price info box for spot */
    .price-info-box {
        background: rgba(59, 130, 246, 0.08);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        padding: 16px;
        color: var(--spot-color);
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .price-info-box i {
        font-size: 1.5rem;
    }

    /* Back button */
    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        margin-bottom: 20px;
        background: none;
        border: none;
        padding: 0;
    }

    .back-btn:hover {
        color: var(--text-dark);
    }

    @media (max-width: 600px) {
        .registration-wrapper {
            padding: 24px 16px 60px;
        }

        .registration-card {
            padding: 24px 20px;
        }

        .registration-header h1 {
            font-size: 1.4rem;
        }
    }
</style>

<div class="registration-wrapper">
    <div class="registration-header">
        <img src="/images/logo_144x144.png" alt="ミセサポ">
        <h1 id="page-title">利用者登録 申込書</h1>
        <p id="page-subtitle">申込書の種類を選択してください</p>
    </div>

    <!-- Step 1: Form Type Selection -->
    <div id="type-selection-step">
        <div class="form-type-selection">
            <div class="form-type-card regular" onclick="selectFormType('regular')">
                <div class="icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <h3>利用者登録 申込書</h3>
                <p>継続的なサービス利用のための<br>通常契約の申込書です</p>
                <div class="form-type-badge">契約書</div>
            </div>
            <div class="form-type-card spot" onclick="selectFormType('spot')">
                <div class="icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h3>スポット利用者登録 申込書</h3>
                <p>単発・スポットサービス利用のための<br>簡易契約の申込書です</p>
                <div class="form-type-badge">簡易契約書</div>
            </div>
        </div>
    </div>

    <!-- Step 2: Registration Form -->
    <div id="registration-form-container" style="display: none;">
        <button type="button" class="back-btn" onclick="goBackToSelection()">
            <i class="fas fa-arrow-left"></i> 申込書の種類を選び直す
        </button>

        <div class="registration-card">
            <div id="error-message" class="error-message"></div>

            <form id="registration-form">
                <input type="hidden" id="form_type" name="form_type" value="regular">

                <!-- 基本情報 -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-building"></i> 基本情報</h3>

                    <div class="form-group">
                        <label class="form-label">
                            個人/法人名
                            <span class="required-badge">必須</span>
                        </label>
                        <input type="text" class="form-input" id="company_name" name="company_name" required
                            placeholder="例：株式会社○○ または 山田太郎">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            住所/本店住所
                            <span class="required-badge">必須</span>
                        </label>
                        <div class="form-row">
                            <input type="text" class="form-input" id="postal_code" name="postal_code"
                                placeholder="〒000-0000" style="max-width: 140px;">
                            <div></div>
                        </div>
                        <input type="text" class="form-input" id="address" name="address" required
                            placeholder="都道府県市区町村番地" style="margin-top: 8px;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            担当者名
                            <span class="required-badge">必須</span>
                        </label>
                        <input type="text" class="form-input" id="contact_name" name="contact_name" required
                            placeholder="例：山田 太郎">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                電話番号
                                <span class="required-badge">必須</span>
                            </label>
                            <input type="tel" class="form-input" id="phone" name="phone" required
                                placeholder="例：03-0000-0000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                メールアドレス
                                <span class="required-badge">必須</span>
                            </label>
                            <input type="email" class="form-input" id="email" name="email" required
                                placeholder="例：info@example.com">
                        </div>
                    </div>
                </div>

                <!-- サービス利用店舗 -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-store"></i> サービスを利用する店舗</h3>
                    <p class="form-hint" style="margin-top: -12px; margin-bottom: 16px;">複数ある場合は全てご記載ください</p>

                    <div class="store-list" id="store-list">
                        <div class="store-item">
                            <input type="text" name="store_name_1" placeholder="店舗名">
                            <input type="text" name="store_address_1" placeholder="住所">
                        </div>
                    </div>
                    <button type="button" class="add-store-btn" onclick="addStoreRow()">
                        <i class="fas fa-plus"></i> 店舗を追加
                    </button>
                </div>

                <!-- 料金（タイプによって表示切替） -->
                <div class="form-section" id="pricing-section-regular">
                    <h3 class="section-title"><i class="fas fa-yen-sign"></i> 料金</h3>
                    <p class="form-hint">料金表または見積書に定めるとおりとします。</p>
                </div>

                <div class="form-section" id="pricing-section-spot" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-yen-sign"></i> 料金</h3>
                    <div class="price-info-box">
                        <i class="fas fa-envelope"></i>
                        <span>見積書メール添付の金額のとおりとします。</span>
                    </div>
                </div>

                <!-- 支払方法 -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-credit-card"></i> お支払い方法</h3>
                    <p class="form-hint" style="margin-top: -12px; margin-bottom: 16px;">
                        施工完了翌日までに請求書を送付いたします。<br>
                        請求書の備考欄に記載の指定口座へ、下記いずれかの条件にてお支払いをお願いいたします。
                    </p>

                    <div class="payment-options">
                        <div class="payment-option">
                            <input type="radio" name="payment_terms" id="payment_15" value="15日締め/当月末払い" checked>
                            <label for="payment_15">15日締め/当月末払い</label>
                        </div>
                        <div class="payment-option">
                            <input type="radio" name="payment_terms" id="payment_30" value="30日締め/翌月15日払い">
                            <label for="payment_30">30日締め/翌月15日払い</label>
                        </div>
                    </div>
                </div>

                <!-- 特記事項 -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-comment-alt"></i> 特記事項</h3>
                    <textarea class="form-textarea" id="notes" name="notes"
                        placeholder="ご要望やご質問がございましたらご記入ください"></textarea>
                </div>

                <!-- 利用規約（通常契約用） -->
                <div class="terms-section" id="terms-regular">
                    <div class="terms-title">利用規約・契約内容</div>
                    <div class="terms-content">
                        <h4>■ 料金</h4>
                        <p>料金表または見積書に定めるとおりとします。</p>

                        <h4>■ 個別業務のキャンセル</h4>
                        <p>別途定めるとおりとします。</p>

                        <h4>■ 有効期間</h4>
                        <p>原則利用開始日から1年間（但し、有効期間満了の30日前までにいずれの当事者からも本契約を終了させる旨の通知がなされなかった場合、本契約は同一の条件でさらに1年間延長されるものとし、以降も同様とします）
                        </p>
                        <p>ミセサポのサービスにご満足いただけず、要望や不満などあれば最善を尽くしご対応させていただきますが、それでもご納得いただけない場合は有効期間内でも解約できるものとします。</p>

                        <h4>■ 退会予告期間</h4>
                        <p>90日前</p>

                        <h4>■ 特約事項</h4>
                        <p>店舗での設備に関するアラートやより良い店舗運営のために設備情報をミセサポプラットフォーム上に登録させていただきます。外部に公開するものではございませんので、ご安心ください。</p>
                    </div>

                    <label class="checkbox-label">
                        <input type="checkbox" id="agree_terms" name="agree_terms" required>
                        <span>上記の利用規約に同意し、本サービスの利用を申し込みます</span>
                    </label>
                </div>

                <!-- 利用規約（スポット契約用） -->
                <div class="terms-section" id="terms-spot" style="display: none;">
                    <div class="terms-title">利用規約・簡易契約内容</div>
                    <div class="terms-content">
                        <h4>■ 料金</h4>
                        <p>見積書メール添付の金額のとおりとします。</p>

                        <h4>■ 個別業務のキャンセル</h4>
                        <p>別途定めるとおりとします。</p>

                        <h4>■ 有効期間</h4>
                        <p>原則利用開始日から1年間（但し、有効期間満了の30日前までにいずれの当事者からも本契約を終了させる旨の通知がなされなかった場合、本契約は同一の条件でさらに1年間延長されるものとし、以降も同様とします）
                        </p>
                        <p>ミセサポのサービスにご満足いただけず、要望や不満などあれば最善を尽くしご対応させていただきますが、それでもご納得いただけない場合は有効期間内でも解約できるものとします。</p>

                        <h4>■ 特約事項</h4>
                        <p>店舗での設備に関するアラートやより良い店舗運営のために設備情報をミセサポプラットフォーム上に登録させていただきます。外部に公開するものではございませんので、ご安心ください。</p>
                    </div>

                    <label class="checkbox-label">
                        <input type="checkbox" id="agree_terms_spot" name="agree_terms_spot">
                        <span>上記の利用規約に同意し、本サービスの利用を申し込みます</span>
                    </label>
                </div>

                <!-- 送信ボタン -->
                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submit-btn">
                        <i class="fas fa-paper-plane"></i>
                        申込書を送信する
                    </button>
                </div>
            </form>
        </div>

        <div class="provider-info">
            <strong>株式会社ミセサポ</strong><br>
            代表取締役 正田 和輝<br>
            住所：東京都中央区日本橋茅場町1-8-1 7F<br>
            電話：070-3332-3939
        </div>
    </div>

    <!-- 完了メッセージ -->
    <div class="registration-card success-message" id="success-message">
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>
        <h2>申込書を送信しました</h2>
        <p>ご登録いただきありがとうございます。<br>担当者より追ってご連絡いたします。</p>
    </div>
</div>

<script>
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
    let storeCount = 1;
    let currentFormType = 'regular';

    function selectFormType(type) {
        currentFormType = type;
        document.getElementById('form_type').value = type;

        // Update UI
        document.querySelectorAll('.form-type-card').forEach(card => card.classList.remove('selected'));
        document.querySelector(`.form-type-card.${type}`).classList.add('selected');

        // Update page title
        const titleEl = document.getElementById('page-title');
        const subtitleEl = document.getElementById('page-subtitle');
        const formContainer = document.getElementById('registration-form-container');

        if (type === 'spot') {
            titleEl.textContent = 'スポット利用者登録 申込書';
            subtitleEl.textContent = '簡易契約書';
            formContainer.classList.add('spot-mode');
            document.getElementById('pricing-section-regular').style.display = 'none';
            document.getElementById('pricing-section-spot').style.display = 'block';
            document.getElementById('terms-regular').style.display = 'none';
            document.getElementById('terms-spot').style.display = 'block';
            document.getElementById('agree_terms').required = false;
            document.getElementById('agree_terms_spot').required = true;
        } else {
            titleEl.textContent = '利用者登録 申込書';
            subtitleEl.textContent = '契約書';
            formContainer.classList.remove('spot-mode');
            document.getElementById('pricing-section-regular').style.display = 'block';
            document.getElementById('pricing-section-spot').style.display = 'none';
            document.getElementById('terms-regular').style.display = 'block';
            document.getElementById('terms-spot').style.display = 'none';
            document.getElementById('agree_terms').required = true;
            document.getElementById('agree_terms_spot').required = false;
        }

        // Show form, hide selection
        document.getElementById('type-selection-step').style.display = 'none';
        formContainer.style.display = 'block';
    }

    function goBackToSelection() {
        document.getElementById('type-selection-step').style.display = 'block';
        document.getElementById('registration-form-container').style.display = 'none';
        document.getElementById('page-title').textContent = '利用者登録 申込書';
        document.getElementById('page-subtitle').textContent = '申込書の種類を選択してください';
        document.querySelectorAll('.form-type-card').forEach(card => card.classList.remove('selected'));
    }

    function addStoreRow() {
        storeCount++;
        const storeList = document.getElementById('store-list');
        const newRow = document.createElement('div');
        newRow.className = 'store-item';
        newRow.innerHTML = `
      <input type="text" name="store_name_${storeCount}" placeholder="店舗名">
      <input type="text" name="store_address_${storeCount}" placeholder="住所">
    `;
        storeList.appendChild(newRow);
    }

    document.getElementById('registration-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const errorEl = document.getElementById('error-message');
        const submitBtn = document.getElementById('submit-btn');

        // Validate agreement checkbox based on form type
        if (currentFormType === 'spot') {
            if (!document.getElementById('agree_terms_spot').checked) {
                errorEl.textContent = '利用規約に同意してください。';
                errorEl.classList.add('show');
                return;
            }
        } else {
            if (!document.getElementById('agree_terms').checked) {
                errorEl.textContent = '利用規約に同意してください。';
                errorEl.classList.add('show');
                return;
            }
        }

        errorEl.classList.remove('show');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送信中...';

        try {
            // フォームデータを収集
            const formData = new FormData(this);

            // 店舗情報を配列に変換
            const stores = [];
            for (let i = 1; i <= storeCount; i++) {
                const name = formData.get(`store_name_${i}`);
                const address = formData.get(`store_address_${i}`);
                if (name || address) {
                    stores.push({ name: name || '', address: address || '' });
                }
            }

            // URLからトークンを取得（メールリンクから来た場合）
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const customerId = urlParams.get('customer_id');

            const registrationData = {
                action: 'submit_registration',
                form_type: currentFormType,
                token: token,
                customer_id: customerId,
                company_name: formData.get('company_name'),
                postal_code: formData.get('postal_code'),
                address: formData.get('address'),
                contact_name: formData.get('contact_name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                stores: stores,
                payment_terms: formData.get('payment_terms'),
                notes: formData.get('notes'),
                agreed_at: new Date().toISOString()
            };

            const response = await fetch(API_BASE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(registrationData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || '送信に失敗しました');
            }

            // 成功時
            document.getElementById('registration-form-container').style.display = 'none';
            document.getElementById('success-message').classList.add('show');

        } catch (error) {
            console.error('Registration error:', error);
            errorEl.textContent = error.message || '送信中にエラーが発生しました。再度お試しください。';
            errorEl.classList.add('show');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 申込書を送信する';
        }
    });

    // URLパラメータから事前入力・タイプ自動選択
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);

        // フォームタイプが指定されている場合は自動選択
        const formType = urlParams.get('type');
        if (formType === 'spot' || formType === 'regular') {
            selectFormType(formType);
        }

        const prefilledFields = ['company_name', 'email', 'phone', 'contact_name'];
        prefilledFields.forEach(field => {
            const value = urlParams.get(field);
            const input = document.getElementById(field);
            if (value && input) {
                input.value = decodeURIComponent(value);
            }
        });
    });
</script>