<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>業務報告</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif; margin: 0; padding: 24px; background: #f4f7f6; color: #222; max-width: 720px; margin-left: auto; margin-right: auto; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .meta { font-size: 0.9rem; color: #555; margin-bottom: 24px; }
    section { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
    section h2 { font-size: 1rem; margin: 0 0 12px; color: #555; }
    dl { margin: 0; display: grid; gap: 8px 16px; grid-template-columns: auto 1fr; }
    dt { margin: 0; color: #555; }
    dd { margin: 0; white-space: pre-wrap; word-break: break-word; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .error { color: #c00; padding: 16px; background: #fee; border-radius: 8px; }
    ul { margin: 0; padding-left: 20px; }
    a { color: #06c; }
    pre { margin: 0; font-size: 0.85rem; white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div id="loading" class="loading">読み込み中...</div>
  <div id="content" style="display: none;"></div>
  <div id="error" class="error" style="display: none;"></div>

  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      var id = params.get('id');
      var loading = document.getElementById('loading');
      var content = document.getElementById('content');
      var errEl = document.getElementById('error');

      function showError(msg) {
        loading.style.display = 'none';
        content.style.display = 'none';
        errEl.textContent = msg;
        errEl.style.display = 'block';
      }

      function safeJson(s) {
        if (s == null || s === '') return {};
        if (typeof s === 'object') return s;
        try { return JSON.parse(s); } catch (_) { return {}; }
      }

      var TOUCH = { visit: '訪問', call: '電話', email: 'メール', other: 'その他' };
      function templateLabel(tid) {
        if (!tid) return '—';
        if (tid.indexOf('SALES') >= 0) return '営業';
        if (tid.indexOf('CLEANING') >= 0) return '清掃';
        return 'その他';
      }

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function render(report) {
        var desc = safeJson(report.description);
        var isDay = report.template_id === 'SALES_DAY_V1';
        var isCase = report.template_id === 'SALES_CASE_V1';
        var attachments = [];
        if (desc.attachments && Array.isArray(desc.attachments)) attachments = desc.attachments.filter(function(a) { return a && a.url; });

        var html = '<h1>業務報告（閲覧）</h1>';
        html += '<p class="meta">' + escapeHtml(templateLabel(report.template_id)) + ' · ' + escapeHtml(report.work_date || '—') + ' · ' + escapeHtml(report.state || '—') + '</p>';

        html += '<section><h2>基本情報</h2><dl>';
        html += '<dt>報告日</dt><dd>' + escapeHtml(report.work_date || '—') + '</dd>';
        html += '<dt>種別</dt><dd>' + escapeHtml(templateLabel(report.template_id)) + '</dd>';
        if (report.target_label) { html += '<dt>店舗・対象</dt><dd>' + escapeHtml(report.target_label) + '</dd>'; }
        if (report.work_minutes != null && report.work_minutes > 0) { html += '<dt>作業時間</dt><dd>' + escapeHtml(String(report.work_minutes)) + '分</dd>'; }
        html += '</dl></section>';

        if (isDay) {
          html += '<section><h2>日次サマリ</h2><dl>';
          if (desc.reporter_name) { html += '<dt>報告者</dt><dd>' + escapeHtml(desc.reporter_name) + '</dd>'; }
          if (desc.work_start_time || desc.work_end_time) { html += '<dt>勤務時間</dt><dd>' + escapeHtml((desc.work_start_time || '—') + ' ～ ' + (desc.work_end_time || '—')) + '</dd>'; }
          if (desc.summary) { html += '<dt>要約</dt><dd>' + escapeHtml(desc.summary) + '</dd>'; }
          if (desc.issues) { html += '<dt>課題</dt><dd>' + escapeHtml(desc.issues) + '</dd>'; }
          if (desc.top_priority) { html += '<dt>最優先</dt><dd>' + escapeHtml(desc.top_priority) + '</dd>'; }
          html += '</dl></section>';
        }

        if (isCase) {
          html += '<section><h2>案件内容</h2><dl>';
          if (desc.store_name) { html += '<dt>店舗名</dt><dd>' + escapeHtml(desc.store_name) + '</dd>'; }
          if (desc.touch_type) { html += '<dt>接触種別</dt><dd>' + escapeHtml(TOUCH[desc.touch_type] || desc.touch_type) + '</dd>'; }
          if (desc.summary) { html += '<dt>要約</dt><dd>' + escapeHtml(desc.summary) + '</dd>'; }
          if (desc.detail) { html += '<dt>詳細</dt><dd>' + escapeHtml(desc.detail) + '</dd>'; }
          var next = desc.next || {};
          if (next.due || next.title) { html += '<dt>次アクション</dt><dd>' + escapeHtml((next.due || '') + ' ' + (next.title || '')) + '</dd>'; }
          if (desc.pipeline_after) { html += '<dt>pipeline_after</dt><dd>' + escapeHtml(desc.pipeline_after) + '</dd>'; }
          html += '</dl></section>';
        }

        if (!isDay && !isCase && Object.keys(desc).length > 0) {
          html += '<section><h2>内容</h2><pre>' + escapeHtml(JSON.stringify(desc, null, 2)) + '</pre></section>';
        }

        if (attachments.length > 0) {
          html += '<section><h2>添付資料</h2><ul>';
          attachments.forEach(function(a) {
            html += '<li><a href="' + escapeHtml(a.url) + '" target="_blank" rel="noopener">' + escapeHtml(a.name || '添付') + '</a></li>';
          });
          html += '</ul></section>';
        }

        content.innerHTML = html;
        loading.style.display = 'none';
        content.style.display = 'block';
      }

      if (!id) {
        showError('URLに報告IDが含まれていません。');
        return;
      }

      var apiBase = '/api-wr';
      var url = apiBase + '/public/work-report/' + encodeURIComponent(id);

      fetch(url)
        .then(function(res) {
          if (!res.ok) throw new Error(res.status === 404 ? '報告が見つかりませんでした。' : '取得に失敗しました。');
          return res.json();
        })
        .then(function(data) {
          render(data);
        })
        .catch(function(e) {
          showError(e.message || '報告の読み込みに失敗しました。');
        });
    })();
  </script>
</body>
</html>
