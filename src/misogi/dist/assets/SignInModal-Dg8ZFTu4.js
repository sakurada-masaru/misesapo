import{r as p,j as a}from"./index-jsd-pEZ8.js";var x;const S=typeof window<"u"&&((x=window.location)==null?void 0:x.hostname)==="localhost"?"/api":"https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod";function j(){const e=typeof window<"u"&&window.CognitoConfig;return e&&e.userPoolId&&e.clientId?{UserPoolId:e.userPoolId,ClientId:e.clientId}:{UserPoolId:"ap-northeast-1_EDKElIGoC",ClientId:"25abe85ibm5hn6rrsokd5jssb5"}}function v(e){if(!e)return"ログイン中にエラーが発生しました。";const n=e.code||e.name,o=e.message||"";return n==="UserNotFoundException"?"ユーザーが見つかりません。":n==="NotAuthorizedException"?"メールアドレスまたはパスワードが間違っています。":n==="UserNotConfirmedException"?"アカウントが確認されていません。メールを確認してください。":n==="PasswordResetRequiredException"?"パスワードのリセットが必要です。":n==="InvalidParameterException"?o.includes("secret")||o.includes("Secret")?"Cognito アプリクライアントに「クライアントシークレット」が有効です。ブラウザログイン用にはシークレットなしのアプリクライアントが必要です。":o||"リクエストパラメータが不正です。":n==="InvalidLambdaResponseException"?"認証処理でエラーが発生しました。":o?`${n||"Error"}: ${o}`:"ログイン中にエラーが発生しました。"}async function C(e,n){const o=S.replace(/\/$/,""),l=Date.now();if(e){const c=await fetch(`${o}/workers?email=${encodeURIComponent(e)}&t=${l}`,{cache:"no-store"});if(c.ok){const i=await c.json(),s=(Array.isArray(i)?i:i.items||i.workers||[]).find(d=>d.email&&d.email.toLowerCase()===e.toLowerCase());if(s&&s.id)return s}}if(n){const c=await fetch(`${o}/workers?cognito_sub=${encodeURIComponent(n)}&t=${l}`,{cache:"no-store"});if(c.ok){const i=await c.json(),s=(Array.isArray(i)?i:i.items||i.workers||[]).find(d=>d.cognito_sub===n);if(s&&s.id)return s}}return null}function _(e,n){return new Promise(async o=>{const l=typeof window<"u"&&window.AmazonCognitoIdentity;if(!l){o({success:!1,message:"Cognito SDK が読み込まれていません。ページを再読み込みしてください。"});return}const c=j(),i=new l.CognitoUserPool(c),u=i.getCurrentUser();u&&u.signOut(),typeof window<"u"&&window.localStorage&&(window.localStorage.removeItem("cognito_id_token"),window.localStorage.removeItem("cognito_access_token"),window.localStorage.removeItem("cognito_refresh_token"),window.localStorage.removeItem("cognito_user"),window.localStorage.removeItem("misesapo_auth")),await new Promise(t=>setTimeout(t,100));const s=new l.AuthenticationDetails({Username:e,Password:n}),d={Username:e,Pool:i};new l.CognitoUser(d).authenticateUser(s,{onSuccess:async t=>{const r=t.getIdToken().getJwtToken(),g=t.getAccessToken().getJwtToken(),k=t.getRefreshToken().getToken(),f=t.getIdToken().payload,b=f.sub,h=f.email||e;let m=null;try{m=await C(h,b)}catch(I){console.error("[signInWithCognito] fetch user error:",I),o({success:!1,message:"ユーザー情報の取得に失敗しました。しばらく待ってから再度お試しください。"});return}if(!m||!m.id){o({success:!1,message:"ユーザー情報が見つかりません。管理者にお問い合わせください。"});return}const y={id:m.id,cognito_sub:b,email:m.email||h,name:m.name||h.split("@")[0],role:m.role||f["custom:role"]||"staff",department:m.department||f["custom:department"]||""};typeof window<"u"&&window.localStorage&&(window.localStorage.setItem("cognito_id_token",r),window.localStorage.setItem("cognito_access_token",g),window.localStorage.setItem("cognito_refresh_token",k),window.localStorage.setItem("cognito_user",JSON.stringify(y))),o({success:!0,user:y})},onFailure:t=>{console.error("[signInWithCognito] Cognito onFailure:",(t==null?void 0:t.code)||(t==null?void 0:t.name),t==null?void 0:t.message,t),o({success:!1,message:v(t)})}})})}function U({onClose:e,onSuccess:n}){const[o,l]=p.useState(""),[c,i]=p.useState(""),[u,s]=p.useState(""),[d,w]=p.useState(!1),t=async r=>{if(r.preventDefault(),s(""),!o.trim()||!c){s("メールアドレスとパスワードを入力してください。");return}w(!0);try{const g=await _(o.trim(),c);if(g.success){n==null||n(),e==null||e();return}s(g.message||"ログインに失敗しました。")}catch(g){s((g==null?void 0:g.message)||"ログイン中にエラーが発生しました。")}finally{w(!1)}};return a.jsx("div",{className:"sign-in-modal-overlay",role:"dialog","aria-modal":"true","aria-labelledby":"signin-modal-title",style:{position:"fixed",inset:0,zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.6)",padding:24},onClick:r=>r.target===r.currentTarget&&(e==null?void 0:e()),children:a.jsxs("div",{className:"sign-in-modal",style:{width:"100%",maxWidth:400,background:"var(--bg, #1a1a1a)",borderRadius:16,padding:28,boxShadow:"0 20px 60px rgba(0,0,0,0.4)",border:"1px solid rgba(255,255,255,0.08)"},onClick:r=>r.stopPropagation(),children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[a.jsx("h2",{id:"signin-modal-title",style:{margin:0,fontSize:"1.25rem",fontWeight:600,color:"var(--fg)"},children:"ログイン"}),a.jsx("button",{type:"button",onClick:e,"aria-label":"閉じる",style:{background:"none",border:"none",color:"var(--fg)",opacity:.7,cursor:"pointer",padding:4,fontSize:"1.25rem",lineHeight:1},children:"×"})]}),a.jsxs("form",{onSubmit:t,children:[a.jsxs("div",{style:{marginBottom:16},children:[a.jsx("label",{htmlFor:"signin-email",style:{display:"block",fontSize:"0.85rem",marginBottom:6,color:"var(--muted, #888)"},children:"メールアドレス"}),a.jsx("input",{id:"signin-email",type:"email",autoComplete:"email",value:o,onChange:r=>l(r.target.value),placeholder:"example@company.com",style:{width:"100%",padding:"12px 14px",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,color:"var(--fg)",fontSize:"0.95rem",boxSizing:"border-box"}})]}),a.jsxs("div",{style:{marginBottom:20},children:[a.jsx("label",{htmlFor:"signin-password",style:{display:"block",fontSize:"0.85rem",marginBottom:6,color:"var(--muted, #888)"},children:"パスワード"}),a.jsx("input",{id:"signin-password",type:"password",autoComplete:"current-password",value:c,onChange:r=>i(r.target.value),placeholder:"••••••••",style:{width:"100%",padding:"12px 14px",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,color:"var(--fg)",fontSize:"0.95rem",boxSizing:"border-box"}})]}),u&&a.jsx("p",{role:"alert",style:{marginBottom:16,fontSize:"0.85rem",color:"var(--job-sales)",minHeight:20},children:u}),a.jsx("button",{type:"submit",disabled:d,style:{width:"100%",padding:14,background:"var(--job-sales)",color:"#fff",border:"none",borderRadius:10,fontSize:"1rem",fontWeight:600,cursor:d?"not-allowed":"pointer",opacity:d?.8:1},children:d?"ログイン中...":"ログイン"})]})]})})}export{U as default};
