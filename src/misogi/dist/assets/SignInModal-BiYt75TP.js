import{r as y,j as s}from"./index-DYmPaCVn.js";function I(){if(typeof window>"u")return!1;const e=String(window.location.hostname||"").toLowerCase();return e==="localhost"||e==="127.0.0.1"}const _=I()?"/api-jinzai":"https://ho3cd7ibtl.execute-api.ap-northeast-1.amazonaws.com/prod";function j(){const e=typeof window<"u"&&window.CognitoConfig;return e&&e.userPoolId&&e.clientId?{UserPoolId:e.userPoolId,ClientId:e.clientId}:{UserPoolId:"ap-northeast-1_EDKElIGoC",ClientId:"25abe85ibm5hn6rrsokd5jssb5"}}function z(e){if(!e)return"ログイン中にエラーが発生しました。";const o=e.code||e.name,t=e.message||"";return o==="UserNotFoundException"?"ユーザーが見つかりません。":o==="NotAuthorizedException"?"メールアドレスまたはパスワードが間違っています。":o==="UserNotConfirmedException"?"アカウントが確認されていません。メールを確認してください。":o==="PasswordResetRequiredException"?"パスワードのリセットが必要です。":o==="InvalidParameterException"?t.includes("secret")||t.includes("Secret")?"Cognito アプリクライアントに「クライアントシークレット」が有効です。ブラウザログイン用にはシークレットなしのアプリクライアントが必要です。":t||"リクエストパラメータが不正です。":o==="InvalidLambdaResponseException"?"認証処理でエラーが発生しました。":t?`${o||"Error"}: ${t}`:"ログイン中にエラーが発生しました。"}function b(e){return Array.isArray(e)?e:e==null?[]:[e]}function v(e){const o=b(e==null?void 0:e.yakuwari).map(l=>String(l||"").trim().toLowerCase()).filter(Boolean),t=new Set(o);if(t.has("admin"))return"admin";if(t.has("sales"))return"sales";if(t.has("dev")||t.has("developer")||t.has("engineering"))return"dev";if(t.has("office")||t.has("leader"))return"office";if(t.has("cleaning")||t.has("staff"))return"cleaning";const d=b(e==null?void 0:e.shokushu).map(l=>String(l||"").trim().toLowerCase()).filter(Boolean),i=new Set(d);return i.has("keiei")?"admin":i.has("eigyo")?"sales":i.has("engineer")||i.has("design")?"dev":i.has("seisou")||i.has("maintenance")?"cleaning":(i.has("operator")||i.has("jimu")||i.has("keiri")||i.has("jinji"),"office")}function C(e){const o=String(e||"").trim().toLowerCase();return o==="admin"?"ADMIN":o==="sales"?"SALES":o==="dev"||o==="developer"?"ENGINEERING":o==="cleaning"||o==="staff"?"CLEANING":"OFFICE"}async function A(e,o,t){const d=_.replace(/\/$/,""),i={Authorization:`Bearer ${String(e).trim()}`},l=await fetch(`${d}/jinzai?limit=1000&jotai=yuko`,{cache:"no-store",headers:i});if(!l.ok)throw new Error(`JINZAI_LIST_HTTP_${l.status}`);const m=await l.json(),f=Array.isArray(m)?m:m.items||[],u=String(o||"").trim().toLowerCase(),a=f.find(c=>{const h=String((c==null?void 0:c.email)||"").trim().toLowerCase();return!!(t&&(c!=null&&c.cognito_sub)&&String(c.cognito_sub)===String(t)||u&&h&&h===u)});if(!a||!a.jinzai_id)return null;let n=[];try{const c=await fetch(`${d}/jinzai/busho?limit=1000&jotai=yuko`,{cache:"no-store",headers:i});if(c.ok){const h=await c.json(),S=Array.isArray(h)?h:h.items||[],w=new Map(S.map(p=>[String(p.busho_id||""),p.name||""]));n=b(a.busho_ids).map(p=>w.get(String(p))).filter(Boolean)}}catch{n=[]}const r=v(a),g=C(r),k=a.name||(u?u.split("@")[0]:"user");return{id:a.jinzai_id,jinzai_id:a.jinzai_id,worker_id:a.jinzai_id,sagyouin_id:a.jinzai_id,cognito_sub:t||a.cognito_sub||"",email:a.email||o||"",name:k,role:r,roles:[r],dept:g,department:g,busho_ids:b(a.busho_ids),busho_names:n,yakuwari:b(a.yakuwari),shokushu:b(a.shokushu),koyou_kubun:a.koyou_kubun||""}}function E(e,o){return new Promise(async t=>{const d=typeof window<"u"&&window.AmazonCognitoIdentity;if(!d){t({success:!1,message:"Cognito SDK が読み込まれていません。ページを再読み込みしてください。"});return}const i=j(),l=new d.CognitoUserPool(i),m=l.getCurrentUser();m&&m.signOut(),typeof window<"u"&&window.localStorage&&(window.localStorage.removeItem("cognito_id_token"),window.localStorage.removeItem("cognito_access_token"),window.localStorage.removeItem("cognito_refresh_token"),window.localStorage.removeItem("cognito_user"),window.localStorage.removeItem("misesapo_auth")),await new Promise(n=>setTimeout(n,100));const f=new d.AuthenticationDetails({Username:e,Password:o}),u={Username:e,Pool:l};new d.CognitoUser(u).authenticateUser(f,{onSuccess:async n=>{const r=n.getIdToken().getJwtToken(),g=n.getAccessToken().getJwtToken(),k=n.getRefreshToken().getToken(),c=n.getIdToken().payload,h=c.sub,S=c.email||e;let w=null;try{w=await A(r,S,h)}catch(x){console.error("[signInWithCognito] fetch user error:",x),t({success:!1,message:"人材情報（jinzai）の取得に失敗しました。しばらく待ってから再度お試しください。"});return}if(!w||!w.jinzai_id){t({success:!1,message:"人材情報（jinzai）が見つかりません。管理者にお問い合わせください。"});return}const p=w;typeof window<"u"&&window.localStorage&&(window.localStorage.setItem("cognito_id_token",r),window.localStorage.setItem("cognito_access_token",g),window.localStorage.setItem("cognito_refresh_token",k),window.localStorage.setItem("cognito_user",JSON.stringify(p))),t({success:!0,user:p})},onFailure:n=>{console.error("[signInWithCognito] Cognito onFailure:",(n==null?void 0:n.code)||(n==null?void 0:n.name),n==null?void 0:n.message,n),t({success:!1,message:z(n)})}})})}function T({onClose:e,onSuccess:o}){const[t,d]=y.useState(""),[i,l]=y.useState(""),[m,f]=y.useState(""),[u,a]=y.useState(!1),n=async r=>{if(r.preventDefault(),f(""),!t.trim()||!i){f("メールアドレスとパスワードを入力してください。");return}a(!0);try{const g=await E(t.trim(),i);if(g.success){o==null||o(),e==null||e();return}f(g.message||"ログインに失敗しました。")}catch(g){f((g==null?void 0:g.message)||"ログイン中にエラーが発生しました。")}finally{a(!1)}};return s.jsx("div",{className:"sign-in-modal-overlay",role:"dialog","aria-modal":"true","aria-labelledby":"signin-modal-title",style:{position:"fixed",inset:0,zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.6)",padding:24},onClick:r=>r.target===r.currentTarget&&(e==null?void 0:e()),children:s.jsxs("div",{className:"sign-in-modal",style:{width:"100%",maxWidth:400,background:"var(--bg, #1a1a1a)",borderRadius:16,padding:28,boxShadow:"0 20px 60px rgba(0,0,0,0.4)",border:"1px solid rgba(255,255,255,0.08)"},onClick:r=>r.stopPropagation(),children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[s.jsx("h2",{id:"signin-modal-title",style:{margin:0,fontSize:"1.25rem",fontWeight:600,color:"var(--fg)"},children:"ログイン"}),s.jsx("button",{type:"button",onClick:e,"aria-label":"閉じる",style:{background:"none",border:"none",color:"var(--fg)",opacity:.7,cursor:"pointer",padding:4,fontSize:"1.25rem",lineHeight:1},children:"×"})]}),s.jsxs("form",{onSubmit:n,children:[s.jsxs("div",{style:{marginBottom:16},children:[s.jsx("label",{htmlFor:"signin-email",style:{display:"block",fontSize:"0.85rem",marginBottom:6,color:"var(--muted, #888)"},children:"メールアドレス"}),s.jsx("input",{id:"signin-email",type:"email",autoComplete:"email",value:t,onChange:r=>d(r.target.value),placeholder:"example@company.com",style:{width:"100%",padding:"12px 14px",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,color:"var(--fg)",fontSize:"0.95rem",boxSizing:"border-box"}})]}),s.jsxs("div",{style:{marginBottom:20},children:[s.jsx("label",{htmlFor:"signin-password",style:{display:"block",fontSize:"0.85rem",marginBottom:6,color:"var(--muted, #888)"},children:"パスワード"}),s.jsx("input",{id:"signin-password",type:"password",autoComplete:"current-password",value:i,onChange:r=>l(r.target.value),placeholder:"••••••••",style:{width:"100%",padding:"12px 14px",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,color:"var(--fg)",fontSize:"0.95rem",boxSizing:"border-box"}})]}),m&&s.jsx("p",{role:"alert",style:{marginBottom:16,fontSize:"0.85rem",color:"var(--job-sales)",minHeight:20},children:m}),s.jsx("button",{type:"submit",disabled:u,style:{width:"100%",padding:14,background:"var(--job-sales)",color:"#fff",border:"none",borderRadius:10,fontSize:"1rem",fontWeight:600,cursor:u?"not-allowed":"pointer",opacity:u?.8:1},children:u?"ログイン中...":"ログイン"})]})]})})}export{T as default};
